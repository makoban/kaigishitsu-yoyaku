<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示（グーグルカレンダー連携）</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        #auth_section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9f5ff;
            border: 1px solid #cce5ff;
            border-radius: 8px;
            display: none; /* 初期は非表示 */
        }
        #authorize_button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4285f4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #authorize_button:hover {
            background-color: #357ae8;
        }
        #authorize_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #container {
            display: flex;
            gap: 20px;
            margin-top: 0px;
        }
        .panel {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel ul {
            list-style-type: none;
            padding: 0;
        }
        .panel li {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .panel li:last-child {
            border-bottom: none;
        }
        .select-button {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .select-button:hover {
            background-color: #218838;
        }
        .action-button {
            padding: 8px 15px;
            font-size: 16px;
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 15px;
        }
        .event-item {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .event-time {
            font-weight: bold;
            color: #0056b3;
            margin-right: 10px;
        }
        .event-summary {
            color: #333;
        }
        .no-events {
            font-style: italic;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>会議室予約表示</h1>

    <div id="auth_section">
        <p id="auth_status" style="color: blue;">操作を行うにはGoogleアカウントで認証してください。</p>
        <button id="authorize_button">Googleアカウントで認証</button>
        <p style="font-size: 0.9em; color: #555; margin-top: 10px;">
            ※カレンダーの切り替え、緊急会議、削除機能を利用する際に認証が必要です。
        </p>
        <div id="calendar_selection_panel" style="margin-top: 20px; display: none;">
            <h2>表示・操作するカレンダーを選択</h2>
            <ul id="writable_calendar_list">
                <li>カレンダーを読み込み中...</li>
            </ul>
        </div>
    </div>

    <div id="container">
        <div id="event_list_container" class="panel" style="flex: auto;">
            <h2>会議室の予定</h2>
            <p id="selected_calendar_info">現在のカレンダー: <span id="display_calendar_summary">初期設定カレンダー</span> (<span id="display_calendar_id_text"></span>)</p>
            <ul id="event_list">
                <li>イベントを読み込み中...</li>
            </ul>
            <div style="margin-top: 20px;">
                <button id="add_event_button" class="action-button">緊急会議 (30分)</button>
                <button id="delete_event_button" class="action-button">最新の予定を削除</button>
                <button id="refresh_button" class="action-button">更新</button>
            </div>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // ★★★ ここをあなたの情報に置き換えてください ★★★
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';             // 例: AIzaSyB_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        // 初期表示用の公開カレンダーID。サイネージ設置初期やトラブルチェック用。
        const INITIAL_PUBLIC_CALENDAR_ID = 'kaigishitsu20000101@gmail.com'; // 例: test_room_id@group.calendar.google.com
                                                                        // または一般的なカレンダーID (公開設定されているもの)
        // 書き込み操作のために必要となるOAuthクライアントID
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; // 例: 123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
        // ★★★ ここまで ★★★

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        // 閲覧時は不要。書き込み操作時に必要となるスコープ
        const WRITE_SCOPES = 'https://www.googleapis.com/auth/calendar.events'; // イベントの読み書き権限

        const LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY = 'activeCalendarId';
        const LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY = 'activeCalendarSummary';

        let tokenClient; // Google Identity Services (GIS) のトークンクライアント (書き込み操作用)
        let isAuthorizedForWrite = false; // 書き込み権限が認証済みかどうかのフラグ
        let currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; // 現在表示・操作しているカレンダーID
        let currentCalendarSummary = "初期設定カレンダー"; // 現在表示・操作しているカレンダーのサマリー

        // HTMLコンテンツの読み込みが完了したら初期化処理を開始
        document.addEventListener('DOMContentLoaded', () => {
            // 現在の表示カレンダー情報を更新
            document.getElementById('display_calendar_id_text').textContent = currentCalendarId;
            document.getElementById('display_calendar_summary').textContent = currentCalendarSummary;
            
            // UI上のボタンにイベントリスナーを設定
            document.getElementById('add_event_button').onclick = handleActionTrigger;
            document.getElementById('delete_event_button').onclick = handleActionTrigger;
            document.getElementById('refresh_button').onclick = listEvents;

            // gapiクライアントライブラリのロードと初期化（APIキーのみ）
            gapi.load('client', initGapiClientForRead);
        });

        // 閲覧（読み込み）専用のgapiクライアント初期化
        function initGapiClientForRead() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('✅ gapi client initialized for read-only access (API Key only).');
                
                // localStorageに保存されたアクティブカレンダーIDがあればそれを優先
                const savedActiveId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY);
                const savedActiveSummary = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY);

                if (savedActiveId && savedActiveSummary) {
                    currentCalendarId = savedActiveId;
                    currentCalendarSummary = savedActiveSummary;
                    console.log(`ℹ️ localStorageからアクティブカレンダーを読み込みました: ${currentCalendarSummary} (${currentCalendarId})`);
                } else {
                    console.log(`ℹ️ localStorageにアクティブカレンダーが見つかりませんでした。初期設定カレンダー (${INITIAL_PUBLIC_CALENDAR_ID}) を使用します。`);
                    // 初回表示時のサマリーを適切に設定する（必要であればAPIで取得することも可能）
                    // 現状は'初期設定カレンダー'という固定文字列を使用
                }
                updateDisplayedCalendarInfo(); // 表示カレンダー情報を更新

                listEvents(); // 現在のカレンダーIDでイベントを自動表示

                // 書き込み操作のためにOAuthクライアントを初期化（ただし認証は保留）
                initGisClientForWrite();

            }).catch(err => {
                console.error('❌ gapiクライアントの初期化エラー（読み込み用）:', err);
                displayError('イベント表示の初期化に失敗しました。APIキーまたはネットワーク接続を確認してください。');
            });
        }

        // 書き込み操作のためのGISクライアント初期化
        function initGisClientForWrite() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: WRITE_SCOPES,
                callback: (tokenResponse) => {
                    console.log('--- tokenClient callback executed for write scope ---');
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        isAuthorizedForWrite = true;
                        document.getElementById('auth_status').textContent = '操作権限が認証されました。';
                        document.getElementById('auth_status').style.color = 'green';
                        document.getElementById('authorize_button').style.display = 'none'; // 認証後ボタンを非表示に
                        document.getElementById('calendar_selection_panel').style.display = 'block'; // カレンダー選択パネルを表示
                        console.log('✅ 書き込み権限のためのアクセストークンを取得しました。');
                        listWritableCalendars(); // 認証されたアカウントの書き込み可能カレンダーを表示
                    } else {
                        isAuthorizedForWrite = false;
                        document.getElementById('auth_status').textContent = '操作権限の認証に失敗しました。';
                        document.getElementById('auth_status').style.color = 'red';
                        document.getElementById('authorize_button').style.display = 'block'; // 失敗したらボタンを表示
                        document.getElementById('calendar_selection_panel').style.display = 'none'; // 認証失敗時は隠す
                        console.error('❌ 書き込み権限のためのアクセストークン取得に失敗しました。', tokenResponse);
                    }
                },
                error_callback: (error) => {
                    isAuthorizedForWrite = false;
                    document.getElementById('auth_status').textContent = '認証エラーが発生しました。';
                    document.getElementById('auth_status').style.color = 'red';
                    document.getElementById('authorize_button').style.display = 'block'; // エラー時はボタンを表示
                    document.getElementById('calendar_selection_panel').style.display = 'none'; // 認証エラー時は隠す
                    console.error('❌ GISトークンクライアントエラー（書き込み用）:', error);
                }
            });
            // 認証ボタンのイベントリスナーはinitGisClientForWrite内で設定
            document.getElementById('authorize_button').onclick = () => {
                console.log('--- Googleアカウントで認証ボタンがクリックされました（操作用）。---');
                tokenClient.requestAccessToken({ prompt: 'consent' }); // 初回は同意を求める
            };
        }

        // 操作ボタン（追加・削除）がクリックされた際の共通ハンドラ
        function handleActionTrigger(event) {
            // まず認証セクションを表示する
            document.getElementById('auth_section').style.display = 'block';

            if (!isAuthorizedForWrite) {
                document.getElementById('auth_status').textContent = '操作を行うにはGoogleアカウントで認証してください。';
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block'; // 認証ボタンを表示
                document.getElementById('calendar_selection_panel').style.display = 'none'; // カレンダー選択パネルは隠す
                console.log('🚨 操作トリガー: 書き込み権限がありません。認証を促します。');
                return; // 認証が済むまで操作は実行しない
            }

            // 認証済みであれば、どのボタンが押されたかに応じて処理を分岐
            if (event.target.id === 'add_event_button') {
                handleAddEvent();
            } else if (event.target.id === 'delete_event_button') {
                handleDeleteEvent();
            }
        }

        // 認証されたアカウントの書き込み可能なカレンダーリストを表示
        async function listWritableCalendars() {
            const writableCalendarListUl = document.getElementById('writable_calendar_list');
            writableCalendarListUl.innerHTML = '<li>カレンダーを読み込み中...</li>';
            displayError('');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;
                // オーナーまたは書き込み権限のあるカレンダーをフィルタリング
                const writableCalendars = allCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );

                if (writableCalendars && writableCalendars.length > 0) {
                    writableCalendarListUl.innerHTML = ''; // クリア
                    writableCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${calendar.summary}</span>
                            <button class="select-button" 
                                data-calendar-id="${calendar.id}" 
                                data-calendar-summary="${calendar.summary}">表示・操作</button>
                        `;
                        writableCalendarListUl.appendChild(li);
                    });
                    console.log('✅ 書き込み可能なカレンダーリストを正常に表示しました:', writableCalendars);

                    // 各「表示・操作」ボタンにイベントリスナーを追加
                    document.querySelectorAll('#writable_calendar_list .select-button').forEach(button => {
                        button.onclick = (event) => {
                            const newActiveId = event.target.dataset.calendarId;
                            const newActiveSummary = event.target.dataset.dataset.calendarSummary;
                            
                            // アクティブカレンダーをlocalStorageに保存
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, newActiveId);
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, newActiveSummary);

                            currentCalendarId = newActiveId;
                            currentCalendarSummary = newActiveSummary;
                            updateDisplayedCalendarInfo(); // 表示カレンダー情報を更新
                            console.log('✅ アクティブカレンダーが選択・保存されました:', currentCalendarSummary, currentCalendarId);
                            listEvents(); // 新しいカレンダーでイベントリストを再表示
                            // 認証セクションを隠す（必要であれば）
                            document.getElementById('auth_section').style.display = 'none';
                        };
                    });
                } else {
                    writableCalendarListUl.innerHTML = '<li>書き込み可能なカレンダーが見つかりませんでした。</li>';
                    console.log('ℹ️ 書き込み可能なカレンダーが見つかりませんでした。');
                }
            } catch (err) {
                console.error('❌ 書き込み可能カレンダーリストの取得エラー:', err.result ? err.result.error : err);
                displayError(`カレンダーリストの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        // 現在表示しているカレンダー情報をUIに反映する関数
        function updateDisplayedCalendarInfo() {
            document.getElementById('display_calendar_id_text').textContent = currentCalendarId;
            document.getElementById('display_calendar_summary').textContent = currentCalendarSummary;
        }

        async function listEvents() {
            const eventListUl = document.getElementById('event_list');
            eventListUl.innerHTML = ''; // 既存のイベントリストをクリア
            displayError(''); // エラーメッセージをクリア

            // 現在時刻を基準に、前2時間と後12時間の期間を設定
            const now = new Date();
            const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString(); // 2時間前
            const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString(); // 12時間後

            console.log(`イベント取得を試みます。カレンダーID: ${currentCalendarId}, 期間: ${timeMin} から ${timeMax}`);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId, // 現在選択されているカレンダーIDを使用
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 20
                });

                const events = response.result.items;

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = event.start.dateTime || event.start.date;
                        const end = event.end.dateTime || event.end.date;

                        // 開始日時と終了日時をフォーマット
                        const startDate = new Date(start).toLocaleDateString('ja-JP');
                        const startTime = new Date(start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = new Date(end).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        // 全日イベントの場合の表示調整
                        if (event.start.date && !event.start.dateTime) { // 全日イベントの場合
                             li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} (終日)</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        } else {
                            li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        }
                        eventListUl.appendChild(li);
                    });
                    console.log(`✅ イベントを正常に表示しました (${currentCalendarId}):`, events);
                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = '指定された期間にイベントが見つかりませんでした。';
                    eventListUl.appendChild(li);
                    console.log(`ℹ️ イベントが見つかりませんでした (${currentCalendarId})。`);
                }
            } catch (err) {
                console.error(`❌ イベントの取得エラー (${currentCalendarId}):`, err.result ? err.result.error : err);
                displayError(`イベントの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                const li = document.createElement('li');
                li.className = 'error-message';
                li.textContent = 'イベントの読み込みに失敗しました。';
                eventListUl.appendChild(li);
            }
        }

        // イベント追加のハンドラ (認証が必要)
        async function handleAddEvent() {
            // handleActionTriggerで認証済みであることを確認済み
            console.log('✅ イベントを追加します。');
            const now = new Date();
            const eventEndTime = new Date(now.getTime() + (30 * 60 * 1000)); // 30分後

            const event = {
                'summary': '緊急会議 (30分)',
                'location': '会議室', // 必要に応じて具体的な場所を設定
                'description': '緊急の会議です。',
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': eventEndTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': true
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': currentCalendarId, // 現在のアクティブカレンダーIDにイベントを追加
                    'resource': event
                });
                console.log('✅ イベントが追加されました:', response.result);
                alert('緊急会議が30分間予約されました！');
                listEvents(); // 追加後、イベントリストを再読み込み
            } catch (err) {
                console.error('❌ イベント追加エラー:', err.result ? err.result.error : err);
                alert(`イベントの追加に失敗しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        // 最新のイベント削除のハンドラ (認証が必要)
        async function handleDeleteEvent() {
            // handleActionTriggerで認証済みであることを確認済み
            console.log('✅ 最新のイベントを削除します。');
            try {
                // まず現在の期間のイベントリストを取得
                const now = new Date();
                const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString();
                const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString();

                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId, // 現在のアクティブカレンダーIDから取得
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 1 // 最新の1件のみ取得
                });

                const events = response.result.items;

                if (events && events.length > 0) {
                    const eventToDelete = events[0]; // 最新のイベント
                    console.log('削除するイベント:', eventToDelete);
                    if (confirm(`「${eventToDelete.summary || 'タイトルなし'}」を削除してもよろしいですか？`)) {
                        await gapi.client.calendar.events.delete({
                            'calendarId': currentCalendarId, // 現在のアクティブカレンダーIDから削除
                            'eventId': eventToDelete.id
                        });
                        console.log('✅ イベントが削除されました。');
                        alert('イベントが削除されました。');
                        listEvents(); // 削除後、イベントリストを再読み込み
                    }
                } else {
                    alert('指定された期間に削除できるイベントが見つかりませんでした。');
                }
            } catch (err) {
                console.error('❌ イベント削除エラー:', err.result ? err.result.error : err);
                alert(`イベントの削除に失敗しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }


        // エラーメッセージを表示するヘルパー関数
        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `エラー: ${msg}` : '';
            if (msg) console.error("表示エラー:", msg);
        }
    </script>
</body>
</html>
