<!DOCTYPE html>
<html>
<head>
    <title>ä¼šè­°å®¤äºˆç´„è¡¨ç¤º</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&family=Mochiy+Pop+One&family=Rampart+One&family=Roboto:ital,wght@0,100..900;1,100..900&family=Shippori+Antique+B1&family=Zen+Antique&family=Zen+Old+Mincho&display=swap" rel="stylesheet">
    <style>
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ (ãƒãƒƒãƒ—/Pop) - æ˜ã‚‹ããƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè‰²åˆã„ */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #28a745; /* Green */
            --accent-color: #6c757d; /* Gray */
            --text-color: #333;
            --light-text-color: #555;
            --background-color: #e8f5e9; /* Light Mint */
            --panel-bg-color: #ffffff;
            --border-color: #c8e6c9;
            --error-color: #dc3545;
            --delete-button-color: #dc3545;
            --highlight-color: #ffe082; /* Amber */
            --announcement-bg-color: #ffc107; /* Orange */
            --announcement-text-color: #333;
            --available-color: #a5d6a7; /* Light Green */
            --pre-announcement-bg-color: #add8e6; /* Light Blue for pre-announcement */
            --pre-announcement-text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            --base-font-size: 16px; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
            --base-font-family: 'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif; /* æ–°è¦: åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ */
        }

        /* ã‚·ãƒƒã‚¯ãƒ†ãƒ¼ãƒ */
        body.theme-chic {
            --primary-color: #5d4037; /* Dark Brown */
            --secondary-color: #bcaaa4; /* Light Brown */
            --accent-color: #8d6e63; /* Medium Brown */
            --text-color: #3e2723; /* Very Dark Brown */
            --light-text-color: #5d4037;
            --background-color: #f5f5f5; /* Off-White */
            --panel-bg-color: #efebe9; /* Slightly darker Off-White */
            --border-color: #d7ccc8;
            --error-color: #c62828;
            --delete-button-color: #c62828;
            --highlight-color: #ffecb3; /* Creamy Yellow */
            --announcement-bg-color: #ffab40; /* Amber */
            --announcement-text-color: #333;
            --available-color: #a1887f; /* Muted Green-Brown */
            --pre-announcement-bg-color: #8d6e63; /* Medium Brown */
            --pre-announcement-text-color: white;
            --border-radius: 4px; /* ã‚·ãƒ£ãƒ¼ãƒ—ãªè§’ */
            --box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        /* ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ (è–„ã„ãƒ–ãƒ«ãƒ¼åŸºèª¿) */
        body.theme-stylish {
            --primary-color: #007BFF; /* Bright Blue */
            --secondary-color: #17A2B8; /* Teal Blue */
            --accent-color: #6C757D; /* Gray */
            --text-color: #343A40; /* Darker text color */
            --light-text-color: #6C757D; /* Lighter text color */
            --background-color: #E9F5FF; /* Very Light Blue */
            --panel-bg-color: #FFFFFF; /* White for panels */
            --border-color: #C5E1FF; /* Light Blue border */
            --error-color: #DC3545; /* Red for errors */
            --delete-button-color: #DC3545; /* Red for delete buttons */
            --highlight-color: #DBEDFF; /* Light Cyan for current event highlight */
            --announcement-bg-color: #007BFF; /* Primary blue for announcement */
            --announcement-text-color: white; /* White for announcement text */
            --available-color: #85CEFF; /* Light blue for "Available" */
            --pre-announcement-bg-color: #64B5F6; /* Slightly darker blue for pre-announcement */
            --pre-announcement-text-color: white; /* White for pre-announcement text */
            --border-radius: 8px; /* æ¨™æº–çš„ãªè§’ */
            --box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }


        body {
            font-family: var(--base-font-family); /* å¤‰æ›´: CSSå¤‰æ•°ã‚’ä½¿ç”¨ */
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center; /* ä¸­å¤®æƒãˆ */
            min-height: 100vh;
            box-sizing: border-box;
            font-size: var(--base-font-size); /* CSSå¤‰æ•°ã‚’ä½¿ç”¨ */
            transition: background-color 0.3s ease, color 0.3s ease, font-size 0.3s ease, font-family 0.3s ease; /* transitionã«è¿½åŠ  */
        }

        h1 {
            font-size: 2.5em; /* ç›¸å¯¾å˜ä½ */
        }
        h2 {
            font-size: 2em; /* ç›¸å¯¾å˜ä½ */
        }
        h3 {
            font-size: 1.5em; /* ç›¸å¯¾å˜ä½ */
        }
        h4 {
            font-size: 1.2em; /* ç›¸å¯¾å˜ä½ */
        }
        
        /* h1, h2, h3, h4 ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ®‹ã—ã¤ã¤ã€emå˜ä½ã§ç›¸å¯¾çš„ã«å¤‰æ›´ */
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px; /* ä½™ç™½ã‚’å¤§ãã‚ã« */
            font-weight: 500;
            transition: color 0.3s ease; /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }
        /* Header */
        header {
            width: 100%; /* è¦ªè¦ç´ ã®å¹…ã«åˆã‚ã›ã‚‹ */
            max-width: 900px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* ä½™ç™½ã‚’å¤§ãã‚ã« */
            position: relative; /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åé…ç½®ã®ãŸã‚ */
            padding: 0 20px; /* å·¦å³ã®ä½™ç™½ */
            box-sizing: border-box; /* paddingã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        #display_calendar_summary_top { /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åï¼ˆä¸Šéƒ¨ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            position: absolute;
            top: 25px; /* H1ã¨è¨­å®šãƒœã‚¿ãƒ³ã®é–“ã«é…ç½® */
            left: 20px; /* H1ã®å·¦ç«¯ã«åˆã‚ã›ã‚‹ */
            font-size: 1.6em; /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚µãƒãƒªãƒ¼ã‚’èª¿æ•´ */
            font-weight: 500;
            color: var(--light-text-color);
            transform: translateY(50px); /* H1ã®ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã‘ã‚‹ */
        }


        /* Top Bar for Date/Time and Announcement */
        #top_bar {
            width: 100%;
            max-width: 900px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
            background-color: var(--panel-bg-color);
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            box-shadow: var(--box-shadow); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            margin-bottom: 30px; /* ä½™ç™½ã‚’å¤§ãã */
            padding: 25px 30px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤§ãã */
            display: flex;
            flex-direction: column; /* ç¸¦ä¸¦ã³ã« */
            align-items: center; /* ä¸­å¤®å¯„ã› */
            text-align: center;
            font-size: 1.2em; /* èª¿æ•´ */
            color: var(--text-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box; /* paddingã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        #current_datetime {
            font-weight: bold;
            color: var(--secondary-color); /* è‰²ã‚’èª¿æ•´ */
            margin-bottom: 10px; /* æ—¥ä»˜ã¨æ¡ˆå†…ã®é–“ã«ä½™ç™½ */
            font-size: 1.1em; /* æ—¥ä»˜æ™‚åˆ»ã‚’èª¿æ•´ */
            transition: color 0.3s ease;
        }
        /* Pre-announcement (äºˆç´„å‰æ¡ˆå†…) */
        #pre_announcement_text {
            font-weight: bold;
            color: var(--pre-announcement-text-color);
            background-color: var(--pre-announcement-bg-color);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 1.8em; /* ç¾åœ¨ã®æ¡ˆå†…æ–‡ã‚’èª¿æ•´ */
            display: none;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px; /* ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹ */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #announcement_text { /* Current event announcement */
            font-weight: bold;
            color: var(--announcement-text-color);
            background-color: var(--announcement-bg-color);
            padding: 15px 30px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤§ãã */
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            font-size: 1.8em; /* æ¡ˆå†…æ–‡ã‚’èª¿æ•´ */
            display: none; /* Initially hidden */
            width: 100%; /* å¹…ã„ã£ã±ã„ */
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #announcement_text.available { /* ç©ºå®¤æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: var(--available-color);
            color: var(--text-color);
        }

        /* Settings Button */
        #settings_button {
            padding: 10px 22px; /* ãƒœã‚¿ãƒ³ã‚’èª¿æ•´ */
            font-size: 0.9em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚èª¿æ•´ */
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease; /* box-shadowã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            position: fixed; 
            top: 20px;
            right: 20px;
            z-index: 101; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* å½±ã‚’è¿½åŠ  */
            /* åˆæœŸã¯éè¡¨ç¤º */
            display: none; 
        }
        #settings_button:hover {
            background-color: #5a6268; /* Hover color for gray accent */
            box-shadow: 0 6px 12px rgba(0,0,0,0.25); /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’æ¿ƒã */
        }

        /* Version Info */
        #version_info {
            position: fixed;
            top: 70px; /* è¨­å®šãƒœã‚¿ãƒ³ã®ä¸‹ */
            right: 20px;
            z-index: 100;
            font-size: 0.8em;
            color: var(--light-text-color);
            background-color: var(--panel-bg-color);
            padding: 5px 10px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Settings Panel */
        #settings_panel {
            position: fixed; 
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            display: flex;
            justify-content: flex-end; 
            z-index: 100;
            opacity: 0;
            pointer-events: none; 
            transition: opacity 0.3s ease-in-out;
        }
        #settings_panel.open {
            opacity: 1;
            pointer-events: auto;
        }
        #settings_content {
            background-color: var(--panel-bg-color);
            width: 500px; /* ãƒ‘ãƒãƒ«ã®å¹…ã‚’å°‘ã—åºƒã’ã‚‹ */
            max-width: 90%;
            height: 100%;
            padding: 30px;
            box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transform: translateX(100%); 
            transition: transform 0.3s ease-in-out, background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¯èƒ½ã«ã™ã‚‹ */
            overflow-y: auto; 
        }
        #settings_panel.open #settings_content {
            transform: translateX(0); 
        }
        #close_settings_panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2.2em; /* ãƒœã‚¿ãƒ³ã‚’èª¿æ•´ */
            cursor: pointer;
            color: var(--accent-color);
            line-height: 1;
            padding: 5px;
        }
        #close_settings_panel:hover {
            color: var(--text-color);
        }

        /* Auth Section in Settings Panel */
        /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .setting-group.auth-section-group { /* Authã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            margin-bottom: 25px; /* ä¸‹éƒ¨ä½™ç™½ */
            padding-bottom: 20px; /* ä¸‹éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            border-bottom: 1px dashed var(--border-color); /* ä¸‹ç·š */
        }
        #auth_status {
            margin-bottom: 25px; 
            padding: 20px; 
            background-color: #E9F5FF; /* èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯é’ç³»ã‚’ç¶­æŒ */
            border: 1px solid #C5E1FF;
            border-radius: var(--border-radius); 
            text-align: center;
            font-size: 1em; /* èª¿æ•´ */
            line-height: 1.5;
        }
        #authorize_button, #switch_account_button {
            padding: 12px 25px; /* ãƒœã‚¿ãƒ³ã‚’èª¿æ•´ */
            font-size: 1em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); 
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            width: 100%;
            margin-bottom: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* å½±ã‚’è¿½åŠ  */
        }
        #authorize_button:hover, #switch_account_button:hover {
            background-color: #0056B3; /* Darker blue hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’æ¿ƒã */
        }
        #authorize_button:active, #switch_account_button:active {
            transform: translateY(2px); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #authorize_button:disabled, #switch_account_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }
        #calendar_selection_panel {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px dashed var(--border-color);
            flex-grow: 1; 
            overflow-y: auto; 
            min-height: 200px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
            max-height: 50vh; /* æœ€å¤§é«˜ã•ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®50%ã«åˆ¶é™ */
        }
        #calendar_selection_panel h4 { /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ« */
            margin-bottom: 15px;
            font-size: 1.05em; /* èª¿æ•´ */
            color: var(--text-color);
        }
        #writable_calendar_list {
            list-style: none;
            padding: 0;
            margin-top: 20px; 
        }
        #writable_calendar_list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            border-bottom: 1px solid #f7f7f7;
            font-size: 1.05em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            flex-wrap: wrap; /* é•·ã„å ´åˆã¯æŠ˜ã‚Šè¿”ã— */
        }
        #writable_calendar_list li:last-child {
            border-bottom: none;
        }
        
        /* è¿½åŠ ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .calendar-info {
            flex: 1;
            margin-right: 10px;
        }
        .calendar-name {
            font-weight: 500;
            margin-bottom: 3px;
        }
        .calendar-details {
            font-size: 0.85em;
            color: var(--light-text-color);
        }
        .calendar-expiry {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        .calendar-expiry.valid {
            background-color: #d4edda;
            color: #155724;
        }
        .calendar-expiry.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .calendar-expiry.expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        .select-button {
            padding: 10px 20px; /* ãƒœã‚¿ãƒ³ã‚’èª¿æ•´ */
            font-size: 0.95em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å½±ã‚’è¿½åŠ  */
        }
        .select-button:hover {
            background-color: #138496; /* Darker teal hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’æ¿ƒã */
        }
        .select-button:active {
            transform: translateY(2px); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Calendar Security Status */
        .calendar-security-status {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .calendar-security-status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .calendar-security-status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .calendar-security-status.expired {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* è¿½åŠ ï¼šæœŸé™åˆ‡ã‚Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .expired-calendar-notice {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .expired-calendar-name {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.1em;
        }
        .switch-account-notice {
            margin-top: 10px;
            font-style: italic;
            color: #856404;
            background-color: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }

        /* Settings Options */
        .setting-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border-color);
        }
        .setting-group:last-of-type {
            border-bottom: none;
        }
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.95em; /* èª¿æ•´ */
        }
        .setting-group input[type="text"],
        .setting-group input[type="number"],
        .setting-group select {
            width: calc(100% - 20px);
            padding: 8px; /* èª¿æ•´ */
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95em; /* èª¿æ•´ */
            box-sizing: border-box;
            transition: border-color 0.2s ease, border-radius 0.3s ease;
        }
        .setting-group input[type="text"]:focus,
        .setting-group input[type="number"]:focus,
        .setting-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Main Content Area */
        #container {
            flex-grow: 1;
            display: flex;
            gap: 30px; 
            position: relative; 
            width: 100%;
            max-width: 900px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
            padding: 0 20px; /* å·¦å³ã®ä½™ç™½ */
            box-sizing: border-box; /* paddingã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        #event_list_container {
            flex: 1;
            padding: 30px;
            background-color: var(--panel-bg-color);
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-radius 0.3s ease;
        }
        #selected_calendar_info { /* ã“ã®è¦ç´ ã¯æ®‹ã™ãŒã€ä¸­èº«ã¯ç©ºã«ãªã‚‹ */
            display: none; /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã¯ä¸Šã«ç§»å‹•ã—ãŸã®ã§éè¡¨ç¤º */
        }
        #event_list {
            list-style: none;
            padding: 0;
        }
        #event_list li {
            background-color: #fdfdfd;
            border: 1px solid var(--border-color); /* æ ç·šã®è‰²ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            margin-bottom: 18px; /* èª¿æ•´ */
            padding: 18px 22px; /* èª¿æ•´ */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* ã‚«ãƒ¼ãƒ‰UIã®å½± */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-in-out, border-radius 0.3s ease;
        }
        #event_list li:hover {
            transform: translateY(-5px); /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ™‚ã®å½±ã‚’æ¿ƒã */
        }
        /* Highlight for current event */
        #event_list li.current-event {
            background-color: var(--highlight-color);
            border-color: var(--primary-color); /* ãƒã‚¤ãƒ©ã‚¤ãƒˆæ™‚ã®æ ç·šã®è‰²ã‚’ primary color ã« */
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3); /* Primary color ã«åˆã‚ã›ãŸå½± */
        }

        .event-details {
            flex-grow: 1; 
        }
        .event-time {
            font-weight: 700; 
            color: var(--primary-color);
            font-size: 1.2em; /* èª¿æ•´ */
            margin-bottom: 6px; /* èª¿æ•´ */
            display: block;
            transition: color 0.3s ease;
        }
        .event-summary {
            color: var(--text-color);
            font-size: 1.1em; /* èª¿æ•´ */
            line-height: 1.4;
        }
        .no-events {
            font-style: italic;
            color: var(--light-text-color);
            text-align: center;
            padding: 30px; /* èª¿æ•´ */
            font-size: 1.1em; /* èª¿æ•´ */
        }

        /* Action Buttons */
        .action-button-group {
            margin-top: 35px; /* èª¿æ•´ */
            padding-top: 20px; /* èª¿æ•´ */
            border-top: 1px dashed var(--border-color);
            display: flex;
            gap: 15px; /* èª¿æ•´ */
            flex-wrap: wrap;
            justify-content: center; /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®æƒãˆã« */
        }
        .action-button {
            padding: 12px 22px; /* ãƒœã‚¿ãƒ³ã‚’èª¿æ•´ */
            font-size: 1em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* å½±ã‚’è¿½åŠ  */
            flex-grow: 1; 
            min-width: 140px; /* èª¿æ•´ */
            max-width: 230px; /* èª¿æ•´ */
        }
        .action-button:hover {
            background-color: #0056B3; /* Darker blue hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’æ¿ƒã */
        }
        .action-button:active {
            transform: translateY(2px); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Disabled state for action buttons */
        .action-button:disabled,
        .event-delete-button:disabled {
            background-color: #cccccc; /* ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ */
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7; /* å°‘ã—é€æ˜ã« */
            transform: none; /* ç„¡åŠ¹æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã—ãªã„ */
        }

        .error-message {
            color: var(--error-color);
            font-weight: 700;
            margin-top: 20px; /* èª¿æ•´ */
            text-align: center;
            font-size: 1.1em; /* èª¿æ•´ */
            background-color: #FFE5E5; /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èƒŒæ™¯ã¯èµ¤ç³»ã‚’ç¶­æŒ */
            padding: 18px; /* èª¿æ•´ */
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            border: 1px solid var(--error-color);
            width: 100%;
            max-width: 900px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
            box-sizing: border-box;
        }
        /* New delete button for each event item */
        .event-delete-button {
            padding: 8px 16px; /* èª¿æ•´ */
            font-size: 0.9em; /* èª¿æ•´ */
            background-color: var(--delete-button-color); 
            color: white;
            border: none;
            border-radius: var(--border-radius); /* ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹ */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            margin-left: 15px; /* èª¿æ•´ */
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* å½±ã‚’è¿½åŠ  */
        }
        .event-delete-button:hover {
            background-color: #A00000; /* Darker red hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’æ¿ƒã */
        }
        .event-delete-button:active {
            transform: translateY(2px); /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                font-size: var(--base-font-size); /* ç›¸å¯¾å˜ä½ãªã®ã§ãã®ã¾ã¾ */
            }
            header, #top_bar, #container, .error-message {
                padding: 0 10px;
                max-width: 100%; /* å°ã•ã„ç”»é¢ã§ã¯å…¨å¹…ã‚’ä½¿ç”¨ */
            }
            header h1 {
                font-size: 2em; /* ç›¸å¯¾å˜ä½ */
            }
            #display_calendar_summary_top {
                font-size: 1.3em; /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ã‚‚å°‘ã—å¤§ãã */
                transform: translateY(35px); /* èª¿æ•´ */
            }
            #top_bar {
                padding: 15px 20px;
            }
            #current_datetime {
                font-size: 1.1em; /* ç›¸å¯¾å˜ä½ */
            }
            #pre_announcement_text, #announcement_text {
                font-size: 1.4em; /* ç›¸å¯¾å˜ä½ */
                padding: 10px 15px;
            }
            #settings_button {
                padding: 8px 18px; /* èª¿æ•´ */
                font-size: 0.85em; /* ç›¸å¯¾å˜ä½ */
                top: 15px;
                right: 15px;
            }
            #version_info {
                top: 55px; /* è¨­å®šãƒœã‚¿ãƒ³ã®ä½ç½®ã«åˆã‚ã›ã¦èª¿æ•´ */
                right: 15px;
                font-size: 0.75em;
            }
            #settings_content {
                width: 100%;
                max-width: 100%;
                padding: 20px;
            }
            .setting-group {
                margin-bottom: 18px; /* èª¿æ•´ */
                padding-bottom: 12px; /* èª¿æ•´ */
            }
            #authorize_button, #switch_account_button, .select-button, .action-button {
                padding: 10px 18px; /* èª¿æ•´ */
                font-size: 0.95em; /* ç›¸å¯¾å˜ä½ */
            }
            #event_list_container {
                padding: 18px; /* èª¿æ•´ */
            }
            #event_list li {
                flex-direction: column; /* ç¸¦ä¸¦ã³ã« */
                align-items: flex-start; /* å·¦å¯„ã› */
                padding: 12px; /* èª¿æ•´ */
            }
            .event-time, .event-summary {
                font-size: 1em; /* ç›¸å¯¾å˜ä½ */
            }
            .event-delete-button {
                margin-left: 0; /* å·¦ãƒãƒ¼ã‚¸ãƒ³ã‚’ãªãã™ */
                margin-top: 8px; /* ä¸Šã«ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
                width: 100%; /* å¹…ã„ã£ã±ã„ã« */
                padding: 7px 14px; /* èª¿æ•´ */
            }
            .action-button-group {
                flex-direction: column;
                gap: 12px; /* èª¿æ•´ */
            }
            .action-button {
                min-width: unset;
                max-width: unset;
                width: 100%;
            }
            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
            #writable_calendar_list li {
                flex-direction: column;
                align-items: flex-start;
            }
            .calendar-info {
                margin-right: 0;
                margin-bottom: 10px;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.6em; /* ç›¸å¯¾å˜ä½ */
            }
            #display_calendar_summary_top {
                font-size: 1.1em; /* ç›¸å¯¾å˜ä½ */
                transform: translateY(25px); /* èª¿æ•´ */
            }
            #current_datetime {
                font-size: 0.9em; /* ç›¸å¯¾å˜ä½ */
            }
            #pre_announcement_text, #announcement_text {
                font-size: 1.1em; /* ç›¸å¯¾å˜ä½ */
                padding: 7px 10px; /* èª¿æ•´ */
            }
            #version_info {
                top: 50px;
                right: 10px;
                font-size: 0.7em;
                padding: 3px 6px;
            }
            .setting-group label, .setting-group input, .setting-group select {
                font-size: 0.85em; /* ç›¸å¯¾å˜ä½ */
            }
            #authorize_button, #switch_account_button, .select-button, .action-button, .event-delete-button {
                font-size: 0.85em; /* ç›¸å¯¾å˜ä½ */
                padding: 8px 12px; /* èª¿æ•´ */
            }
        }

    </style>
</head>
<body class="theme-stylish">
    <header>
        <h1 id="main_app_title">ä¼šè­°å®¤äºˆç´„è¡¨ç¤ºVer1.2</h1>
        <button id="settings_button">è¨­å®š</button> 
        <div id="version_info"></div>
        <span id="display_calendar_summary_top"></span>
    </header>

    <div id="top_bar">
        <span id="current_datetime"></span>
        <span id="pre_announcement_text"></span> 
        <span id="announcement_text"></span>
    </div>

    <div id="settings_panel">
        <div id="settings_content">
            <button id="close_settings_panel">&times;</button>
            <h2>è¨­å®š</h2>
            <hr>
            
            <div class="setting-group">
                <h3>ğŸ” ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
                <div id="calendar_security_status" class="calendar-security-status">
                    ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨±å¯çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
                </div>
            </div>
            
            <div class="setting-group auth-section-group">
                <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ</h3>
                <p id="auth_status" style="color: blue;">æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚</p>
                <button id="authorize_button">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼</button>
                <button id="switch_account_button" style="display:none;">åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼</button>
                <p style="font-size: 0.9em; color: var(--light-text-color); margin-top: 10px;">
                    â€»ç·Šæ€¥ä¼šè­°ã€å‰Šé™¤ãªã©ã®ç®¡ç†è€…æ“ä½œã‚’åˆ©ç”¨ã™ã‚‹éš›ã«èªè¨¼ãŒå¿…è¦ã§ã™ã€‚<br>
                    â€»èªè¨¼å¾Œã€è¡¨ç¤ºãƒ»æ“ä½œã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </p>
                <div id="calendar_selection_panel" style="display: none;">
                    <div style="height: 3em; margin-bottom: 1em;"></div> <h4>è¡¨ç¤ºãƒ»æ“ä½œã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ</h4>
                    <ul id="writable_calendar_list">
                        <li>èªè¨¼å¾Œã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
                    </ul>
                </div>
            </div>
            <div class="setting-group">
                <h3>ãƒ†ãƒ¼ãƒè¨­å®š</h3>
                <label for="theme_select">ãƒ†ãƒ¼ãƒã‚’é¸æŠ:</label>
                <select id="theme_select">
                    <option value="pop">ãƒãƒƒãƒ—</option>
                    <option value="chic">ã‚·ãƒƒã‚¯</option>
                    <option value="stylish">ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥</option>
                </select>
            </div>

            <div class="setting-group">
                <h3>æ›´æ–°æ™‚é–“è¨­å®š</h3>
                <label for="refresh_interval_select">æ›´æ–°é–“éš” (ç§’):</label>
                <select id="refresh_interval_select">
                    <option value="30">30ç§’</option>
                    <option value="60">60ç§’</option>
                    <option value="120">120ç§’</option>
                </select>
            </div>

            <div class="setting-group">
                <h3>è¡¨ç¤ºæœŸé–“è¨­å®š ğŸ—“ï¸</h3>
                <label for="display_past_hours_input">ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ä½•æ™‚é–“å‰ã¾ã§è¡¨ç¤ºã™ã‚‹ã‹:</label>
                <input type="number" id="display_past_hours_input" min="0" max="24" value="2">
                <label for="display_future_hours_input">ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ä½•æ™‚é–“å¾Œã¾ã§è¡¨ç¤ºã™ã‚‹ã‹:</label>
                <input type="number" id="display_future_hours_input" min="0" max="72" value="12">
            </div>

            <div class="setting-group">
                <h3>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨­å®š ğŸ…°ï¸</h3>
                <label for="base_font_size_input">åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (px):</label>
                <input type="number" id="base_font_size_input" min="10" max="30" value="16">
            </div>

            <div class="setting-group">
                <h3>ãƒ•ã‚©ãƒ³ãƒˆã®ç¨®é¡è¨­å®š ğŸ”¡</h3>
                <label for="font_family_select">ãƒ•ã‚©ãƒ³ãƒˆã®ç¨®é¡:</label>
                <select id="font_family_select">
                    <option value="'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif">Zen Kaku Gothic New (æ¨™æº–)</option>
                    <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                    <option value="'M PLUS Rounded 1c', sans-serif">M PLUS Rounded 1c</option>
                    <option value="'Mochiy Pop One', sans-serif">Mochiy Pop One</option>
                    <option value="'Rampart One', cursive">Rampart One</option> <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Shippori Antique B1', sans-serif">Shippori Antique B1</option>
                    <option value="'Zen Antique', serif">Zen Antique</option> <option value="'Zen Old Mincho', serif">Zen Old Mincho</option> 
                    </select>
            </div>

            <div class="setting-group">
                <h3>è¡¨ç¤ºã‚¿ã‚¤ãƒˆãƒ«è¨­å®š</h3>
                <label for="main_title_input">ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«:</label>
                <input type="text" id="main_title_input" value="ä¼šè­°å®¤äºˆç´„è¡¨ç¤ºVer1.2">

                <label for="event_list_title_input">ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«:</label>
                <input type="text" id="event_list_title_input" value="ç¾åœ¨ã®ä¼šè­°å®¤ã®äºˆå®š">
            </div>

            <div class="setting-group">
                <h3>æ¡ˆå†…æ¿ã®è¡¨ç¤ºè¨­å®š</h3>
                <label for="available_text_input">ç©ºå®¤æ™‚ã®è¡¨è¨˜:</label>
                <input type="text" id="available_text_input" value="ç©ºå®¤ã§ã™">

                <label for="in_progress_prefix_input">å½“è©²æ™‚é–“æ™‚ã®æ¥é ­èª:</label>
                <input type="text" id="in_progress_prefix_input" value="ãŸã ã„ã¾">

                <label for="in_progress_suffix_input">å½“è©²æ™‚é–“æ™‚ã®æ¥å°¾èª:</label>
                <input type="text" id="in_progress_suffix_input" value="ä¸­ã§ã™">
            </div>

            <div class="setting-group">
                <h3>äºˆç´„å‰æ¡ˆå†…è¨­å®š</h3>
                <label for="pre_announcement_minutes_select">äºˆç´„å‰æ¡ˆå†… (ä½•åˆ†å‰):</label>
                <select id="pre_announcement_minutes_select">
                    <option value="1">1åˆ†å‰</option>
                    <option value="5">5åˆ†å‰</option>
                    <option value="10">10åˆ†å‰</option>
                    <option value="15">15åˆ†å‰</option>
                </select>

                <label for="pre_announcement_prefix_input">äºˆç´„å‰æ¡ˆå†…ã®æ¥é ­èª:</label>
                <input type="text" id="pre_announcement_prefix_input" value="ã¾ã‚‚ãªã">

                <label for="pre_announcement_suffix_input">äºˆç´„å‰æ¡ˆå†…ã®æ¥å°¾èª:</label>
                <input type="text" id="pre_announcement_suffix_input" value="é–‹å§‹">

                <label for="pre_announcement_default_text_input">äºˆç´„å‰æ¡ˆå†…ãŒãªã„å ´åˆã®è¡¨è¨˜:</label>
                <input type="text" id="pre_announcement_default_text_input" value="ã”æ¡ˆå†…">
            </div>

            <div class="setting-group">
                <h3>ç·Šæ€¥ä¼šè­°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h3>
                <label for="event_summary_input">ã‚¤ãƒ™ãƒ³ãƒˆå (30åˆ†/60åˆ†å…±é€š):</label>
                <input type="text" id="event_summary_input" value="ç·Šæ€¥ä¼šè­°">
            </div>

            <hr style="display: none;"> </div>
    </div>

    <div id="container">
        <div id="event_list_container" class="panel">
            <h2 id="event_list_section_title">ç¾åœ¨ã®ä¼šè­°å®¤ã®äºˆå®š</h2>
            <ul id="event_list">
                <li>ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
            </ul>
            <div class="action-button-group">
                <button id="add_30min_event_button" class="action-button">ç·Šæ€¥ä¼šè­° (30åˆ†)</button>
                <button id="add_60min_event_button" class="action-button">ç·Šæ€¥ä¼šè­° (60åˆ†)</button>
                <button id="refresh_button" class="action-button">æ›´æ–°</button>
            </div>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // â˜…â˜…â˜… ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';             
        const INITIAL_PUBLIC_CALENDAR_ID = 'kaigishitsu20000101@gmail.com'; 
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; 
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const WRITE_SCOPES = 'https://www.googleapis.com/auth/calendar.events'; 

        const LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY = 'activeCalendarId';
        const LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY = 'activeCalendarSummary';
        const LOCAL_STORAGE_SETTINGS_KEY = 'appSettings'; // è¨­å®šä¿å­˜ç”¨ã‚­ãƒ¼

        // è¿½åŠ ï¼šãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
        const APP_VERSION = 'Ver1.36';

        // æœ€å°é™è¿½åŠ ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDç®¡ç†
        const GITHUB_PAGES_BASE_URL = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');
        const ALLOWED_CALENDARS_CSV_PATH = GITHUB_PAGES_BASE_URL + '/allowed_calendars.csv';
        let allowedCalendars = []; // è¨±å¯ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒªã‚¹ãƒˆ
        
        // è¿½åŠ ï¼šè¨­å®šç”»é¢è„±å‡ºåˆ¶å¾¡
        let canCloseSettings = true; // è¨­å®šç”»é¢ã‚’é–‰ã˜ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã©ã†ã‹

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤
        const DEFAULT_SETTINGS = {
            refreshInterval: 30, // ç§’
            displayPastHours: 2, // ç¾åœ¨æ™‚åˆ»ã‹ã‚‰éå»ä½•æ™‚é–“åˆ†ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‹
            displayFutureHours: 12, // ç¾åœ¨æ™‚åˆ»ã‹ã‚‰æœªæ¥ä½•æ™‚é–“åˆ†ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‹
            baseFontSize: 16, // åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (px)
            baseFontFamily: "'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif", // æ–°è¦: åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼
            availableText: "ç©ºå®¤ã§ã™",
            inProgressPrefix: "ãŸã ã„ã¾",
            inProgressSuffix: "ä¸­ã§ã™",
            preAnnouncementMinutes: 5, // äºˆç´„å‰æ¡ˆå†…ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†å‰
            preAnnouncementPrefix: "ã¾ã‚‚ãªã",
            preAnnouncementSuffix: "é–‹å§‹",
            preAnnouncementDefaultText: "ã”æ¡ˆå†…", // äºˆç´„å‰æ¡ˆå†…ãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡è¨€
            eventSummary: "ç·Šæ€¥ä¼šè­°",
            lastEvents: [], // æœ€å¾Œã«å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«ä¿å­˜ï¼ˆæ¡ˆå†…æ–‡ç”¨ï¼‰
            theme: "stylish", // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’stylishã«è¨­å®š
            mainTitle: "ä¼šè­°å®¤äºˆç´„è¡¨ç¤ºVer1.2", // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            eventListTitle: "ç¾åœ¨ã®ä¼šè­°å®¤ã®äºˆå®š" // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        };
        let appSettings = {}; // ç¾åœ¨ã®ã‚¢ãƒ—ãƒªè¨­å®š

        let tokenClient; 
        let isAuthorizedForWrite = false; 
        let currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
        let currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"; 
        let refreshIntervalId; 
        let lastFetchedEventsString = ""; 

        // æœ€å°é™è¿½åŠ ï¼šè¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadAllowedCalendars() {
            const statusElement = document.getElementById('calendar_security_status');
            try {
                statusElement.textContent = 'è¨±å¯ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';
                statusElement.className = 'calendar-security-status';
                
                const response = await fetch(ALLOWED_CALENDARS_CSV_PATH, {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (!response.ok) {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (HTTP ${response.status})`);
                }
                
                const csvText = await response.text();
                const parsedData = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: ','
                });
                
                // CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆIDãŒã‚ã‚‹ã‚‚ã®ã®ã¿ã€æœŸé™åˆ‡ã‚Œã§ã‚‚å«ã‚ã‚‹ï¼‰
                const rawCalendars = parsedData.data.filter(row => row.calendar_id && row.calendar_id.trim() !== '');
                
                // ä¿®æ­£ï¼šæœŸé™åˆ‡ã‚Œã§ã‚‚é™¤å¤–ã›ãšã€æœŸé™çŠ¶æ…‹ã‚’è¿½åŠ 
                const today = new Date();
                today.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’00:00:00ã«è¨­å®šï¼ˆæ—¥ä»˜ã®ã¿ã§æ¯”è¼ƒï¼‰
                
                let validCount = 0;
                let expiredCount = 0;
                
                allowedCalendars = rawCalendars.map(calendar => {
                    // æ—¥æœ¬èªãƒ˜ãƒƒãƒ€ãƒ¼ã¨è‹±èªãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸¡æ–¹ã«å¯¾å¿œ
                    const validUntilValue = calendar.valid_until || calendar['æœ‰åŠ¹å¹´æœˆæ—¥'] || calendar['æœ‰åŠ¹æœŸé™'];
                    
                    if (!validUntilValue || validUntilValue.trim() === '') {
                        console.warn(`âš ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ${calendar.calendar_id} ã®æœ‰åŠ¹æœŸé™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
                        calendar.isExpired = true;
                        calendar.expiryReason = 'æœŸé™è¨­å®šãªã—';
                        expiredCount++;
                        return calendar;
                    }
                    
                    // è¤‡æ•°ã®æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œ
                    let validUntilDate;
                    const dateStr = validUntilValue.trim();
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: YYYY/M/D ã¾ãŸã¯ YYYY/MM/DD
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯0ãƒ™ãƒ¼ã‚¹
                            const day = parseInt(parts[2]);
                            validUntilDate = new Date(year, month, day);
                        }
                    }
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: YYYY-MM-DD
                    else if (dateStr.includes('-')) {
                        validUntilDate = new Date(dateStr);
                    }
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãã®ä»–ã®å½¢å¼
                    else {
                        validUntilDate = new Date(dateStr);
                    }
                    
                    validUntilDate.setHours(23, 59, 59, 999); // æœ‰åŠ¹æœŸé™æ—¥ã®çµ‚æ—¥ã¾ã§æœ‰åŠ¹
                    
                    if (isNaN(validUntilDate.getTime())) {
                        console.warn(`âš ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ${calendar.calendar_id} ã®æœ‰åŠ¹æœŸé™å½¢å¼ãŒä¸æ­£ã§ã™: ${validUntilValue}`);
                        calendar.isExpired = true;
                        calendar.expiryReason = 'æœŸé™å½¢å¼ä¸æ­£';
                        expiredCount++;
                        return calendar;
                    }
                    
                    if (today > validUntilDate) {
                        console.warn(`âš ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ${calendar.calendar_id} ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™: ${validUntilValue} (ä»Šæ—¥: ${today.toLocaleDateString()})`);
                        calendar.isExpired = true;
                        calendar.expiryReason = 'æœŸé™åˆ‡ã‚Œ';
                        expiredCount++;
                    } else {
                        console.log(`âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ${calendar.calendar_id} ã¯æœ‰åŠ¹ã§ã™ (æœŸé™: ${validUntilValue}, ä»Šæ—¥: ${today.toLocaleDateString()})`);
                        calendar.isExpired = false;
                        validCount++;
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æ­£è¦åŒ–ï¼ˆè‹±èªãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã«ï¼‰
                    calendar.valid_until = validUntilValue;
                    calendar.company_name = calendar.company_name || calendar['ä¼šç¤¾å'] || '';
                    calendar.memo = calendar.memo || calendar['ãƒ¡ãƒ¢'] || '';
                    
                    return calendar;
                });
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æœŸé™åˆ‡ã‚Œã®æœ‰ç„¡ã§å¤‰æ›´
                if (expiredCount > 0) {
                    statusElement.textContent = `âš ï¸ è¨±å¯ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº† (æœ‰åŠ¹: ${validCount}ä»¶, æœŸé™åˆ‡ã‚Œ: ${expiredCount}ä»¶)`;
                    statusElement.className = 'calendar-security-status expired';
                } else {
                    statusElement.textContent = `âœ… è¨±å¯ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº† (æœ‰åŠ¹: ${validCount}ä»¶)`;
                    statusElement.className = 'calendar-security-status success';
                }
                
                // è©³ç´°ãƒ­ã‚°
                console.log('âœ… è¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆï¼ˆæœŸé™åˆ‡ã‚Œå«ã‚€ï¼‰:', allowedCalendars);
                
                return true;
                
            } catch (error) {
                console.error('âŒ è¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                statusElement.textContent = `âŒ è¨±å¯ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`;
                statusElement.className = 'calendar-security-status error';
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã¿è¨±å¯ï¼ˆæœŸé™ãªã—ï¼‰
                allowedCalendars = [{
                    calendar_id: INITIAL_PUBLIC_CALENDAR_ID,
                    valid_until: '2099-12-31',
                    company_name: 'åˆæœŸè¨­å®š',
                    memo: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
                    isExpired: false
                }];
                return false;
            }
        }

        // ä¿®æ­£ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDè¨±å¯ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆæœŸé™åˆ‡ã‚Œã¯è¨±å¯ã™ã‚‹ãŒã€æœŸé™çŠ¶æ…‹ã‚’è¿”ã™ï¼‰
        function isCalendarAllowed(calendarId) {
            return allowedCalendars.some(allowed => allowed.calendar_id === calendarId);
        }

        // æ–°è¦è¿½åŠ ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæœ‰åŠ¹æœŸé™å†…ã‹ãƒã‚§ãƒƒã‚¯
        function isCalendarValid(calendarId) {
            const calendar = allowedCalendars.find(allowed => allowed.calendar_id === calendarId);
            return calendar && !calendar.isExpired;
        }

        // ä¿®æ­£ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±å–å¾—ï¼ˆã‚µãƒãƒªãƒ¼ã‚’å–å¾—ï¼‰
        async function getCalendarSummary(calendarId) {
            try {
                const response = await gapi.client.calendar.calendars.get({
                    calendarId: calendarId
                });
                return response.result.summary || calendarId;
            } catch (error) {
                console.warn(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚µãƒãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼ (${calendarId}):`, error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯IDã‚’ãã®ã¾ã¾è¿”ã™
                return calendarId;
            }
        }

        // è¿½åŠ ï¼šè¨­å®šç”»é¢è„±å‡ºåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯ï¼ˆæœŸé™åˆ‡ã‚Œå¯¾å¿œï¼‰
        function checkAndControlSettingsAccess() {
            const currentCalendarValid = isCalendarValid(currentCalendarId); // ä¿®æ­£ï¼šæœŸé™ãƒã‚§ãƒƒã‚¯ã«å¤‰æ›´
            canCloseSettings = currentCalendarValid;
            
            if (!currentCalendarValid) {
                console.log('ğŸš¨ ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®ãŸã‚ã€è¨­å®šç”»é¢è„±å‡ºã‚’åˆ¶é™ã—ã¾ã™');
                // è¨­å®šç”»é¢ã‚’å¼·åˆ¶çš„ã«é–‹ã
                document.getElementById('settings_panel').classList.add('open');
                
                // æœŸé™åˆ‡ã‚Œã®å ´åˆã¯èµ¤è‰²è¡¨ç¤º + ä»–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¿ƒã—
                const currentCalendar = allowedCalendars.find(cal => cal.calendar_id === currentCalendarId);
                if (currentCalendar && currentCalendar.isExpired) {
                    displayExpiredCalendarNotice(currentCalendar);
                } else {
                    displayError('ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚æœ‰åŠ¹ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                console.log('âœ… ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æœ‰åŠ¹ã§ã™');
            }
        }

        // æ–°è¦è¿½åŠ ï¼šæœŸé™åˆ‡ã‚Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€šçŸ¥è¡¨ç¤º
        function displayExpiredCalendarNotice(expiredCalendar) {
            const errorContainer = document.getElementById('error_display');
            if (!errorContainer) return;
            
            const companyName = expiredCalendar.company_name || 'ä¸æ˜';
            const calendarName = currentCalendarSummary || expiredCalendar.calendar_id;
            const validUntil = expiredCalendar.valid_until || 'ä¸æ˜';
            
            errorContainer.innerHTML = `
                <div class="expired-calendar-notice">
                    <div class="expired-calendar-name">âš ï¸ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ: ${calendarName}</div>
                    <div>ä¼šç¤¾å: ${companyName}</div>
                    <div>æœ‰åŠ¹æœŸé™: ${validUntil}</div>
                    <div class="switch-account-notice">
                        ğŸ’¡ ã“ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚<br>
                        åˆ¥ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«æœŸé™å»¶é•·ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚
                    </div>
                </div>
            `;
            errorContainer.style.display = 'block';
        }

        // è¿½åŠ ï¼šæœ‰åŠ¹æœŸé™ã®è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getExpiryDisplay(validUntilStr) {
            if (!validUntilStr) return { text: 'æœŸé™ä¸æ˜', class: 'expired' };
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let validUntilDate;
            const dateStr = validUntilStr.trim();
            
            // æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const day = parseInt(parts[2]);
                    validUntilDate = new Date(year, month, day);
                }
            } else if (dateStr.includes('-')) {
                validUntilDate = new Date(dateStr);
            } else {
                validUntilDate = new Date(dateStr);
            }
            
            if (isNaN(validUntilDate.getTime())) {
                return { text: 'æœŸé™ä¸æ˜', class: 'expired' };
            }
            
            validUntilDate.setHours(23, 59, 59, 999);
            
            const diffTime = validUntilDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { text: `æœŸé™åˆ‡ã‚Œ`, class: 'expired' };
            } else if (diffDays <= 7) {
                return { text: `${diffDays}æ—¥å¾ŒæœŸé™`, class: 'warning' };
            } else {
                return { text: `${validUntilStr}ã¾ã§`, class: 'valid' };
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('version_info').textContent = APP_VERSION;
            
            // è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€UIã¨ã‚¢ãƒ—ãƒªã«é©ç”¨
            loadSettings();
            applySettingsToUI();
            applyTheme(appSettings.theme);
            applyBaseFontSize(appSettings.baseFontSize);
            applyFontFamily(appSettings.baseFontFamily); // è¿½åŠ : ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’é©ç”¨
            updateDisplayTitles(); // é¡Œåã¨é …ç›®é¡Œåã‚’åˆæœŸè¡¨ç¤ºã«åæ˜ 

            // UIè¦ç´ ã®å–å¾—
            const settingsButton = document.getElementById('settings_button');
            const settingsPanel = document.getElementById('settings_panel');
            const closeSettingsPanelButton = document.getElementById('close_settings_panel');
            const authorizeButton = document.getElementById('authorize_button');
            const switchAccountButton = document.getElementById('switch_account_button'); 
            const refreshButton = document.getElementById('refresh_button'); // æ›´æ–°ãƒœã‚¿ãƒ³

            // è¨­å®šUIè¦ç´ ã®å–å¾— (è¨­å®šä¿å­˜/é©ç”¨ç”¨)
            const themeSelect = document.getElementById('theme_select');
            const refreshIntervalSelect = document.getElementById('refresh_interval_select');
            const displayPastHoursInput = document.getElementById('display_past_hours_input');
            const displayFutureHoursInput = document.getElementById('display_future_hours_input');
            const baseFontSizeInput = document.getElementById('base_font_size_input');
            const fontFamilySelect = document.getElementById('font_family_select'); // è¿½åŠ 
            const mainTitleInput = document.getElementById('main_title_input'); 
            const eventListTitleInput = document.getElementById('event_list_title_input'); 
            const availableTextInput = document.getElementById('available_text_input');
            const inProgressPrefixInput = document.getElementById('in_progress_prefix_input');
            const inProgressSuffixInput = document.getElementById('in_progress_suffix_input');
            const preAnnouncementMinutesSelect = document.getElementById('pre_announcement_minutes_select'); 
            const preAnnouncementPrefixInput = document.getElementById('pre_announcement_prefix_input'); 
            const preAnnouncementSuffixInput = document.getElementById('pre_announcement_suffix_input'); 
            const preAnnouncementDefaultTextInput = document.getElementById('pre_announcement_default_text_input'); 
            const eventSummaryInput = document.getElementById('event_summary_input');
            
            // --- è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            // è¨­å®šãƒœã‚¿ãƒ³ã¯åˆæœŸã¯éè¡¨ç¤º
            settingsButton.style.display = 'none';
            settingsButton.onclick = () => {
                settingsPanel.classList.toggle('open');
                if (settingsPanel.classList.contains('open') && isAuthorizedForWrite) {
                    listWritableCalendars(); 
                } else if (!settingsPanel.classList.contains('open')) {
                    displayError(''); 
                }
            };
            
            // ä¿®æ­£ï¼šæ›´æ–°ãƒœã‚¿ãƒ³ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ¤œå‡ºæ”¹å–„
            let clickCount = 0;
            let clickTimer = null;
            
            refreshButton.addEventListener('click', (e) => {
                clickCount++;
                
                if (clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        // é€šå¸¸ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                        listEvents();
                        clickCount = 0;
                    }, 400); // 400mså¾…ã¤
                } else if (clickCount === 2) {
                    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    
                    console.log('--- æ›´æ–°ãƒœã‚¿ãƒ³ãŒãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ ---');
                    
                    if (settingsButton.style.display === 'none' || settingsButton.style.display === '') {
                        settingsButton.style.display = 'block';
                        settingsButton.disabled = false;
                        console.log('è¨­å®šãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                        
                        // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆç·‘è‰²ï¼‰
                        refreshButton.style.backgroundColor = '#28a745';
                        refreshButton.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            refreshButton.style.backgroundColor = '';
                            refreshButton.style.transform = '';
                        }, 500);
                    } else {
                        settingsButton.style.display = 'none';
                        settingsPanel.classList.remove('open');
                        console.log('è¨­å®šãƒœã‚¿ãƒ³ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸ');
                        
                        // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆèµ¤è‰²ï¼‰
                        refreshButton.style.backgroundColor = '#dc3545';
                        refreshButton.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            refreshButton.style.backgroundColor = '';
                            refreshButton.style.transform = '';
                        }, 500);
                    }
                }
            });

            // ä¿®æ­£ï¼šè¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆè„±å‡ºåˆ¶å¾¡è¿½åŠ ï¼‰
            closeSettingsPanelButton.onclick = () => {
                if (!canCloseSettings) {
                    displayError('æœ‰åŠ¹ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚');
                    console.log('ğŸš¨ è¨­å®šç”»é¢ã‹ã‚‰ã®è„±å‡ºãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼šæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼');
                    return;
                }
                settingsPanel.classList.remove('open');
                displayError(''); 
            };
            
            // ä¿®æ­£ï¼šè¨­å®šãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã®é–‰é–ã‚‚åˆ¶å¾¡
            settingsPanel.addEventListener('click', (e) => {
                if (e.target === settingsPanel) { // ãƒ‘ãƒãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯
                    if (!canCloseSettings) {
                        displayError('æœ‰åŠ¹ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚');
                        console.log('ğŸš¨ è¨­å®šç”»é¢ã‹ã‚‰ã®è„±å‡ºãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼šæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼');
                        return;
                    }
                    settingsPanel.classList.remove('open');
                    displayError('');
                }
            });

            // --- å„ç¨®è¨­å®šUIè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            themeSelect.onchange = (e) => { appSettings.theme = e.target.value; saveSettings(); applyTheme(appSettings.theme); };
            refreshIntervalSelect.onchange = (e) => { appSettings.refreshInterval = parseInt(e.target.value); saveSettings(); startAutoRefresh(); };
            displayPastHoursInput.onchange = (e) => { appSettings.displayPastHours = parseInt(e.target.value); saveSettings(); listEvents(); };
            displayFutureHoursInput.onchange = (e) => { appSettings.displayFutureHours = parseInt(e.target.value); saveSettings(); listEvents(); };
            baseFontSizeInput.onchange = (e) => { appSettings.baseFontSize = parseInt(e.target.value); saveSettings(); applyBaseFontSize(appSettings.baseFontSize); };
            fontFamilySelect.onchange = (e) => { appSettings.baseFontFamily = e.target.value; saveSettings(); applyFontFamily(appSettings.baseFontFamily); }; // è¿½åŠ 
            mainTitleInput.onchange = (e) => { appSettings.mainTitle = e.target.value; saveSettings(); updateDisplayTitles(); }; 
            eventListTitleInput.onchange = (e) => { appSettings.eventListTitle = e.target.value; saveSettings(); updateDisplayTitles(); }; 
            availableTextInput.onchange = (e) => { appSettings.availableText = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            inProgressPrefixInput.onchange = (e) => { appSettings.inProgressPrefix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); };
            inProgressSuffixInput.onchange = (e) => { appSettings.inProgressSuffix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); };
            preAnnouncementMinutesSelect.onchange = (e) => { appSettings.preAnnouncementMinutes = parseInt(e.target.value); saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementPrefixInput.onchange = (e) => { appSettings.preAnnouncementPrefix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementSuffixInput.onchange = (e) => { appSettings.preAnnouncementSuffix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementDefaultTextInput.onchange = (e) => { appSettings.preAnnouncementDefaultText = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            eventSummaryInput.onchange = (e) => { appSettings.eventSummary = e.target.value; saveSettings(); updateAddButtonText(); }; 

            // --- èªè¨¼é–¢é€£ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            authorizeButton.onclick = () => {
                console.log('--- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼ˆæ“ä½œç”¨ï¼‰ã€‚èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚---');
                tokenClient.requestAccessToken({ prompt: 'consent', ux_mode: 'popup' }); 
            };
            switchAccountButton.onclick = () => { 
                console.log('--- åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠã‚’å¼·åˆ¶ã—ã¾ã™ã€‚---');
                tokenClient.requestAccessToken({ prompt: 'select_account', ux_mode: 'popup' }); 
            };

            // --- æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            document.getElementById('add_30min_event_button').onclick = () => handleAddEvent(30);
            document.getElementById('add_60min_event_button').onclick = () => handleAddEvent(60); 

            setInterval(updateCurrentDateTime, 1000);
            updateCurrentDateTime(); 

            updateAddButtonText();

            // æœ€å°é™è¿½åŠ ï¼šè¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰gapiåˆæœŸåŒ–
            console.log('--- è¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ ---');
            loadAllowedCalendars().then(() => {
                // è¿½åŠ ï¼šèµ·å‹•æ™‚ã®è„±å‡ºåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
                checkAndControlSettingsAccess();
                
                console.log('--- gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ ---');
                gapi.load('client', initGapiClientForRead);
            });
        });

        // è¨­å®šã‚’localStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
        function loadSettings() {
            const savedSettings = localStorage.getItem(LOCAL_STORAGE_SETTINGS_KEY);
            if (savedSettings) {
                try {
                    appSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(savedSettings) };
                    if (!appSettings.lastEvents) {
                        appSettings.lastEvents = [];
                    }
                    console.log('âœ… è¨­å®šã‚’localStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ:', appSettings);
                } catch (e) {
                    console.error('âŒ localStorageã‹ã‚‰ã®è¨­å®šèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', e);
                    appSettings = { ...DEFAULT_SETTINGS };
                }
            } else {
                appSettings = { ...DEFAULT_SETTINGS };
                console.log('â„¹ï¸ è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™:', appSettings);
            }
        }

        // è¨­å®šã‚’localStorageã«ä¿å­˜
        function saveSettings() {
            localStorage.setItem(LOCAL_STORAGE_SETTINGS_KEY, JSON.stringify(appSettings));
            console.log('âœ… è¨­å®šã‚’localStorageã«ä¿å­˜ã—ã¾ã—ãŸ:', appSettings);
        }

        // UIã«è¨­å®šå€¤ã‚’é©ç”¨
        function applySettingsToUI() {
            document.getElementById('theme_select').value = appSettings.theme;
            document.getElementById('refresh_interval_select').value = appSettings.refreshInterval;
            document.getElementById('display_past_hours_input').value = appSettings.displayPastHours;
            document.getElementById('display_future_hours_input').value = appSettings.displayFutureHours;
            document.getElementById('base_font_size_input').value = appSettings.baseFontSize;
            document.getElementById('font_family_select').value = appSettings.baseFontFamily; // è¿½åŠ 
            document.getElementById('main_title_input').value = appSettings.mainTitle; 
            document.getElementById('event_list_title_input').value = appSettings.eventListTitle; 
            document.getElementById('available_text_input').value = appSettings.availableText;
            document.getElementById('in_progress_prefix_input').value = appSettings.inProgressPrefix;
            document.getElementById('in_progress_suffix_input').value = appSettings.inProgressSuffix;
            document.getElementById('pre_announcement_minutes_select').value = appSettings.preAnnouncementMinutes;
            document.getElementById('pre_announcement_prefix_input').value = appSettings.preAnnouncementPrefix;
            document.getElementById('pre_announcement_suffix_input').value = appSettings.preAnnouncementSuffix;
            document.getElementById('pre_announcement_default_text_input').value = appSettings.preAnnouncementDefaultText;
            document.getElementById('event_summary_input').value = appSettings.eventSummary;
        }

        // ãƒ†ãƒ¼ãƒã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applyTheme(themeName) {
            document.body.classList.remove('theme-pop', 'theme-chic', 'theme-stylish');
            document.body.classList.add(`theme-${themeName}`);
            console.log(`ãƒ†ãƒ¼ãƒã‚’ "${themeName}" ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
        }

        // åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applyBaseFontSize(fontSize) {
            document.documentElement.style.setProperty('--base-font-size', `${fontSize}px`);
            console.log(`åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ ${fontSize}px ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
        }

        // æ–°è¦: ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applyFontFamily(fontFamily) {
            document.documentElement.style.setProperty('--base-font-family', fontFamily);
            console.log(`ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’ "${fontFamily}" ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
        }

        // è¿½åŠ ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateAddButtonText() {
            const eventSummary = appSettings.eventSummary || "ç·Šæ€¥ä¼šè­°";
            document.getElementById('add_30min_event_button').textContent = `${eventSummary} (30åˆ†)`;
            document.getElementById('add_60min_event_button').textContent = `${eventSummary} (60åˆ†)`;
        }

        // é¡Œåã¨é …ç›®é¡Œåã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateDisplayTitles() {
            document.getElementById('main_app_title').textContent = appSettings.mainTitle;
            document.getElementById('event_list_section_title').textContent = appSettings.eventListTitle;
            console.log(`âœ… è¡¨ç¤ºã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ãƒ¡ã‚¤ãƒ³ã€Œ${appSettings.mainTitle}ã€ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã€Œ${appSettings.eventListTitle}ã€`);
        }

        function initGapiClientForRead() {
            console.log('--- initGapiClientForRead: èª­ã¿è¾¼ã¿å°‚ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ä¸­ ---');
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(async () => {
                console.log('âœ… gapi client initialized for read-only access (API Key only).');
                
                console.log('--- initGapiClientForRead: localStorageã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿è©¦è¡Œ ---');
                const savedActiveId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY);
                const savedActiveSummary = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY);

                if (savedActiveId && savedActiveSummary) { 
                    // ä¿®æ­£ï¼šä¿å­˜ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆæœŸé™åˆ‡ã‚Œã§ã‚‚ï¼‰
                    currentCalendarId = savedActiveId;
                    currentCalendarSummary = savedActiveSummary;
                    
                    // ã‚µãƒãƒªãƒ¼ã‚’å†å–å¾—ã—ã¦æ›´æ–°
                    try {
                        const actualSummary = await getCalendarSummary(savedActiveId);
                        if (actualSummary !== savedActiveId) { // IDã¨ç•°ãªã‚‹å ´åˆã®ã¿æ›´æ–°
                            currentCalendarSummary = actualSummary;
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, actualSummary);
                        }
                    } catch (error) {
                        console.warn('ã‚µãƒãƒªãƒ¼å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    }
                    
                    if (isCalendarValid(savedActiveId)) {
                        console.log(`âœ… localStorageã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                    } else {
                        console.warn(`âš ï¸ ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${savedActiveId}) ã¯æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ãŒã€ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚`);
                    }
                } else {
                    currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
                    
                    // ä¿®æ­£ï¼šåˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
                    try {
                        currentCalendarSummary = await getCalendarSummary(INITIAL_PUBLIC_CALENDAR_ID);
                    } catch (error) {
                        currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼";
                    }
                    
                    console.log(`â„¹ï¸ localStorageã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (${INITIAL_PUBLIC_CALENDAR_ID}) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                }
                
                // è¿½åŠ ï¼šèµ·å‹•æ™‚ã®è„±å‡ºåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
                checkAndControlSettingsAccess();
                
                updateDisplayedCalendarInfo();

                console.log(`--- initGapiClientForRead: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’é–‹å§‹ (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${currentCalendarId}) ---`);
                listEvents(); 
                startAutoRefresh(); 

                console.log('--- initGapiClientForRead: GISã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚’é–‹å§‹ï¼ˆæ›¸ãè¾¼ã¿æ“ä½œç”¨ï¼‰ ---');
                initGisClientForWrite();

            }).catch(err => {
                console.error('âŒ gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆèª­ã¿è¾¼ã¿ç”¨ï¼‰:', err);
                displayError('ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }

        function initGisClientForWrite() {
            console.log('--- initGisClientForWrite: GISã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ä¸­ ---');
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: WRITE_SCOPES,
                callback: (tokenResponse) => {
                    console.log('--- tokenClient callback executed for write scope ---');
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        isAuthorizedForWrite = true;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'green';
                        document.getElementById('authorize_button').style.display = 'none'; 
                        document.getElementById('switch_account_button').style.display = 'block'; 
                        document.getElementById('calendar_selection_panel').style.display = 'block'; 
                        console.log('âœ… æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
                        
                        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ï¼šç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã®è¨±å¯ãƒã‚§ãƒƒã‚¯
                        checkCurrentCalendarAfterAuth();
                        
                        listWritableCalendars(); 
                    } else {
                        isAuthorizedForWrite = false;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'red';
                        document.getElementById('authorize_button').style.display = 'block'; 
                        document.getElementById('switch_account_button').style.display = 'none'; 
                        document.getElementById('calendar_selection_panel').style.display = 'none'; 
                        console.error('âŒ æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', tokenResponse);
                    }
                },
                error_callback: (error) => {
                    isAuthorizedForWrite = false;
                    document.getElementById('auth_status').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    document.getElementById('auth_status').style.color = 'red';
                    document.getElementById('authorize_button').style.display = 'block'; 
                    document.getElementById('switch_account_button').style.display = 'none'; 
                    document.getElementById('calendar_selection_panel').style.display = 'none'; 
                    console.error('âŒ GISãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ï¼ˆæ›¸ãè¾¼ã¿ç”¨ï¼‰:', error);
                }
            });
        }

        // æ–°è¦è¿½åŠ ï¼šèªè¨¼å¾Œã®ç¾åœ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
        async function checkCurrentCalendarAfterAuth() {
            console.log('--- checkCurrentCalendarAfterAuth: èªè¨¼å¾Œã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ ---');
            
            // ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (!isCalendarAllowed(currentCalendarId)) {
                console.warn(`âš ï¸ ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${currentCalendarId}) ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã—ã¾ã™ã€‚`);
                
                // è¨±å¯ã•ã‚Œã¦ã„ã‚‹æœ€åˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¾ãŸã¯åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¨­å®š
                if (allowedCalendars.length > 0) {
                    const firstAllowedCalendar = allowedCalendars[0];
                    currentCalendarId = firstAllowedCalendar.calendar_id;
                    currentCalendarSummary = firstAllowedCalendar.display_name || firstAllowedCalendar.calendar_id;
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                    localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, currentCalendarId);
                    localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, currentCalendarSummary);
                    
                    console.log(`âœ… è¨±å¯ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å¤‰æ›´ã—ã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID;
                    currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼";
                    
                    localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, currentCalendarId);
                    localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, currentCalendarSummary);
                    
                    console.log(`âš ï¸ è¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¨­å®šã—ã¾ã—ãŸ: ${currentCalendarId}`);
                }
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplayedCalendarInfo();
                listEvents();
            } else {
                console.log(`âœ… ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${currentCalendarId}) ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
            }
            
            // æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
            try {
                const response = await gapi.client.calendar.calendarList.list();
                const accessibleCalendars = response.result.items || [];
                const writableCalendars = accessibleCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );
                const allowedWritableCalendars = writableCalendars.filter(calendar => 
                    isCalendarAllowed(calendar.id)
                );
                
                if (allowedWritableCalendars.length === 0) {
                    document.getElementById('auth_status').textContent = 'âš ï¸ ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯è¨±å¯ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚';
                    document.getElementById('auth_status').style.color = 'orange';
                    console.warn('âŒ æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯è¨±å¯ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚');
                } else {
                    document.getElementById('auth_status').textContent = `âœ… æ“ä½œæ¨©é™ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸ (è¨±å¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${allowedWritableCalendars.length}ä»¶)`;
                    document.getElementById('auth_status').style.color = 'green';
                    console.log(`âœ… æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¨±å¯ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: ${allowedWritableCalendars.length}ä»¶`);
                }
                
            } catch (err) {
                console.error('âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆå¾Œã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('auth_status').textContent = 'âš ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                document.getElementById('auth_status').style.color = 'orange';
            }
        }

        function handleActionTrigger(event) {
            console.log('--- handleActionTrigger: æ“ä½œãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ ---');
            document.getElementById('settings_panel').classList.add('open'); 

            if (!isAuthorizedForWrite) {
                document.getElementById('auth_status').textContent = 'æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚';
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ æ“ä½œãƒˆãƒªã‚¬ãƒ¼: æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return; 
            }
        }

        // æœ€å°é™ä¿®æ­£ï¼šè¨±å¯ãƒªã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¿½åŠ 
        async function listWritableCalendars() {
            const writableCalendarListUl = document.getElementById('writable_calendar_list');
            writableCalendarListUl.innerHTML = '<li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>';
            displayError('');
            console.log('--- listWritableCalendars: æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ä¸­ ---');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;
                const writableCalendars = allCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );

                // æœ€å°é™è¿½åŠ ï¼šè¨±å¯ãƒªã‚¹ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const allowedWritableCalendars = writableCalendars.filter(calendar => 
                    isCalendarAllowed(calendar.id)
                );

                if (allowedWritableCalendars && allowedWritableCalendars.length > 0) {
                    writableCalendarListUl.innerHTML = ''; 
                    allowedWritableCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        const isCurrent = (calendar.id === currentCalendarId) ? ' (ç¾åœ¨é¸æŠä¸­)' : '';
                        li.innerHTML = `
                            <span>${calendar.summary}${isCurrent}</span>
                            <button class="select-button" 
                                data-calendar-id="${calendar.id}" 
                                data-calendar-summary="${calendar.summary}">é¸æŠ</button>
                        `;
                        writableCalendarListUl.appendChild(li);
                    });
                    console.log('âœ… è¨±å¯ã•ã‚ŒãŸæ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ:', allowedWritableCalendars);

                    document.querySelectorAll('#writable_calendar_list .select-button').forEach(button => {
                        button.onclick = (event) => {
                            console.log('--- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ ---');
                            const newActiveId = event.target.dataset.calendarId;
                            const newActiveSummary = event.target.dataset.calendarSummary;
                            
                            // æœ€å°é™è¿½åŠ ï¼šæœ€çµ‚è¨±å¯ãƒã‚§ãƒƒã‚¯
                            if (!isCalendarAllowed(newActiveId)) {
                                displayError('é¸æŠã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                                return;
                            }
                            
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, newActiveId);
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, newActiveSummary);

                            currentCalendarId = newActiveId;
                            currentCalendarSummary = newActiveSummary;
                            updateDisplayedCalendarInfo(); 
                            console.log(`âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒé¸æŠãƒ»ä¿å­˜ã•ã‚Œã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                            listEvents(); 
                            
                            document.getElementById('settings_panel').classList.remove('open'); 
                        };
                    });
                } else {
                    writableCalendarListUl.innerHTML = '<li>è¨±å¯ã•ã‚ŒãŸæ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>';
                    console.log(`â„¹ï¸ è¨±å¯ã•ã‚ŒãŸæ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                }
            } catch (err) {
                console.error('âŒ æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function updateDisplayedCalendarInfo() {
            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
            const mainSummaryElement = document.getElementById('display_calendar_summary');
            if (mainSummaryElement) {
                mainSummaryElement.textContent = currentCalendarSummary;
            }
            // ãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
            const topSummaryElement = document.getElementById('display_calendar_summary_top');
            if (topSummaryElement) {
                topSummaryElement.textContent = currentCalendarSummary;
            }

            console.log(`â„¹ï¸ è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${currentCalendarSummary}`);
        }

        function updateCurrentDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedDate = now.toLocaleDateString('ja-JP', dateOptions);
            const formattedTime = now.toLocaleTimeString('ja-JP', timeOptions);
            document.getElementById('current_datetime').textContent = `${formattedDate} ${formattedTime}`;
        }

        function startAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId); 
            }
            // appSettingsã‹ã‚‰æ›´æ–°é–“éš”ã‚’å–å¾— (ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›)
            refreshIntervalId = setInterval(listEvents, appSettings.refreshInterval * 1000);
            console.log(`--- è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ: ${appSettings.refreshInterval}ç§’é–“éš” ---`);
        }

        async function listEvents() {
            const eventListUl = document.getElementById('event_list');
            displayError(''); 

            // æœ€å°é™è¿½åŠ ï¼šç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã®è¨±å¯ãƒã‚§ãƒƒã‚¯
            if (!isCalendarAllowed(currentCalendarId)) {
                console.error(`âŒ ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${currentCalendarId}) ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚`);
                displayError('ç¾åœ¨é¸æŠä¸­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šã‹ã‚‰åˆ¥ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                eventListUl.innerHTML = '<li class="error-message">è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹æœŸé™åˆ‡ã‚Œã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚</li>';
                return;
            }

            const now = new Date();
            // ä»¥å‰ã®å›ºå®šå€¤ (2æ™‚é–“å‰, 12æ™‚é–“å¾Œ) ã‚’è¨­å®šå€¤ã§ç½®ãæ›ãˆ
            const timeMin = new Date(now.getTime() - (appSettings.displayPastHours * 60 * 60 * 1000)).toISOString(); 
            const timeMax = new Date(now.getTime() + (appSettings.displayFutureHours * 60 * 60 * 1000)).toISOString(); 

            console.log(`--- listEvents: ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚’è©¦ã¿ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${currentCalendarId}, æœŸé–“: ${timeMin} ã‹ã‚‰ ${timeMax} ---`);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId,
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime', 
                    'maxResults': 20
                });

                let events = response.result.items;
                // --- ç¾åœ¨é€²è¡Œä¸­ã¾ãŸã¯æ¬¡ã«é–‹å§‹ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…ˆé ­ã«ç§»å‹•ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ ---
                if (events && events.length > 0) {
                    const currentTime = new Date(); 
                    events.sort((a, b) => {
                        const startA = new Date(a.start.dateTime || a.start.date);
                        const endA = new Date(a.end.dateTime || a.end.date);
                        const startB = new Date(b.start.dateTime || b.start.date);
                        const endB = new Date(b.end.dateTime || b.end.date);

                        const aIsCurrent = (currentTime >= startA && currentTime < endA);
                        const bIsCurrent = (currentTime >= startB && currentTime < endB);

                        const aStartsSoon = (startA > currentTime && (startA.getTime() - currentTime.getTime()) <= (appSettings.preAnnouncementMinutes * 60 * 1000));
                        const bStartsSoon = (startB > currentTime && (startB.getTime() - currentTime.getTime()) <= (appSettings.preAnnouncementMinutes * 60 * 1000));

                        // 1. ç¾åœ¨é€²è¡Œä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæœ€å„ªå…ˆ
                        if (aIsCurrent && !bIsCurrent) return -1; 
                        if (!aIsCurrent && bIsCurrent) return 1;  

                        // 2. æ¬¡ã«é–‹å§‹ã™ã‚‹ï¼ˆäºˆç´„å‰æ¡ˆå†…æœŸé–“å†…ï¼‰ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¬¡ã«å„ªå…ˆ
                        if (aStartsSoon && !bStartsSoon) return -1;
                        if (!aStartsSoon && bStartsSoon) return 1;

                        // 3. ãã‚Œä»¥å¤–ã¯é–‹å§‹æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
                        return startA.getTime() - startB.getTime();
                    });
                }
                // --- ä¸¦ã³æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ ---

                // å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‹ã‚‰æ¯”è¼ƒã«å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿ã‚’æŠ½å‡ºã—ã€JSONæ–‡å­—åˆ—åŒ–
                const eventsForComparison = events.map(event => ({
                    id: event.id,
                    summary: event.summary,
                    start: event.start,
                    end: event.end
                }));
                const newEventsString = JSON.stringify(eventsForComparison); 

                // å‰å›å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã¦ã€å¤‰åŒ–ãŒãªã‘ã‚Œã°DOMæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (newEventsString === lastFetchedEventsString && eventListUl.children.length > 0 && !eventListUl.innerHTML.includes("ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­")) {
                    console.log('â„¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã«å¤‰åŒ–ãŒãªã„ãŸã‚ã€DOMæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã ã‘ã¯æ™‚åˆ»å¤‰åŒ–ã§æ›´æ–°ã™ã‚‹ãŸã‚åˆ¥é€”å‡¦ç†
                    updateEventHighlightsAndAnnouncement(events); // å…ƒã®eventsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
                    return; 
                }

                lastFetchedEventsString = newEventsString; // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                appSettings.lastEvents = events; // æ¡ˆå†…æ–‡è¡¨ç¤ºã®ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’appSettingsã«ä¿å­˜
                saveSettings(); // appSettingsã®å¤‰æ›´ã‚’ä¿å­˜

                eventListUl.innerHTML = ''; // æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = new Date(event.start.dateTime || event.start.date);
                        const end = new Date(event.end.dateTime || event.end.date);

                        const startDate = start.toLocaleDateString('ja-JP');
                        const startTime = start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = end.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        let eventDetailsHtml;

                        if (event.start.date && !event.start.dateTime) { 
                             eventDetailsHtml = `
                                 <div class="event-details">
                                     <span class="event-time">${startDate} (çµ‚æ—¥)</span>
                                     <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                 </div>
                             `;
                        } else {
                            eventDetailsHtml = `
                                 <div class="event-details">
                                     <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                     <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                 </div>
                             `;
                        }
                        
                        li.innerHTML = eventDetailsHtml + `<button class="event-delete-button" data-event-id="${event.id}">å‰Šé™¤</button>`;
                        eventListUl.appendChild(li);
                    });
                    console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ (${currentCalendarSummary}):`, events);

                    document.querySelectorAll('.event-delete-button').forEach(button => {
                        button.onclick = (event) => {
                            const eventIdToDelete = event.target.dataset.eventId;
                            handleDeleteEvent(eventIdToDelete); 
                        };
                    });

                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = 'æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                    eventListUl.appendChild(li);
                    console.log(`â„¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (${currentCalendarSummary})ã€‚`);
                }

                updateEventHighlightsAndAnnouncement(events); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆå†ç”Ÿæˆå¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã‚’æ›´æ–°
                updateActionButtonStates(); // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°

            } catch (err) {
                console.error(`âŒ ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼ (${currentCalendarId}):`, err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                eventListUl.innerHTML = '<li class="error-message">ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
                updateActionButtonStates(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã ã‘ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateEventHighlightsAndAnnouncement(events) {
            const now = new Date();
            let currentEventFound = false;
            let currentEventSummary = '';
            let preAnnouncementFound = false; 
            let preAnnouncementSummary = ''; 

            // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤
            document.querySelectorAll('.event-item').forEach(item => {
                item.classList.remove('current-event');
            });

            // æœ€ã‚‚è¿‘ã„æœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®å¤‰æ•°
            let closestUpcomingEvent = null;
            let minTimeUntilStart = Infinity;

            events.forEach((event, index) => {
                const start = new Date(event.start.dateTime || event.start.date);
                const end = new Date(event.end.dateTime || event.end.date);
                
                // ç¾åœ¨é€²è¡Œä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ¤å®š
                if (now >= start && now < end) {
                    const liElement = document.querySelector(`#event_list li:nth-child(${index + 1})`);
                    if (liElement) {
                        liElement.classList.add('current-event');
                    }
                    currentEventFound = true;
                    currentEventSummary = event.summary || 'åç§°æœªè¨­å®šã®ä¼šè­°';
                }
                
                // ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šæœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸­ã§æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’æ¢ã™
                if (now < start) {
                    const timeUntilStart = start.getTime() - now.getTime(); // ãƒŸãƒªç§’å˜ä½
                    if (timeUntilStart > 0 && timeUntilStart <= (appSettings.preAnnouncementMinutes * 60 * 1000)) { 
                        minTimeUntilStart = timeUntilStart;
                        closestUpcomingEvent = event;
                    }
                }
            });

            // äºˆç´„å‰æ¡ˆå†…ã®è¡¨ç¤ºæ›´æ–°
            const preAnnouncementTextElement = document.getElementById('pre_announcement_text');
            if (closestUpcomingEvent) {
                const timeUntilClosestStart = closestUpcomingEvent.start.dateTime ? new Date(closestUpcomingEvent.start.dateTime).getTime() - now.getTime() : Infinity;
                
                if (timeUntilClosestStart > 0 && timeUntilClosestStart <= (appSettings.preAnnouncementMinutes * 60 * 1000)) {
                    preAnnouncementFound = true;
                    preAnnouncementSummary = closestUpcomingEvent.summary || 'åç§°æœªè¨­å®šã®ä¼šè­°';
                }
            }
            
            if (preAnnouncementFound) {
                preAnnouncementTextElement.textContent = `${appSettings.preAnnouncementPrefix}ã€Œ${preAnnouncementSummary}ã€${appSettings.preAnnouncementSuffix}`;
                preAnnouncementTextElement.style.display = 'block';
            } else {
                // äºˆç´„å‰æ¡ˆå†…ã™ã¹ãã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆ
                preAnnouncementTextElement.textContent = appSettings.preAnnouncementDefaultText; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡è¨€
                preAnnouncementTextElement.style.display = 'block'; // å¸¸ã«è¡¨ç¤º
            }

            // ç¾åœ¨ã®æ¡ˆå†…æ–‡ï¼ˆä½¿ç”¨ä¸­ or ç©ºå®¤ï¼‰ã®è¡¨ç¤ºæ›´æ–°
            const announcementTextElement = document.getElementById('announcement_text');
            if (currentEventFound) {
                announcementTextElement.textContent = `${appSettings.inProgressPrefix}ã€Œ${currentEventSummary}ã€${appSettings.inProgressSuffix}`;
                announcementTextElement.classList.remove('available'); 
                announcementTextElement.style.display = 'block';
            } else { // é€²è¡Œä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆ
                announcementTextElement.textContent = appSettings.availableText;
                announcementTextElement.classList.add('available'); 
                announcementTextElement.style.display = 'block'; 
            }
        }

        // äºˆç´„ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function updateActionButtonStates() {
            const add30Button = document.getElementById('add_30min_event_button');
            const add60Button = document.getElementById('add_60min_event_button');
            const deleteButtons = document.querySelectorAll('.event-delete-button');

            // æœ€å°é™è¿½åŠ ï¼šè¨±å¯ãƒã‚§ãƒƒã‚¯ã‚‚å«ã‚ã‚‹
            const isCurrentCalendarAllowed = isCalendarAllowed(currentCalendarId);
            const canPerformOperations = isAuthorizedForWrite && isCurrentCalendarAllowed;

            // èªè¨¼çŠ¶æ…‹ã¨è¨±å¯çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
            add30Button.disabled = !canPerformOperations;
            add60Button.disabled = !canPerformOperations;

            deleteButtons.forEach(button => {
                button.disabled = !canPerformOperations;
            });

            console.log(`â„¹ï¸ æ“ä½œãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚èªè¨¼æ¸ˆã¿: ${isAuthorizedForWrite}, ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨±å¯: ${isCurrentCalendarAllowed}`);
        }

        async function handleAddEvent(durationMinutes) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ : æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return;
            }

            // æœ€å°é™è¿½åŠ ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDè¨±å¯ãƒã‚§ãƒƒã‚¯
            if (!isCalendarAllowed(currentCalendarId)) {
                displayError('ç¾åœ¨é¸æŠä¸­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šã‹ã‚‰åˆ¥ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                console.log(`ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ : ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${currentCalendarId}) ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹æœŸé™åˆ‡ã‚Œã§ã™ã€‚`);
                return;
            }

            console.log(`âœ… ${durationMinutes}åˆ†é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚`);
            const now = new Date();
            const eventEndTime = new Date(now.getTime() + (durationMinutes * 60 * 1000)); 

            const event = {
                'summary': `${appSettings.eventSummary} (${durationMinutes}åˆ†)`, 
                'location': 'ä¼šè­°å®¤', 
                'description': '', // ã‚¤ãƒ™ãƒ³ãƒˆèª¬æ˜ã¯ç©ºã«
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': eventEndTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': true
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': currentCalendarId, 
                    'resource': event
                });
                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ:', response.result);
                listEvents(); 
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        async function handleDeleteEvent(eventIdToDelete) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤: æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return;
            }

            // æœ€å°é™è¿½åŠ ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDè¨±å¯ãƒã‚§ãƒƒã‚¯
            if (!isCalendarAllowed(currentCalendarId)) {
                displayError('ç¾åœ¨é¸æŠä¸­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šã‹ã‚‰åˆ¥ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                console.log(`ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (${currentCalendarId}) ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹æœŸé™åˆ‡ã‚Œã§ã™ã€‚`);
                return;
            }

            console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆ (ID: ${eventIdToDelete}) ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`);
            try {
                await gapi.client.calendar.events.delete({
                    'calendarId': currentCalendarId, 
                    'eventId': eventIdToDelete
                });
                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                listEvents(); 
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `ã‚¨ãƒ©ãƒ¼: ${msg}` : '';
            if (msg) console.error("è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:", msg);
        }
    </script>
</body>
</html>
[cite_start]``` [cite: 1]
