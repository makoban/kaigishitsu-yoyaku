<!DOCTYPE html>
<html>
<head>
    <title>Google カレンダーリスト表示</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        #authorize_button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4285f4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #authorize_button:hover {
            background-color: #357ae8;
        }
        #authorize_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #calendar_list_container {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #calendar_list_container ul {
            list-style-type: disc; /* リストの先頭に点を表示 */
            padding-left: 25px;
        }
        #calendar_list_container li {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #555;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Google カレンダーリスト表示</h1>

    <p>以下のボタンをクリックしてGoogleアカウントを選択し、利用可能なカレンダーを表示します。</p>
    <button id="authorize_button" disabled>Googleアカウントを選択</button>

    <div id="calendar_list_container">
        <h2>利用可能なカレンダー</h2>
        <ul id="calendar_list">
            <li>ボタンをクリックして認証を開始してください。</li>
        </ul>
        <p id="error_display" class="error-message"></p>
    </div>

    <script>
        // ★★★ ここをあなたの情報に置き換えてください ★★★
        const CLIENT_ID = 'あなたのOAuth 2.0 クライアントID'; // 例: 123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
        const API_KEY = 'あなたのAPIキー';           // 例: AIzaSyB_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        // ★★★ ここまで ★★★

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly'; // カレンダーの読み取り専用スコープ

        let tokenClient; // Google Identity Services (GIS) のトークンクライアント

        // HTMLコンテンツの読み込みが完了したら初期化処理を開始
        document.addEventListener('DOMContentLoaded', () => {
            const authorizeButton = document.getElementById('authorize_button');
            authorizeButton.onclick = handleAuthClick; // ボタンクリック時のイベントを設定

            // gapiクライアントライブラリのロードと初期化
            gapi.load('client', initGapiClient);
        });

        // gapiクライアントの初期化関数
        function initGapiClient() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('gapi client initialized.');

                // GISトークンクライアントの初期化 (OAuth 2.0認証フローを管理)
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    // アクセストークン取得後のコールバック関数
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse); // 取得したトークンをgapiクライアントに設定
                            console.log('アクセストークンを取得しました:', tokenResponse);
                            displayMessage('カレンダーリストを読み込み中...');
                            listCalendars(); // カレンダーリストの取得と表示を開始
                        } else {
                            console.error('アクセストークンの取得に失敗しました。', tokenResponse);
                            displayError('Googleアカウントの認証に失敗しました。再度お試しください。');
                        }
                    },
                    // エラー発生時のコールバック関数
                    error_callback: (error) => {
                        console.error('GISトークンクライアントエラー:', error);
                        displayError('認証エラーが発生しました。コンソールを確認してください。');
                    }
                    // ★ `Cross-Origin-Opener-Policy` エラーが続く場合は、
                    // ★ 以下のどちらか、または両方を試してください。
                    // ux_mode: 'redirect', // ポップアップではなくリダイレクトを使用
                    // redirect_uri: 'https://makoban.github.io' // OAuth設定の承認済みリダイレクトURIと一致させる
                });

                // 認証ボタンを有効にする
                document.getElementById('authorize_button').disabled = false;

            }).catch(err => {
                console.error('gapiクライアントの初期化エラー:', err);
                displayError('APIクライアントの初期化に失敗しました。APIキーまたはネットワーク接続を確認してください。');
            });
        }

        // 認証ボタンクリック時の処理
        function handleAuthClick() {
            if (tokenClient) {
                tokenClient.requestAccessToken(); // アクセストークンを要求して認証フローを開始
            } else {
                console.error('トークンクライアントが初期化されていません。');
                displayError('認証クライアントが準備できていません。ページをリロードしてください。');
            }
        }

        // カレンダーリストを取得して表示する関数
        async function listCalendars() {
            const calendarListUl = document.getElementById('calendar_list');
            const errorDisplay = document.getElementById('error_display');
            calendarListUl.innerHTML = ''; // 既存のリストをクリア
            errorDisplay.textContent = ''; // エラーメッセージをクリア

            try {
                // Google Calendar API からカレンダーリストを取得
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items;

                if (calendars && calendars.length > 0) {
                    calendars.forEach(calendar => {
                        const li = document.createElement('li');
                        li.textContent = `ID: ${calendar.id} - サマリー: ${calendar.summary}`;
                        if (calendar.accessRole === 'owner') {
                            li.textContent += ' (オーナー)';
                        } else {
                            li.textContent += ` (アクセス権: ${calendar.accessRole})`;
                        }
                        calendarListUl.appendChild(li);
                    });
                    console.log('カレンダーリストを正常に表示しました:', calendars);
                    displayMessage('カレンダーリストの表示が完了しました。');
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'Googleアカウントに紐づくカレンダーが見つかりませんでした。';
                    calendarListUl.appendChild(li);
                    console.log('カレンダーが見つかりませんでした。');
                    displayMessage('カレンダーが見つかりませんでした。');
                }
            } catch (err) {
                console.error('カレンダーリストの取得エラー:', err.result ? err.result.error : err);
                const errorMessage = `カレンダーの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`;
                calendarListUl.innerHTML = `<li>${errorMessage}</li>`;
                displayError(errorMessage);
            }
        }

        // メッセージを表示するヘルパー関数
        function displayMessage(msg) {
            const calendarListUl = document.getElementById('calendar_list');
            // 一時的なメッセージ表示用なので、リストが空の場合のみ追加
            if (calendarListUl.children.length === 0 || calendarListUl.children[0].textContent.includes('ボタンをクリック')) {
                 calendarListUl.innerHTML = `<li>${msg}</li>`;
            }
            console.log("メッセージ:", msg);
        }

        // エラーメッセージを表示するヘルパー関数
        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = `エラー: ${msg}`;
            console.error("表示エラー:", msg);
        }
    </script>
</body>
</html>
