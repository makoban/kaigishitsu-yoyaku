<!DOCTYPE html>
<html>
<head>
    <title>ä¼šè­°å®¤äºˆç´„è¡¨ç¤ºï¼ˆã‚°ãƒ¼ã‚°ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼‰</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        #auth_section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9f5ff;
            border: 1px solid #cce5ff;
            border-radius: 8px;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        #authorize_button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4285f4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #authorize_button:hover {
            background-color: #357ae8;
        }
        #authorize_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #container {
            display: flex;
            gap: 20px;
            margin-top: 0px;
        }
        .panel {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel ul {
            list-style-type: none;
            padding: 0;
        }
        .panel li {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .panel li:last-child {
            border-bottom: none;
        }
        .select-button {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .select-button:hover {
            background-color: #218838;
        }
        .action-button {
            padding: 8px 15px;
            font-size: 16px;
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 15px;
        }
        .event-item {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .event-time {
            font-weight: bold;
            color: #0056b3;
            margin-right: 10px;
        }
        .event-summary {
            color: #333;
        }
        .no-events {
            font-style: italic;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>ä¼šè­°å®¤äºˆç´„è¡¨ç¤º</h1>

    <div id="auth_section">
        <p id="auth_status" style="color: blue;">æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚</p>
        <button id="authorize_button">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼</button>
        <p style="font-size: 0.9em; color: #555; margin-top: 10px;">
            â€»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆã€ç·Šæ€¥ä¼šè­°ã€å‰Šé™¤æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹éš›ã«èªè¨¼ãŒå¿…è¦ã§ã™ã€‚
        </p>
        <div id="calendar_selection_panel" style="margin-top: 20px; display: none;">
            <h2>è¡¨ç¤ºãƒ»æ“ä½œã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ</h2>
            <ul id="writable_calendar_list">
                <li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
            </ul>
        </div>
    </div>

    <div id="container">
        <div id="event_list_container" class="panel" style="flex: auto;">
            <h2>ä¼šè­°å®¤ã®äºˆå®š</h2>
            <p id="selected_calendar_info">ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: <span id="display_calendar_summary">åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span> (<span id="display_calendar_id_text"></span>)</p>
            <ul id="event_list">
                <li>ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
            </ul>
            <div style="margin-top: 20px;">
                <button id="add_event_button" class="action-button">ç·Šæ€¥ä¼šè­° (30åˆ†)</button>
                <button id="delete_event_button" class="action-button">æœ€æ–°ã®äºˆå®šã‚’å‰Šé™¤</button>
                <button id="refresh_button" class="action-button">æ›´æ–°</button>
            </div>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // â˜…â˜…â˜… ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';             // ä¾‹: AIzaSyB_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        // åˆæœŸè¡¨ç¤ºç”¨ã®å…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã€‚ã‚µã‚¤ãƒãƒ¼ã‚¸è¨­ç½®åˆæœŸã‚„ãƒˆãƒ©ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ç”¨ã€‚
        const INITIAL_PUBLIC_CALENDAR_ID = 'kaigishitsu20000101@gmail.com'; // ä¾‹: test_room_id@group.calendar.google.com
                                                                        // ã¾ãŸã¯ä¸€èˆ¬çš„ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID (å…¬é–‹è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®)
        // æ›¸ãè¾¼ã¿æ“ä½œã®ãŸã‚ã«å¿…è¦ã¨ãªã‚‹OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; // ä¾‹: 123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        // é–²è¦§æ™‚ã¯ä¸è¦ã€‚æ›¸ãè¾¼ã¿æ“ä½œæ™‚ã«å¿…è¦ã¨ãªã‚‹ã‚¹ã‚³ãƒ¼ãƒ—
        const WRITE_SCOPES = 'https://www.googleapis.com/auth/calendar.events'; // ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿æ›¸ãæ¨©é™

        const LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY = 'activeCalendarId';
        const LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY = 'activeCalendarSummary';

        let tokenClient; // Google Identity Services (GIS) ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (æ›¸ãè¾¼ã¿æ“ä½œç”¨)
        let isAuthorizedForWrite = false; // æ›¸ãè¾¼ã¿æ¨©é™ãŒèªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        let currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; // ç¾åœ¨è¡¨ç¤ºãƒ»æ“ä½œã—ã¦ã„ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID
        let currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"; // ç¾åœ¨è¡¨ç¤ºãƒ»æ“ä½œã—ã¦ã„ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚µãƒãƒªãƒ¼

        // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰åˆæœŸåŒ–å‡¦ç†ã‚’é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            // ç¾åœ¨ã®è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°
            document.getElementById('display_calendar_id_text').textContent = currentCalendarId;
            document.getElementById('display_calendar_summary').textContent = currentCalendarSummary;
            
            // UIä¸Šã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('add_event_button').onclick = handleActionTrigger;
            document.getElementById('delete_event_button').onclick = handleActionTrigger;
            document.getElementById('refresh_button').onclick = listEvents;

            // gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰ã¨åˆæœŸåŒ–ï¼ˆAPIã‚­ãƒ¼ã®ã¿ï¼‰
            gapi.load('client', initGapiClientForRead);
        });

        // é–²è¦§ï¼ˆèª­ã¿è¾¼ã¿ï¼‰å°‚ç”¨ã®gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        function initGapiClientForRead() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('âœ… gapi client initialized for read-only access (API Key only).');
                
                // localStorageã«ä¿å­˜ã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
                const savedActiveId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY);
                const savedActiveSummary = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY);

                if (savedActiveId && savedActiveSummary) {
                    currentCalendarId = savedActiveId;
                    currentCalendarSummary = savedActiveSummary;
                    console.log(`â„¹ï¸ localStorageã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                } else {
                    console.log(`â„¹ï¸ localStorageã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (${INITIAL_PUBLIC_CALENDAR_ID}) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                    // åˆå›è¡¨ç¤ºæ™‚ã®ã‚µãƒãƒªãƒ¼ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹ï¼ˆå¿…è¦ã§ã‚ã‚Œã°APIã§å–å¾—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ï¼‰
                    // ç¾çŠ¶ã¯'åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼'ã¨ã„ã†å›ºå®šæ–‡å­—åˆ—ã‚’ä½¿ç”¨
                }
                updateDisplayedCalendarInfo(); // è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°

                listEvents(); // ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•è¡¨ç¤º

                // æ›¸ãè¾¼ã¿æ“ä½œã®ãŸã‚ã«OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆãŸã ã—èªè¨¼ã¯ä¿ç•™ï¼‰
                initGisClientForWrite();

            }).catch(err => {
                console.error('âŒ gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆèª­ã¿è¾¼ã¿ç”¨ï¼‰:', err);
                displayError('ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }

        // æ›¸ãè¾¼ã¿æ“ä½œã®ãŸã‚ã®GISã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        function initGisClientForWrite() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: WRITE_SCOPES,
                callback: (tokenResponse) => {
                    console.log('--- tokenClient callback executed for write scope ---');
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        isAuthorizedForWrite = true;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'green';
                        document.getElementById('authorize_button').style.display = 'none'; // èªè¨¼å¾Œãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«
                        document.getElementById('calendar_selection_panel').style.display = 'block'; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                        console.log('âœ… æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
                        listWritableCalendars(); // èªè¨¼ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                    } else {
                        isAuthorizedForWrite = false;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'red';
                        document.getElementById('authorize_button').style.display = 'block'; // å¤±æ•—ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                        document.getElementById('calendar_selection_panel').style.display = 'none'; // èªè¨¼å¤±æ•—æ™‚ã¯éš ã™
                        console.error('âŒ æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', tokenResponse);
                    }
                },
                error_callback: (error) => {
                    isAuthorizedForWrite = false;
                    document.getElementById('auth_status').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    document.getElementById('auth_status').style.color = 'red';
                    document.getElementById('authorize_button').style.display = 'block'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('calendar_selection_panel').style.display = 'none'; // èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã¯éš ã™
                    console.error('âŒ GISãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ï¼ˆæ›¸ãè¾¼ã¿ç”¨ï¼‰:', error);
                }
            });
            // èªè¨¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯initGisClientForWriteå†…ã§è¨­å®š
            document.getElementById('authorize_button').onclick = () => {
                console.log('--- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼ˆæ“ä½œç”¨ï¼‰ã€‚---');
                tokenClient.requestAccessToken({ prompt: 'consent' }); // åˆå›ã¯åŒæ„ã‚’æ±‚ã‚ã‚‹
            };
        }

        // æ“ä½œãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ ãƒ»å‰Šé™¤ï¼‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸéš›ã®å…±é€šãƒãƒ³ãƒ‰ãƒ©
        function handleActionTrigger(event) {
            // ã¾ãšèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
            document.getElementById('auth_section').style.display = 'block';

            if (!isAuthorizedForWrite) {
                document.getElementById('auth_status').textContent = 'æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚';
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block'; // èªè¨¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('calendar_selection_panel').style.display = 'none'; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠãƒ‘ãƒãƒ«ã¯éš ã™
                console.log('ğŸš¨ æ“ä½œãƒˆãƒªã‚¬ãƒ¼: æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return; // èªè¨¼ãŒæ¸ˆã‚€ã¾ã§æ“ä½œã¯å®Ÿè¡Œã—ãªã„
            }

            // èªè¨¼æ¸ˆã¿ã§ã‚ã‚Œã°ã€ã©ã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‹ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
            if (event.target.id === 'add_event_button') {
                handleAddEvent();
            } else if (event.target.id === 'delete_event_button') {
                handleDeleteEvent();
            }
        }

        // èªè¨¼ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        async function listWritableCalendars() {
            const writableCalendarListUl = document.getElementById('writable_calendar_list');
            writableCalendarListUl.innerHTML = '<li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>';
            displayError('');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;
                // ã‚ªãƒ¼ãƒŠãƒ¼ã¾ãŸã¯æ›¸ãè¾¼ã¿æ¨©é™ã®ã‚ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const writableCalendars = allCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );

                if (writableCalendars && writableCalendars.length > 0) {
                    writableCalendarListUl.innerHTML = ''; // ã‚¯ãƒªã‚¢
                    writableCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${calendar.summary}</span>
                            <button class="select-button" 
                                data-calendar-id="${calendar.id}" 
                                data-calendar-summary="${calendar.summary}">è¡¨ç¤ºãƒ»æ“ä½œ</button>
                        `;
                        writableCalendarListUl.appendChild(li);
                    });
                    console.log('âœ… æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ:', writableCalendars);

                    // å„ã€Œè¡¨ç¤ºãƒ»æ“ä½œã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    document.querySelectorAll('#writable_calendar_list .select-button').forEach(button => {
                        button.onclick = (event) => {
                            const newActiveId = event.target.dataset.calendarId;
                            const newActiveSummary = event.target.dataset.dataset.calendarSummary;
                            
                            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’localStorageã«ä¿å­˜
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, newActiveId);
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, newActiveSummary);

                            currentCalendarId = newActiveId;
                            currentCalendarSummary = newActiveSummary;
                            updateDisplayedCalendarInfo(); // è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°
                            console.log('âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒé¸æŠãƒ»ä¿å­˜ã•ã‚Œã¾ã—ãŸ:', currentCalendarSummary, currentCalendarId);
                            listEvents(); // æ–°ã—ã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å†è¡¨ç¤º
                            // èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éš ã™ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
                            document.getElementById('auth_section').style.display = 'none';
                        };
                    });
                } else {
                    writableCalendarListUl.innerHTML = '<li>æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>';
                    console.log('â„¹ï¸ æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (err) {
                console.error('âŒ æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’UIã«åæ˜ ã™ã‚‹é–¢æ•°
        function updateDisplayedCalendarInfo() {
            document.getElementById('display_calendar_id_text').textContent = currentCalendarId;
            document.getElementById('display_calendar_summary').textContent = currentCalendarSummary;
        }

        async function listEvents() {
            const eventListUl = document.getElementById('event_list');
            eventListUl.innerHTML = ''; // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            displayError(''); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢

            // ç¾åœ¨æ™‚åˆ»ã‚’åŸºæº–ã«ã€å‰2æ™‚é–“ã¨å¾Œ12æ™‚é–“ã®æœŸé–“ã‚’è¨­å®š
            const now = new Date();
            const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString(); // 2æ™‚é–“å‰
            const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString(); // 12æ™‚é–“å¾Œ

            console.log(`ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚’è©¦ã¿ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${currentCalendarId}, æœŸé–“: ${timeMin} ã‹ã‚‰ ${timeMax}`);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId, // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’ä½¿ç”¨
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 20
                });

                const events = response.result.items;

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = event.start.dateTime || event.start.date;
                        const end = event.end.dateTime || event.end.date;

                        // é–‹å§‹æ—¥æ™‚ã¨çµ‚äº†æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        const startDate = new Date(start).toLocaleDateString('ja-JP');
                        const startTime = new Date(start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = new Date(end).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        // å…¨æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®è¡¨ç¤ºèª¿æ•´
                        if (event.start.date && !event.start.dateTime) { // å…¨æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
                             li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} (çµ‚æ—¥)</span>
                                    <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                </div>
                            `;
                        } else {
                            li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                    <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                </div>
                            `;
                        }
                        eventListUl.appendChild(li);
                    });
                    console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ (${currentCalendarId}):`, events);
                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = 'æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                    eventListUl.appendChild(li);
                    console.log(`â„¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (${currentCalendarId})ã€‚`);
                }
            } catch (err) {
                console.error(`âŒ ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼ (${currentCalendarId}):`, err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                const li = document.createElement('li');
                li.className = 'error-message';
                li.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                eventListUl.appendChild(li);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã®ãƒãƒ³ãƒ‰ãƒ© (èªè¨¼ãŒå¿…è¦)
        async function handleAddEvent() {
            // handleActionTriggerã§èªè¨¼æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚');
            const now = new Date();
            const eventEndTime = new Date(now.getTime() + (30 * 60 * 1000)); // 30åˆ†å¾Œ

            const event = {
                'summary': 'ç·Šæ€¥ä¼šè­° (30åˆ†)',
                'location': 'ä¼šè­°å®¤', // å¿…è¦ã«å¿œã˜ã¦å…·ä½“çš„ãªå ´æ‰€ã‚’è¨­å®š
                'description': 'ç·Šæ€¥ã®ä¼šè­°ã§ã™ã€‚',
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': eventEndTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': true
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': currentCalendarId, // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    'resource': event
                });
                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ:', response.result);
                alert('ç·Šæ€¥ä¼šè­°ãŒ30åˆ†é–“äºˆç´„ã•ã‚Œã¾ã—ãŸï¼');
                listEvents(); // è¿½åŠ å¾Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        // æœ€æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ã®ãƒãƒ³ãƒ‰ãƒ© (èªè¨¼ãŒå¿…è¦)
        async function handleDeleteEvent() {
            // handleActionTriggerã§èªè¨¼æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            console.log('âœ… æœ€æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚');
            try {
                // ã¾ãšç¾åœ¨ã®æœŸé–“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—
                const now = new Date();
                const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString();
                const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString();

                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId, // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‹ã‚‰å–å¾—
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 1 // æœ€æ–°ã®1ä»¶ã®ã¿å–å¾—
                });

                const events = response.result.items;

                if (events && events.length > 0) {
                    const eventToDelete = events[0]; // æœ€æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                    console.log('å‰Šé™¤ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ:', eventToDelete);
                    if (confirm(`ã€Œ${eventToDelete.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                        await gapi.client.calendar.events.delete({
                            'calendarId': currentCalendarId, // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‹ã‚‰å‰Šé™¤
                            'eventId': eventToDelete.id
                        });
                        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                        alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                        listEvents(); // å‰Šé™¤å¾Œã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    }
                } else {
                    alert('æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«å‰Šé™¤ã§ãã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }


        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `ã‚¨ãƒ©ãƒ¼: ${msg}` : '';
            if (msg) console.error("è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:", msg);
        }
    </script>
</body>
</html>
