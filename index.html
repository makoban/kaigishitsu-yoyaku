<!DOCTYPE html>
<html>
<head>
    <title>ä¼šè­°å®¤äºˆç´„è¡¨ç¤º</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #28a745; /* Green */
            --accent-color: #6c757d; /* Gray */
            --text-color: #333;
            --light-text-color: #555;
            --background-color: #f8f9fa; /* Light Gray */
            --panel-bg-color: #ffffff;
            --border-color: #e0e0e0;
            --error-color: #dc3545; /* Red */
            --delete-button-color: #dc3545; /* Red for delete */
            --highlight-color: #ffeeb2; /* Highlight color for current event */
            --announcement-bg-color: #ffc107; /* Amber for announcement */
            --announcement-text-color: #333;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 2.2em;
        }

        /* Top Bar for Date/Time and Announcement */
        #top_bar {
            background-color: var(--panel-bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: var(--text-color);
        }
        #current_datetime {
            font-weight: bold;
            color: var(--primary-color);
        }
        #announcement_text {
            font-weight: bold;
            color: var(--announcement-text-color);
            background-color: var(--announcement-bg-color);
            padding: 8px 15px;
            border-radius: 5px;
            display: none; /* Initially hidden */
            margin-left: 20px;
        }

        /* Settings Button */
        #settings_button {
            padding: 10px 20px;
            font-size: 0.9em;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            position: fixed; /* ç”»é¢å³ä¸Šã«å›ºå®š */
            top: 20px;
            right: 20px;
            z-index: 101; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #settings_button:hover {
            background-color: #5a6268;
        }

        /* Settings Panel */
        #settings_panel {
            position: fixed; /* ç”»é¢å…¨ä½“ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* åŠé€æ˜ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
            display: flex;
            justify-content: flex-end; /* å³ç«¯ã«å¯„ã›ã‚‹ */
            z-index: 100;
            opacity: 0;
            pointer-events: none; /* éè¡¨ç¤ºæ™‚ã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹ã« */
            transition: opacity 0.3s ease-in-out;
        }
        #settings_panel.open {
            opacity: 1;
            pointer-events: auto;
        }
        #settings_content {
            background-color: var(--panel-bg-color);
            width: 450px; /* ãƒ‘ãƒãƒ«ã®å¹… */
            max-width: 90%;
            height: 100%;
            padding: 30px;
            box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transform: translateX(100%); /* åˆæœŸã¯ç”»é¢å¤–ã«éš ã™ */
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #settings_panel.open #settings_content {
            transform: translateX(0); /* ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º */
        }
        #close_settings_panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--accent-color);
            line-height: 1;
            padding: 5px;
        }
        #close_settings_panel:hover {
            color: var(--text-color);
        }

        /* Auth Section in Settings Panel */
        #auth_status {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9f5ff; /* Light Blue */
            border: 1px solid #cce5ff;
            border-radius: 8px;
            text-align: center;
            font-size: 0.95em;
            line-height: 1.4;
        }
        #authorize_button, #switch_account_button {
            padding: 12px 20px;
            font-size: 1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            margin-bottom: 10px;
        }
        #authorize_button:hover, #switch_account_button:hover {
            background-color: #357ae8;
        }
        #authorize_button:disabled, #switch_account_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #calendar_selection_panel {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px dashed var(--border-color);
            flex-grow: 1;
            overflow-y: auto;
        }
        #writable_calendar_list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        #writable_calendar_list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f7f7f7;
            font-size: 1.05em;
        }
        #writable_calendar_list li:last-child {
            border-bottom: none;
        }
        .select-button {
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .select-button:hover {
            background-color: #218838;
        }

        /* Main Content Area */
        #container {
            flex-grow: 1;
            display: flex;
            gap: 25px;
            position: relative; 
        }
        #event_list_container {
            flex: 1;
            padding: 30px;
            background-color: var(--panel-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        #selected_calendar_info {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #event_list {
            list-style: none;
            padding: 0;
        }
        #event_list li {
            background-color: #fdfdfd;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #event_list li:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        /* Highlight for current event */
        #event_list li.current-event {
            background-color: var(--highlight-color);
            border-color: #ffcc00;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .event-details {
            flex-grow: 1; 
        }
        .event-time {
            font-weight: 700; 
            color: var(--primary-color);
            font-size: 1.1em;
            margin-bottom: 5px;
            display: block;
        }
        .event-summary {
            color: var(--text-color);
            font-size: 1.05em;
            line-height: 1.4;
        }
        .no-events {
            font-style: italic;
            color: var(--light-text-color);
            text-align: center;
            padding: 30px;
        }

        /* Action Buttons */
        .action-button-group {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .action-button {
            padding: 12px 20px;
            font-size: 1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-grow: 1; 
            min-width: 120px;
        }
        .action-button:hover {
            background-color: #357ae8;
        }
        .action-button:active {
            transform: translateY(1px);
        }
        .error-message {
            color: var(--error-color);
            font-weight: 700;
            margin-top: 20px;
            text-align: center;
            font-size: 1.1em;
            background-color: #ffe0e0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--error-color);
        }
        /* New delete button for each event item */
        .event-delete-button {
            padding: 8px 12px;
            font-size: 0.9em;
            background-color: var(--delete-button-color); /* Red */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 15px; /* Space from event details */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .event-delete-button:hover {
            background-color: #c82333; /* Darker red */
        }
    </style>
</head>
<body>
    <header>
        <h1>ä¼šè­°å®¤äºˆç´„è¡¨ç¤º</h1>
        <button id="settings_button">è¨­å®š</button>
    </header>

    <div id="top_bar">
        <span id="current_datetime"></span>
        <span id="announcement_text"></span>
    </div>

    <div id="settings_panel">
        <div id="settings_content">
            <button id="close_settings_panel">&times;</button>
            <h2>è¨­å®š</h2>
            <hr>
            <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ</h3>
            <p id="auth_status" style="color: blue;">æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚</p>
            <button id="authorize_button">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼</button>
            <button id="switch_account_button" style="display:none;">åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼</button>
            <p style="font-size: 0.9em; color: var(--light-text-color); margin-top: 10px;">
                â€»ç·Šæ€¥ä¼šè­°ã€å‰Šé™¤ãªã©ã®ç®¡ç†è€…æ“ä½œã‚’åˆ©ç”¨ã™ã‚‹éš›ã«èªè¨¼ãŒå¿…è¦ã§ã™ã€‚<br>
                â€»èªè¨¼å¾Œã€è¡¨ç¤ºãƒ»æ“ä½œã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
            </p>
            <div id="calendar_selection_panel" style="display: none;">
                <h4>è¡¨ç¤ºãƒ»æ“ä½œã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é¸æŠ</h4>
                <ul id="writable_calendar_list">
                    <li>èªè¨¼å¾Œã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
                </ul>
            </div>
            <hr>
        </div>
    </div>

    <div id="container">
        <div id="event_list_container" class="panel">
            <h2>ç¾åœ¨ã®ä¼šè­°å®¤ã®äºˆå®š</h2>
            <p id="selected_calendar_info">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: <span id="display_calendar_summary"></span></p>
            <ul id="event_list">
                <li>ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
            </ul>
            <div class="action-button-group">
                <button id="add_30min_event_button" class="action-button">ç·Šæ€¥ä¼šè­° (30åˆ†)</button>
                <button id="add_60min_event_button" class="action-button">ç·Šæ€¥ä¼šè­° (60åˆ†)</button>
                <button id="refresh_button" class="action-button">æ›´æ–°</button>
            </div>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // â˜…â˜…â˜… ã“ã“ã‚’ã‚ãªãŸã®æƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';             
        const INITIAL_PUBLIC_CALENDAR_ID = 'kaigishitsu20000101@gmail.com'; 
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; 
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const WRITE_SCOPES = 'https://www.googleapis.com/auth/calendar.events'; 

        const LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY = 'activeCalendarId';
        const LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY = 'activeCalendarSummary';

        const AUTO_REFRESH_INTERVAL = 30 * 1000; // 30ç§’

        let tokenClient; 
        let isAuthorizedForWrite = false; 
        let currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
        let currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"; 
        let refreshIntervalId; 
        let lastFetchedEventsString = ""; // æœ€å¾Œã«å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã§ä¿æŒ

        document.addEventListener('DOMContentLoaded', () => {
            const settingsButton = document.getElementById('settings_button');
            const settingsPanel = document.getElementById('settings_panel');
            const closeSettingsPanelButton = document.getElementById('close_settings_panel');
            const authorizeButton = document.getElementById('authorize_button');
            const switchAccountButton = document.getElementById('switch_account_button'); 

            settingsButton.onclick = () => {
                settingsPanel.classList.toggle('open');
                if (settingsPanel.classList.contains('open') && isAuthorizedForWrite) {
                    listWritableCalendars(); 
                } else if (!settingsPanel.classList.contains('open')) {
                    displayError(''); 
                }
            };
            closeSettingsPanelButton.onclick = () => {
                settingsPanel.classList.remove('open');
                displayError(''); 
            };

            authorizeButton.onclick = () => {
                console.log('--- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼ˆæ“ä½œç”¨ï¼‰ã€‚èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚---');
                tokenClient.requestAccessToken({ prompt: 'consent', ux_mode: 'popup' }); 
            };

            switchAccountButton.onclick = () => { 
                console.log('--- åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠã‚’å¼·åˆ¶ã—ã¾ã™ã€‚---');
                tokenClient.requestAccessToken({ prompt: 'select_account', ux_mode: 'popup' }); 
            };

            document.getElementById('add_30min_event_button').onclick = () => handleAddEvent(30);
            document.getElementById('add_60min_event_button').onclick = () => handleAddEvent(60); 
            document.getElementById('refresh_button').onclick = listEvents;

            setInterval(updateCurrentDateTime, 1000);
            updateCurrentDateTime(); 

            console.log('--- DOMContentLoaded: gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ ---');
            gapi.load('client', initGapiClientForRead);
        });

        function initGapiClientForRead() {
            console.log('--- initGapiClientForRead: èª­ã¿è¾¼ã¿å°‚ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ä¸­ ---');
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('âœ… gapi client initialized for read-only access (API Key only).');
                
                console.log('--- initGapiClientForRead: localStorageã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿è©¦è¡Œ ---');
                const savedActiveId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY);
                const savedActiveSummary = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY);

                // localStorageã«ä¿å­˜ãŒã‚ã‚Œã°ã€ãã®IDãŒINITIAL_PUBLIC_CALENDAR_IDã¨åŒã˜ã§ã‚‚ãã‚Œã‚’å„ªå…ˆ
                if (savedActiveId && savedActiveSummary) { 
                    currentCalendarId = savedActiveId;
                    currentCalendarSummary = savedActiveSummary;
                    console.log(`âœ… localStorageã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                } else {
                    currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
                    currentCalendarSummary = "åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"; 
                    console.log(`â„¹ï¸ localStorageã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆæœŸè¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (${INITIAL_PUBLIC_CALENDAR_ID}) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                }
                updateDisplayedCalendarInfo();

                console.log(`--- initGapiClientForRead: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’é–‹å§‹ (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${currentCalendarId}) ---`);
                listEvents(); 
                startAutoRefresh(); 

                console.log('--- initGapiClientForRead: GISã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚’é–‹å§‹ï¼ˆæ›¸ãè¾¼ã¿æ“ä½œç”¨ï¼‰ ---');
                initGisClientForWrite();

            }).catch(err => {
                console.error('âŒ gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆèª­ã¿è¾¼ã¿ç”¨ï¼‰:', err);
                displayError('ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
        }

        function initGisClientForWrite() {
            console.log('--- initGisClientForWrite: GISã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ä¸­ ---');
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: WRITE_SCOPES,
                callback: (tokenResponse) => {
                    console.log('--- tokenClient callback executed for write scope ---');
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        isAuthorizedForWrite = true;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'green';
                        document.getElementById('authorize_button').style.display = 'none'; 
                        document.getElementById('switch_account_button').style.display = 'block'; 
                        document.getElementById('calendar_selection_panel').style.display = 'block'; 
                        console.log('âœ… æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
                        listWritableCalendars(); 
                    } else {
                        isAuthorizedForWrite = false;
                        document.getElementById('auth_status').textContent = 'æ“ä½œæ¨©é™ã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                        document.getElementById('auth_status').style.color = 'red';
                        document.getElementById('authorize_button').style.display = 'block'; 
                        document.getElementById('switch_account_button').style.display = 'none'; 
                        document.getElementById('calendar_selection_panel').style.display = 'none'; 
                        console.error('âŒ æ›¸ãè¾¼ã¿æ¨©é™ã®ãŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', tokenResponse);
                    }
                },
                error_callback: (error) => {
                    isAuthorizedForWrite = false;
                    document.getElementById('auth_status').textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    document.getElementById('auth_status').style.color = 'red';
                    document.getElementById('authorize_button').style.display = 'block'; 
                    document.getElementById('switch_account_button').style.display = 'none'; 
                    document.getElementById('calendar_selection_panel').style.display = 'none'; 
                    console.error('âŒ GISãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ï¼ˆæ›¸ãè¾¼ã¿ç”¨ï¼‰:', error);
                }
            });
        }

        function handleActionTrigger(event) {
            console.log('--- handleActionTrigger: æ“ä½œãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ ---');
            document.getElementById('settings_panel').classList.add('open'); 

            if (!isAuthorizedForWrite) {
                document.getElementById('auth_status').textContent = 'æ“ä½œã‚’è¡Œã†ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚';
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ æ“ä½œãƒˆãƒªã‚¬ãƒ¼: æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return; 
            }
        }

        async function listWritableCalendars() {
            const writableCalendarListUl = document.getElementById('writable_calendar_list');
            writableCalendarListUl.innerHTML = '<li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>';
            displayError('');
            console.log('--- listWritableCalendars: æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ä¸­ ---');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;
                const writableCalendars = allCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );

                if (writableCalendars && writableCalendars.length > 0) {
                    writableCalendarListUl.innerHTML = ''; 
                    writableCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        const isCurrent = (calendar.id === currentCalendarId) ? ' (ç¾åœ¨é¸æŠä¸­)' : '';
                        li.innerHTML = `
                            <span>${calendar.summary}${isCurrent}</span>
                            <button class="select-button" 
                                data-calendar-id="${calendar.id}" 
                                data-calendar-summary="${calendar.summary}">é¸æŠ</button>
                        `;
                        writableCalendarListUl.appendChild(li);
                    });
                    console.log('âœ… æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ:', writableCalendars);

                    document.querySelectorAll('#writable_calendar_list .select-button').forEach(button => {
                        button.onclick = (event) => {
                            console.log('--- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ ---');
                            const newActiveId = event.target.dataset.calendarId;
                            const newActiveSummary = event.target.dataset.calendarSummary;
                            
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, newActiveId);
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, newActiveSummary);

                            currentCalendarId = newActiveId;
                            currentCalendarSummary = newActiveSummary;
                            updateDisplayedCalendarInfo(); 
                            console.log(`âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒé¸æŠãƒ»ä¿å­˜ã•ã‚Œã¾ã—ãŸ: ${currentCalendarSummary} (${currentCalendarId})`);
                            listEvents(); 
                            
                            document.getElementById('settings_panel').classList.remove('open'); 
                        };
                    });
                } else {
                    writableCalendarListUl.innerHTML = '<li>æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>';
                    console.log('â„¹ï¸ æ›¸ãè¾¼ã¿å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (err) {
                console.error('âŒ æ›¸ãè¾¼ã¿å¯èƒ½ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function updateDisplayedCalendarInfo() {
            document.getElementById('display_calendar_summary').textContent = currentCalendarSummary;
            console.log(`â„¹ï¸ è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${currentCalendarSummary}`);
        }

        function updateCurrentDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedDate = now.toLocaleDateString('ja-JP', dateOptions);
            const formattedTime = now.toLocaleTimeString('ja-JP', timeOptions);
            document.getElementById('current_datetime').textContent = `${formattedDate} ${formattedTime}`;
        }

        function startAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId); 
            }
            refreshIntervalId = setInterval(listEvents, AUTO_REFRESH_INTERVAL);
            console.log(`--- è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ: ${AUTO_REFRESH_INTERVAL / 1000}ç§’é–“éš” ---`);
        }

        async function listEvents() {
            const eventListUl = document.getElementById('event_list');
            displayError(''); 

            const now = new Date();
            const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString(); 
            const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString(); 

            console.log(`--- listEvents: ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚’è©¦ã¿ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID: ${currentCalendarId}, æœŸé–“: ${timeMin} ã‹ã‚‰ ${timeMax} ---`);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId,
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 20
                });

                const events = response.result.items;
                const newEventsString = JSON.stringify(events); // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—åˆ—åŒ–

                // å‰å›å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã¦ã€å¤‰åŒ–ãŒãªã‘ã‚Œã°DOMæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (newEventsString === lastFetchedEventsString && eventListUl.children.length > 0) {
                    console.log('â„¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã«å¤‰åŒ–ãŒãªã„ãŸã‚ã€DOMæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã ã‘ã¯æ™‚åˆ»å¤‰åŒ–ã§æ›´æ–°ã™ã‚‹ãŸã‚åˆ¥é€”å‡¦ç†
                    updateEventHighlightsAndAnnouncement(events);
                    return; 
                }

                lastFetchedEventsString = newEventsString; // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                eventListUl.innerHTML = ''; // æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢

                let currentEventFound = false;
                let currentEventSummary = '';

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = new Date(event.start.dateTime || event.start.date);
                        const end = new Date(event.end.dateTime || event.end.date);

                        const startDate = start.toLocaleDateString('ja-JP');
                        const startTime = start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = end.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        let eventDetailsHtml;

                        if (event.start.date && !event.start.dateTime) { 
                             eventDetailsHtml = `
                                <div class="event-details">
                                    <span class="event-time">${startDate} (çµ‚æ—¥)</span>
                                    <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                </div>
                            `;
                        } else {
                            eventDetailsHtml = `
                                <div class="event-details">
                                    <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                    <span class="event-summary">${event.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</span>
                                </div>
                            `;
                        }
                        
                        li.innerHTML = eventDetailsHtml + `<button class="event-delete-button" data-event-id="${event.id}">å‰Šé™¤</button>`;
                        eventListUl.appendChild(li);

                        const now = new Date();
                        if (now >= start && now < end) {
                            li.classList.add('current-event');
                            currentEventFound = true;
                            currentEventSummary = event.summary || 'åç§°æœªè¨­å®šã®ä¼šè­°';
                        }
                    });
                    console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£å¸¸ã«è¡¨ç¤ºã—ã¾ã—ãŸ (${currentCalendarSummary}):`, events);

                    document.querySelectorAll('.event-delete-button').forEach(button => {
                        button.onclick = (event) => {
                            const eventIdToDelete = event.target.dataset.eventId;
                            handleDeleteEvent(eventIdToDelete); 
                        };
                    });

                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = 'æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                    eventListUl.appendChild(li);
                    console.log(`â„¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (${currentCalendarSummary})ã€‚`);
                }

                updateEventHighlightsAndAnnouncement(events); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆå†ç”Ÿæˆå¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã‚’æ›´æ–°

            } catch (err) {
                console.error(`âŒ ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã‚¨ãƒ©ãƒ¼ (${currentCalendarSummary}):`, err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                eventListUl.innerHTML = '<li class="error-message">ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æ¡ˆå†…æ–‡ã ã‘ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateEventHighlightsAndAnnouncement(events) {
            const now = new Date();
            let currentEventFound = false;
            let currentEventSummary = '';

            // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤
            document.querySelectorAll('.event-item').forEach(item => {
                item.classList.remove('current-event');
            });

            events.forEach((event, index) => {
                const start = new Date(event.start.dateTime || event.start.date);
                const end = new Date(event.end.dateTime || event.end.date);
                
                if (now >= start && now < end) {
                    const liElement = document.querySelector(`#event_list li:nth-child(${index + 1})`);
                    if (liElement) {
                        liElement.classList.add('current-event');
                    }
                    currentEventFound = true;
                    currentEventSummary = event.summary || 'åç§°æœªè¨­å®šã®ä¼šè­°';
                }
            });

            // æ¡ˆå†…æ–‡ã®è¡¨ç¤ºæ›´æ–°
            const announcementTextElement = document.getElementById('announcement_text');
            if (currentEventFound) {
                announcementTextElement.textContent = `ãŸã ã„ã¾ã€Œ${currentEventSummary}ã€ä¸­ã§ã™`;
                announcementTextElement.style.display = 'block';
            } else {
                announcementTextElement.style.display = 'none';
            }
        }


        async function handleAddEvent(durationMinutes) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ : æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return;
            }

            console.log(`âœ… ${durationMinutes}åˆ†é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚`);
            const now = new Date();
            const eventEndTime = new Date(now.getTime() + (durationMinutes * 60 * 1000)); 

            const event = {
                'summary': `ç·Šæ€¥ä¼šè­° (${durationMinutes}åˆ†)`,
                'location': 'ä¼šè­°å®¤', 
                'description': `ç·Šæ€¥ã®ä¼šè­°ã§ã™ã€‚æ™‚é–“: ${durationMinutes}åˆ†`,
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': eventEndTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': true
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': currentCalendarId, 
                    'resource': event
                });
                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ:', response.result);
                listEvents(); 
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        async function handleDeleteEvent(eventIdToDelete) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤: æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚èªè¨¼ã‚’ä¿ƒã—ã¾ã™ã€‚');
                return;
            }

            console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆ (ID: ${eventIdToDelete}) ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`);
            try {
                await gapi.client.calendar.events.delete({
                    'calendarId': currentCalendarId, 
                    'eventId': eventIdToDelete
                });
                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                listEvents(); 
            } catch (err) {
                console.error('âŒ ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err.result ? err.result.error : err);
                displayError(`ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `ã‚¨ãƒ©ãƒ¼: ${msg}` : '';
            if (msg) console.error("è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:", msg);
        }
    </script>
</body>
</html>
