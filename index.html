<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* デフォルトテーマ (ポップ/Pop) - 明るくフレンドリーな色合い */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --secondary-color: #28a745; /* Green */
            --accent-color: #6c757d; /* Gray */
            --text-color: #333;
            --light-text-color: #555;
            --background-color: #e8f5e9; /* Light Mint */
            --panel-bg-color: #ffffff;
            --border-color: #c8e6c9;
            --error-color: #dc3545;
            --delete-button-color: #dc3545;
            --highlight-color: #ffe082; /* Amber */
            --announcement-bg-color: #ffc107; /* Orange */
            --announcement-text-color: #333;
            --available-color: #a5d6a7; /* Light Green */
            --pre-announcement-bg-color: #add8e6; /* Light Blue for pre-announcement */
            --pre-announcement-text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        /* シックテーマ */
        body.theme-chic {
            --primary-color: #5d4037; /* Dark Brown */
            --secondary-color: #bcaaa4; /* Light Brown */
            --accent-color: #8d6e63; /* Medium Brown */
            --text-color: #3e2723; /* Very Dark Brown */
            --light-text-color: #5d4037;
            --background-color: #f5f5f5; /* Off-White */
            --panel-bg-color: #efebe9; /* Slightly darker Off-White */
            --border-color: #d7ccc8;
            --error-color: #c62828;
            --delete-button-color: #c62828;
            --highlight-color: #ffecb3; /* Creamy Yellow */
            --announcement-bg-color: #ffab40; /* Amber */
            --announcement-text-color: #333;
            --available-color: #a1887f; /* Muted Green-Brown */
            --pre-announcement-bg-color: #8d6e63; /* Medium Brown */
            --pre-announcement-text-color: white;
            --border-radius: 4px; /* シャープな角 */
            --box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        /* スタイリッシュテーマ (薄いブルー基調) */
        body.theme-stylish {
            --primary-color: #007BFF; /* Bright Blue */
            --secondary-color: #17A2B8; /* Teal Blue */
            --accent-color: #6C757D; /* Gray */
            --text-color: #343A40; /* Darker text color */
            --light-text-color: #6C757D; /* Lighter text color */
            --background-color: #E9F5FF; /* Very Light Blue */
            --panel-bg-color: #FFFFFF; /* White for panels */
            --border-color: #C5E1FF; /* Light Blue border */
            --error-color: #DC3545; /* Red for errors */
            --delete-button-color: #DC3545; /* Red for delete buttons */
            --highlight-color: #DBEDFF; /* Light Cyan for current event highlight */
            --announcement-bg-color: #007BFF; /* Primary blue for announcement */
            --announcement-text-color: white; /* White for announcement text */
            --available-color: #85CEFF; /* Light blue for "Available" */
            --pre-announcement-bg-color: #64B5F6; /* Slightly darker blue for pre-announcement */
            --pre-announcement-text-color: white; /* White for pre-announcement text */
            --border-radius: 8px; /* 標準的な角 */
            --box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }


        body {
            font-family: 'Zen Kaku Gothic New', 'Noto Sans JP', sans-serif; /* Zen Kaku Gothic New を優先 */
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center; /* 中央揃え */
            min-height: 100vh;
            box-sizing: border-box;
            font-size: 16px; /* 全体のベースフォントサイズを調整 */
            transition: background-color 0.3s ease, color 0.3s ease; /* テーマ切り替え時のアニメーション */
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px; /* 余白を大きめに */
            font-weight: 500;
            transition: color 0.3s ease; /* テーマ切り替え時のアニメーション */
        }

        /* Header */
        header {
            width: 100%; /* 親要素の幅に合わせる */
            max-width: 900px; /* 最大幅を設定 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* 余白を大きめに */
            position: relative; /* カレンダー名配置のため */
            padding: 0 20px; /* 左右の余白 */
            box-sizing: border-box; /* paddingを含めて幅を計算 */
        }
        header h1 {
            margin: 0;
            font-size: 2.5em; /* H1を調整 */
        }
        #display_calendar_summary_top { /* カレンダー名（上部）のスタイル */
            position: absolute;
            top: 25px; /* H1と設定ボタンの間に配置 */
            left: 20px; /* H1の左端に合わせる */
            font-size: 1.6em; /* カレンダーサマリーを調整 */
            font-weight: 500;
            color: var(--light-text-color);
            transform: translateY(50px); /* H1の下にスペースを開ける */
        }


        /* Top Bar for Date/Time and Announcement */
        #top_bar {
            width: 100%;
            max-width: 900px; /* 最大幅を設定 */
            background-color: var(--panel-bg-color);
            border-radius: var(--border-radius); /* テーマに合わせる */
            box-shadow: var(--box-shadow); /* テーマに合わせる */
            margin-bottom: 30px; /* 余白を大きく */
            padding: 25px 30px; /* パディングを大きく */
            display: flex;
            flex-direction: column; /* 縦並びに */
            align-items: center; /* 中央寄せ */
            text-align: center;
            font-size: 1.2em; /* 調整 */
            color: var(--text-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box; /* paddingを含めて幅を計算 */
        }
        #current_datetime {
            font-weight: bold;
            color: var(--secondary-color); /* 色を調整 */
            margin-bottom: 10px; /* 日付と案内の間に余白 */
            font-size: 1.1em; /* 日付時刻を調整 */
            transition: color 0.3s ease;
        }
        /* Pre-announcement (予約前案内) */
        #pre_announcement_text {
            font-weight: bold;
            color: var(--pre-announcement-text-color);
            background-color: var(--pre-announcement-bg-color);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 1.8em; /* 現在の案内文を調整 */
            display: none;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px; /* 下にスペース */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #announcement_text { /* Current event announcement */
            font-weight: bold;
            color: var(--announcement-text-color);
            background-color: var(--announcement-bg-color);
            padding: 15px 30px; /* パディングを大きく */
            border-radius: var(--border-radius); /* テーマに合わせる */
            font-size: 1.8em; /* 案内文を調整 */
            display: none; /* Initially hidden */
            width: 100%; /* 幅いっぱい */
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #announcement_text.available { /* 空室時のスタイル */
            background-color: var(--available-color);
            color: var(--text-color);
        }

        /* Settings Button */
        #settings_button {
            padding: 10px 22px; /* ボタンを調整 */
            font-size: 0.9em; /* フォントサイズも調整 */
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* テーマに合わせる */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease; /* box-shadowもアニメーション */
            position: fixed; 
            top: 20px;
            right: 20px;
            z-index: 101; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* 影を追加 */
            /* 初期は非表示 */
            display: none; 
        }
        #settings_button:hover {
            background-color: #5a6268; /* Hover color for gray accent */
            box-shadow: 0 6px 12px rgba(0,0,0,0.25); /* ホバー時の影を濃く */
        }

        /* Settings Panel */
        #settings_panel {
            position: fixed; 
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            display: flex;
            justify-content: flex-end; 
            z-index: 100;
            opacity: 0;
            pointer-events: none; 
            transition: opacity 0.3s ease-in-out;
        }
        #settings_panel.open {
            opacity: 1;
            pointer-events: auto;
        }
        #settings_content {
            background-color: var(--panel-bg-color);
            width: 500px; /* パネルの幅を少し広げる */
            max-width: 90%;
            height: 100%;
            padding: 30px;
            box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transform: translateX(100%); 
            transition: transform 0.3s ease-in-out, background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            /* スクロールを可能にする */
            overflow-y: auto; 
        }
        #settings_panel.open #settings_content {
            transform: translateX(0); 
        }
        #close_settings_panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2.2em; /* ボタンを調整 */
            cursor: pointer;
            color: var(--accent-color);
            line-height: 1;
            padding: 5px;
        }
        #close_settings_panel:hover {
            color: var(--text-color);
        }

        /* Auth Section in Settings Panel */
        /* アカウント認証セクション */
        .setting-group.auth-section-group { /* Authセクションのスタイル */
            margin-bottom: 25px; /* 下部余白 */
            padding-bottom: 20px; /* 下部パディング */
            border-bottom: 1px dashed var(--border-color); /* 下線 */
        }
        #auth_status {
            margin-bottom: 25px; 
            padding: 20px; 
            background-color: #E9F5FF; /* 認証ステータスは青系を維持 */
            border: 1px solid #C5E1FF;
            border-radius: var(--border-radius); 
            text-align: center;
            font-size: 1em; /* 調整 */
            line-height: 1.5;
        }
        #authorize_button, #switch_account_button {
            padding: 12px 25px; /* ボタンを調整 */
            font-size: 1em; /* フォントサイズを調整 */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); 
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            width: 100%;
            margin-bottom: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* 影を追加 */
        }
        #authorize_button:hover, #switch_account_button:hover {
            background-color: #0056B3; /* Darker blue hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* ホバー時の影を濃く */
        }
        #authorize_button:active, #switch_account_button:active {
            transform: translateY(2px); /* クリック時のアニメーション */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #authorize_button:disabled, #switch_account_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }
        #calendar_selection_panel {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px dashed var(--border-color);
            flex-grow: 1; 
            overflow-y: auto; 
            min-height: 200px; /* 最小高さを確保 */
            max-height: 50vh; /* 最大高さをビューポートの50%に制限 */
        }
        #calendar_selection_panel h4 { /* カレンダーリストのタイトル */
            margin-bottom: 15px;
            font-size: 1.05em; /* 調整 */
            color: var(--text-color);
        }
        #writable_calendar_list {
            list-style: none;
            padding: 0;
            margin-top: 20px; 
        }
        #writable_calendar_list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0; /* パディングを調整 */
            border-bottom: 1px solid #f7f7f7;
            font-size: 1.05em; /* フォントサイズを調整 */
        }
        #writable_calendar_list li:last-child {
            border-bottom: none;
        }
        .select-button {
            padding: 10px 20px; /* ボタンを調整 */
            font-size: 0.95em; /* フォントサイズ調整 */
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* テーマに合わせる */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* 影を追加 */
        }
        .select-button:hover {
            background-color: #138496; /* Darker teal hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ホバー時の影を濃く */
        }
        .select-button:active {
            transform: translateY(2px); /* クリック時のアニメーション */
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Settings Options */
        .setting-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border-color);
        }
        .setting-group:last-of-type {
            border-bottom: none;
        }
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.95em; /* 調整 */
        }
        .setting-group input[type="text"],
        .setting-group input[type="number"],
        .setting-group select {
            width: calc(100% - 20px);
            padding: 8px; /* 調整 */
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95em; /* 調整 */
            box-sizing: border-box;
            transition: border-color 0.2s ease, border-radius 0.3s ease;
        }
        .setting-group input[type="text"]:focus,
        .setting-group input[type="number"]:focus,
        .setting-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Main Content Area */
        #container {
            flex-grow: 1;
            display: flex;
            gap: 30px; 
            position: relative; 
            width: 100%;
            max-width: 900px; /* 最大幅を設定 */
            padding: 0 20px; /* 左右の余白 */
            box-sizing: border-box; /* paddingを含めて幅を計算 */
        }
        #event_list_container {
            flex: 1;
            padding: 30px;
            background-color: var(--panel-bg-color);
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-radius 0.3s ease;
        }
        #selected_calendar_info { /* この要素は残すが、中身は空になる */
            display: none; /* カレンダー名は上に移動したので非表示 */
        }
        #event_list {
            list-style: none;
            padding: 0;
        }
        #event_list li {
            background-color: #fdfdfd;
            border: 1px solid var(--border-color); /* 枠線の色をテーマに合わせる */
            border-radius: var(--border-radius); /* テーマに合わせる */
            margin-bottom: 18px; /* 調整 */
            padding: 18px 22px; /* 調整 */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* カードUIの影 */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-in-out, border-radius 0.3s ease;
        }
        #event_list li:hover {
            transform: translateY(-5px); /* ホバーエフェクト */
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); /* ホバーエフェクト時の影を濃く */
        }
        /* Highlight for current event */
        #event_list li.current-event {
            background-color: var(--highlight-color);
            border-color: var(--primary-color); /* ハイライト時の枠線の色を primary color に */
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3); /* Primary color に合わせた影 */
        }

        .event-details {
            flex-grow: 1; 
        }
        .event-time {
            font-weight: 700; 
            color: var(--primary-color);
            font-size: 1.2em; /* 調整 */
            margin-bottom: 6px; /* 調整 */
            display: block;
            transition: color 0.3s ease;
        }
        .event-summary {
            color: var(--text-color);
            font-size: 1.1em; /* 調整 */
            line-height: 1.4;
        }
        .no-events {
            font-style: italic;
            color: var(--light-text-color);
            text-align: center;
            padding: 30px; /* 調整 */
            font-size: 1.1em; /* 調整 */
        }

        /* Action Buttons */
        .action-button-group {
            margin-top: 35px; /* 調整 */
            padding-top: 20px; /* 調整 */
            border-top: 1px dashed var(--border-color);
            display: flex;
            gap: 15px; /* 調整 */
            flex-wrap: wrap;
            justify-content: center; /* ボタンを中央揃えに */
        }
        .action-button {
            padding: 12px 22px; /* ボタンを調整 */
            font-size: 1em; /* フォントサイズを調整 */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius); /* テーマに合わせる */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* 影を追加 */
            flex-grow: 1; 
            min-width: 140px; /* 調整 */
            max-width: 230px; /* 調整 */
        }
        .action-button:hover {
            background-color: #0056B3; /* Darker blue hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* ホバー時の影を濃く */
        }
        .action-button:active {
            transform: translateY(2px); /* クリック時のアニメーション */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Disabled state for action buttons */
        .action-button:disabled,
        .event-delete-button:disabled {
            background-color: #cccccc; /* グレーアウト */
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7; /* 少し透明に */
            transform: none; /* 無効時はアニメーションしない */
        }

        .error-message {
            color: var(--error-color);
            font-weight: 700;
            margin-top: 20px; /* 調整 */
            text-align: center;
            font-size: 1.1em; /* 調整 */
            background-color: #FFE5E5; /* エラーメッセージの背景は赤系を維持 */
            padding: 18px; /* 調整 */
            border-radius: var(--border-radius); /* テーマに合わせる */
            border: 1px solid var(--error-color);
            width: 100%;
            max-width: 900px; /* 最大幅を設定 */
            box-sizing: border-box;
        }
        /* New delete button for each event item */
        .event-delete-button {
            padding: 8px 16px; /* 調整 */
            font-size: 0.9em; /* 調整 */
            background-color: var(--delete-button-color); 
            color: white;
            border: none;
            border-radius: var(--border-radius); /* テーマに合わせる */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-radius 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease;
            margin-left: 15px; /* 調整 */
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* 影を追加 */
        }
        .event-delete-button:hover {
            background-color: #A00000; /* Darker red hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ホバー時の影を濃く */
        }
        .event-delete-button:active {
            transform: translateY(2px); /* クリック時のアニメーション */
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                font-size: 14px; /* レスポンシブフォントサイズ */
            }
            header, #top_bar, #container, .error-message {
                padding: 0 10px;
                max-width: 100%; /* 小さい画面では全幅を使用 */
            }
            header h1 {
                font-size: 2em; /* 調整 */
            }
            #display_calendar_summary_top {
                font-size: 1.3em; /* レスポンシブでも少し大きく */
                transform: translateY(35px); /* 調整 */
            }
            #top_bar {
                padding: 15px 20px;
            }
            #current_datetime {
                font-size: 1em; /* 調整 */
            }
            #pre_announcement_text, #announcement_text {
                font-size: 1.4em; /* 調整 */
                padding: 10px 15px;
            }
            #settings_button {
                padding: 8px 18px; /* 調整 */
                font-size: 0.85em; /* 調整 */
                top: 15px;
                right: 15px;
            }
            #settings_content {
                width: 100%;
                max-width: 100%;
                padding: 20px;
            }
            .setting-group {
                margin-bottom: 18px; /* 調整 */
                padding-bottom: 12px; /* 調整 */
            }
            #authorize_button, #switch_account_button, .select-button, .action-button {
                padding: 10px 18px; /* 調整 */
                font-size: 0.95em; /* 調整 */
            }
            #event_list_container {
                padding: 18px; /* 調整 */
            }
            #event_list li {
                flex-direction: column; /* 縦並びに */
                align-items: flex-start; /* 左寄せ */
                padding: 12px; /* 調整 */
            }
            .event-time, .event-summary {
                font-size: 1em; /* 調整 */
            }
            .event-delete-button {
                margin-left: 0; /* 左マージンをなくす */
                margin-top: 8px; /* 上にマージンを追加 */
                width: 100%; /* 幅いっぱいに */
                padding: 7px 14px; /* 調整 */
            }
            .action-button-group {
                flex-direction: column;
                gap: 12px; /* 調整 */
            }
            .action-button {
                min-width: unset;
                max-width: unset;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.6em; /* 調整 */
            }
            #display_calendar_summary_top {
                font-size: 1.1em; /* 調整 */
                transform: translateY(25px); /* 調整 */
            }
            #current_datetime {
                font-size: 0.9em; /* 調整 */
            }
            #pre_announcement_text, #announcement_text {
                font-size: 1.1em; /* 調整 */
                padding: 7px 10px; /* 調整 */
            }
            .setting-group label, .setting-group input, .setting-group select {
                font-size: 0.85em; /* 調整 */
            }
            #authorize_button, #switch_account_button, .select-button, .action-button, .event-delete-button {
                font-size: 0.85em; /* 調整 */
                padding: 8px 12px; /* 調整 */
            }
        }

    </style>
</head>
<body class="theme-stylish">
    <header>
        <h1 id="main_app_title">会議室予約表示Ver1.2</h1>
        <button id="settings_button">設定</button> <span id="display_calendar_summary_top"></span>
    </header>

    <div id="top_bar">
        <span id="current_datetime"></span>
        <span id="pre_announcement_text"></span> 
        <span id="announcement_text"></span>
    </div>

    <div id="settings_panel">
        <div id="settings_content">
            <button id="close_settings_panel">&times;</button>
            <h2>設定</h2>
            <hr>
            <div class="setting-group auth-section-group">
                <h3>アカウントとカレンダーの切り替え</h3>
                <p id="auth_status" style="color: blue;">操作を行うにはGoogleアカウントで認証してください。</p>
                <button id="authorize_button">Googleアカウントで認証</button>
                <button id="switch_account_button" style="display:none;">別のアカウントで認証</button>
                <p style="font-size: 0.9em; color: var(--light-text-color); margin-top: 10px;">
                    ※緊急会議、削除などの管理者操作を利用する際に認証が必要です。<br>
                    ※認証後、表示・操作するカレンダーを選択してください。
                </p>
                <div id="calendar_selection_panel" style="display: none;">
                    <div style="height: 3em; margin-bottom: 1em;"></div> <h4>表示・操作するカレンダーを選択</h4>
                    <ul id="writable_calendar_list">
                        <li>認証後、カレンダーを読み込み中...</li>
                    </ul>
                </div>
            </div>
            <div class="setting-group">
                <h3>テーマ設定</h3>
                <label for="theme_select">テーマを選択:</label>
                <select id="theme_select">
                    <option value="pop">ポップ</option>
                    <option value="chic">シック</option>
                    <option value="stylish">スタイリッシュ</option>
                </select>
            </div>

            <div class="setting-group">
                <h3>更新時間設定</h3>
                <label for="refresh_interval_select">更新間隔 (秒):</label>
                <select id="refresh_interval_select">
                    <option value="30">30秒</option>
                    <option value="60">60秒</option>
                    <option value="120">120秒</option>
                </select>
            </div>

            <div class="setting-group">
                <h3>表示タイトル設定</h3>
                <label for="main_title_input">メインタイトル:</label>
                <input type="text" id="main_title_input" value="会議室予約表示Ver1.2">

                <label for="event_list_title_input">イベントリストタイトル:</label>
                <input type="text" id="event_list_title_input" value="現在の会議室の予定">
            </div>

            <div class="setting-group">
                <h3>案内板の表示設定</h3>
                <label for="available_text_input">空室時の表記:</label>
                <input type="text" id="available_text_input" value="空室です">

                <label for="in_progress_prefix_input">当該時間時の接頭語:</label>
                <input type="text" id="in_progress_prefix_input" value="ただいま">

                <label for="in_progress_suffix_input">当該時間時の接尾語:</label>
                <input type="text" id="in_progress_suffix_input" value="中です">
            </div>

            <div class="setting-group">
                <h3>予約前案内設定</h3>
                <label for="pre_announcement_minutes_select">予約前案内 (何分前):</label>
                <select id="pre_announcement_minutes_select">
                    <option value="1">1分前</option>
                    <option value="5">5分前</option>
                    <option value="10">10分前</option>
                    <option value="15">15分前</option>
                </select>

                <label for="pre_announcement_prefix_input">予約前案内の接頭語:</label>
                <input type="text" id="pre_announcement_prefix_input" value="まもなく">

                <label for="pre_announcement_suffix_input">予約前案内の接尾語:</label>
                <input type="text" id="pre_announcement_suffix_input" value="開始">

                <label for="pre_announcement_default_text_input">予約前案内がない場合の表記:</label>
                <input type="text" id="pre_announcement_default_text_input" value="ご案内">
            </div>

            <div class="setting-group">
                <h3>緊急会議イベント設定</h3>
                <label for="event_summary_input">イベント名 (30分/60分共通):</label>
                <input type="text" id="event_summary_input" value="緊急会議">
            </div>

            <hr style="display: none;"> </div>
    </div>

    <div id="container">
        <div id="event_list_container" class="panel">
            <h2 id="event_list_section_title">現在の会議室の予定</h2>
            <ul id="event_list">
                <li>イベントを読み込み中...</li>
            </ul>
            <div class="action-button-group">
                <button id="add_30min_event_button" class="action-button">緊急会議 (30分)</button>
                <button id="add_60min_event_button" class="action-button">緊急会議 (60分)</button>
                <button id="refresh_button" class="action-button">更新</button>
            </div>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // ★★★ ここをあなたの情報に置き換えてください ★★★
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';             
        const INITIAL_PUBLIC_CALENDAR_ID = 'kaigishitsu20000101@gmail.com'; 
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; 
        // ★★★ ここまで ★★★

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const WRITE_SCOPES = 'https://www.googleapis.com/auth/calendar.events'; 

        const LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY = 'activeCalendarId';
        const LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY = 'activeCalendarSummary';
        const LOCAL_STORAGE_SETTINGS_KEY = 'appSettings'; // 設定保存用キー

        // デフォルト設定値
        const DEFAULT_SETTINGS = {
            refreshInterval: 30, // 秒
            availableText: "空室です",
            inProgressPrefix: "ただいま",
            inProgressSuffix: "中です",
            preAnnouncementMinutes: 5, // 予約前案内：デフォルト5分前
            preAnnouncementPrefix: "まもなく",
            preAnnouncementSuffix: "開始",
            preAnnouncementDefaultText: "ご案内", // 予約前案内がない場合のデフォルト文言
            eventSummary: "緊急会議",
            lastEvents: [], // 最後に取得したイベントデータをここに保存（案内文用）
            theme: "stylish", // デフォルトテーマをstylishに設定
            mainTitle: "会議室予約表示Ver1.2", // メインタイトルのデフォルト値
            eventListTitle: "現在の会議室の予定" // イベントリストタイトルのデフォルト値
        };
        let appSettings = {}; // 現在のアプリ設定

        let tokenClient; 
        let isAuthorizedForWrite = false; 
        let currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
        let currentCalendarSummary = "初期設定カレンダー"; 
        let refreshIntervalId; 
        let lastFetchedEventsString = ""; 

        document.addEventListener('DOMContentLoaded', () => {
            // 設定をロードし、UIとアプリに適用
            loadSettings();
            applySettingsToUI();
            applyTheme(appSettings.theme);
            updateDisplayTitles(); // 題名と項目題名を初期表示に反映

            // UI要素の取得
            const settingsButton = document.getElementById('settings_button');
            const settingsPanel = document.getElementById('settings_panel');
            const closeSettingsPanelButton = document.getElementById('close_settings_panel');
            const authorizeButton = document.getElementById('authorize_button');
            const switchAccountButton = document.getElementById('switch_account_button'); 
            const refreshButton = document.getElementById('refresh_button'); // 更新ボタン

            // 設定UI要素の取得 (設定保存/適用用)
            const themeSelect = document.getElementById('theme_select');
            const refreshIntervalSelect = document.getElementById('refresh_interval_select');
            const mainTitleInput = document.getElementById('main_title_input'); // 新しい設定項目
            const eventListTitleInput = document.getElementById('event_list_title_input'); // 新しい設定項目
            const availableTextInput = document.getElementById('available_text_input');
            const inProgressPrefixInput = document.getElementById('in_progress_prefix_input');
            const inProgressSuffixInput = document.getElementById('in_progress_suffix_input');
            const preAnnouncementMinutesSelect = document.getElementById('pre_announcement_minutes_select'); 
            const preAnnouncementPrefixInput = document.getElementById('pre_announcement_prefix_input'); 
            const preAnnouncementSuffixInput = document.getElementById('pre_announcement_suffix_input'); 
            const preAnnouncementDefaultTextInput = document.getElementById('pre_announcement_default_text_input'); 
            const eventSummaryInput = document.getElementById('event_summary_input');
            
            // --- 設定ボタンのイベントリスナー ---
            // 設定ボタンは初期は非表示
            settingsButton.style.display = 'none'; // CSSからもdisplay:none;にする必要があります。
            settingsButton.onclick = () => {
                settingsPanel.classList.toggle('open');
                if (settingsPanel.classList.contains('open') && isAuthorizedForWrite) {
                    listWritableCalendars(); 
                } else if (!settingsPanel.classList.contains('open')) {
                    displayError(''); 
                }
            };
            
            // --- 更新ボタンのダブルクリックで設定ボタンを表示/非表示をトグル ---
            refreshButton.addEventListener('dblclick', (e) => {
                e.preventDefault(); // デフォルトのダブルクリック動作を防止
                console.log('--- 更新ボタンがダブルクリックされました ---');
                // 設定ボタンの表示状態をトグル
                if (settingsButton.style.display === 'none') {
                    settingsButton.style.display = 'block'; // 表示
                    settingsButton.disabled = false; // 表示と同時に有効化
                    console.log('設定ボタンが表示され、有効になりました。');
                } else {
                    settingsButton.style.display = 'none'; // 非表示
                    // 設定パネルが開いていたら閉じる
                    settingsPanel.classList.remove('open');
                    console.log('設定ボタンが非表示になりました。');
                }
            });


            // 設定パネルを閉じるボタン
            closeSettingsPanelButton.onclick = () => {
                settingsPanel.classList.remove('open');
                displayError(''); 
                // パネルを閉じても設定ボタンの表示状態はダブルクリックで制御されるため、ここでは変更しない
            };

            // --- 各種設定UI要素のイベントリスナー ---
            themeSelect.onchange = (e) => { appSettings.theme = e.target.value; saveSettings(); applyTheme(appSettings.theme); };
            refreshIntervalSelect.onchange = (e) => { appSettings.refreshInterval = parseInt(e.target.value); saveSettings(); startAutoRefresh(); };
            mainTitleInput.onchange = (e) => { appSettings.mainTitle = e.target.value; saveSettings(); updateDisplayTitles(); }; // 新しい設定項目のイベントリスナー
            eventListTitleInput.onchange = (e) => { appSettings.eventListTitle = e.target.value; saveSettings(); updateDisplayTitles(); }; // 新しい設定項目のイベントリスナー
            availableTextInput.onchange = (e) => { appSettings.availableText = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            inProgressPrefixInput.onchange = (e) => { appSettings.inProgressPrefix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); };
            inProgressSuffixInput.onchange = (e) => { appSettings.inProgressSuffix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); };
            preAnnouncementMinutesSelect.onchange = (e) => { appSettings.preAnnouncementMinutes = parseInt(e.target.value); saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementPrefixInput.onchange = (e) => { appSettings.preAnnouncementPrefix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementSuffixInput.onchange = (e) => { appSettings.preAnnouncementSuffix = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            preAnnouncementDefaultTextInput.onchange = (e) => { appSettings.preAnnouncementDefaultText = e.target.value; saveSettings(); updateEventHighlightsAndAnnouncement(appSettings.lastEvents || []); }; 
            eventSummaryInput.onchange = (e) => { appSettings.eventSummary = e.target.value; saveSettings(); updateAddButtonText(); }; 

            // --- 認証関連ボタンのイベントリスナー ---
            authorizeButton.onclick = () => {
                console.log('--- Googleアカウントで認証ボタンがクリックされました（操作用）。認証フローを開始します。---');
                tokenClient.requestAccessToken({ prompt: 'consent', ux_mode: 'popup' }); 
            };
            switchAccountButton.onclick = () => { 
                console.log('--- 別のアカウントで認証ボタンがクリックされました。アカウント選択を強制します。---');
                tokenClient.requestAccessToken({ prompt: 'select_account', ux_mode: 'popup' }); 
            };

            // --- 操作ボタンのイベントリスナー ---
            document.getElementById('add_30min_event_button').onclick = () => handleAddEvent(30);
            document.getElementById('add_60min_event_button').onclick = () => handleAddEvent(60); 
            // refreshButtonの通常のクリック動作
            refreshButton.onclick = listEvents; 


            setInterval(updateCurrentDateTime, 1000);
            updateCurrentDateTime(); 

            updateAddButtonText();

            console.log('--- DOMContentLoaded: gapiクライアントロードを開始 ---');
            gapi.load('client', initGapiClientForRead);
        });

        // 設定をlocalStorageからロード
        function loadSettings() {
            const savedSettings = localStorage.getItem(LOCAL_STORAGE_SETTINGS_KEY);
            if (savedSettings) {
                try {
                    appSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(savedSettings) };
                    if (!appSettings.lastEvents) {
                        appSettings.lastEvents = [];
                    }
                    console.log('✅ 設定をlocalStorageからロードしました:', appSettings);
                } catch (e) {
                    console.error('❌ localStorageからの設定読み込みに失敗しました。デフォルト設定を使用します。', e);
                    appSettings = { ...DEFAULT_SETTINGS };
                }
            } else {
                appSettings = { ...DEFAULT_SETTINGS };
                console.log('ℹ️ 設定が見つかりませんでした。デフォルト設定を使用します:', appSettings);
            }
        }

        // 設定をlocalStorageに保存
        function saveSettings() {
            localStorage.setItem(LOCAL_STORAGE_SETTINGS_KEY, JSON.stringify(appSettings));
            console.log('✅ 設定をlocalStorageに保存しました:', appSettings);
        }

        // UIに設定値を適用
        function applySettingsToUI() {
            document.getElementById('theme_select').value = appSettings.theme;
            document.getElementById('refresh_interval_select').value = appSettings.refreshInterval;
            document.getElementById('main_title_input').value = appSettings.mainTitle; // 新しい設定項目
            document.getElementById('event_list_title_input').value = appSettings.eventListTitle; // 新しい設定項目
            document.getElementById('available_text_input').value = appSettings.availableText;
            document.getElementById('in_progress_prefix_input').value = appSettings.inProgressPrefix;
            document.getElementById('in_progress_suffix_input').value = appSettings.inProgressSuffix;
            document.getElementById('pre_announcement_minutes_select').value = appSettings.preAnnouncementMinutes;
            document.getElementById('pre_announcement_prefix_input').value = appSettings.preAnnouncementPrefix;
            document.getElementById('pre_announcement_suffix_input').value = appSettings.preAnnouncementSuffix;
            document.getElementById('pre_announcement_default_text_input').value = appSettings.preAnnouncementDefaultText;
            document.getElementById('event_summary_input').value = appSettings.eventSummary;
        }

        // テーマを適用する関数
        function applyTheme(themeName) {
            document.body.classList.remove('theme-pop', 'theme-chic', 'theme-stylish');
            document.body.classList.add(`theme-${themeName}`);
            console.log(`テーマを "${themeName}" に変更しました。`);
        }

        // 追加ボタンのテキストを更新する関数
        function updateAddButtonText() {
            const eventSummary = appSettings.eventSummary || "緊急会議";
            document.getElementById('add_30min_event_button').textContent = `${eventSummary} (30分)`;
            document.getElementById('add_60min_event_button').textContent = `${eventSummary} (60分)`;
        }

        // 題名と項目題名を更新する関数
        function updateDisplayTitles() {
            document.getElementById('main_app_title').textContent = appSettings.mainTitle;
            document.getElementById('event_list_section_title').textContent = appSettings.eventListTitle;
            console.log(`✅ 表示タイトルを更新しました: メイン「${appSettings.mainTitle}」、イベントリスト「${appSettings.eventListTitle}」`);
        }


        function initGapiClientForRead() {
            console.log('--- initGapiClientForRead: 読み込み専用クライアント初期化中 ---');
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('✅ gapi client initialized for read-only access (API Key only).');
                
                console.log('--- initGapiClientForRead: localStorageからアクティブカレンダーを読み込み試行 ---');
                const savedActiveId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY);
                const savedActiveSummary = localStorage.getItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY);

                if (savedActiveId && savedActiveSummary) { 
                    currentCalendarId = savedActiveId;
                    currentCalendarSummary = savedActiveSummary;
                    console.log(`✅ localStorageからアクティブカレンダーを読み込みました: ${currentCalendarSummary} (${currentCalendarId})`);
                } else {
                    currentCalendarId = INITIAL_PUBLIC_CALENDAR_ID; 
                    currentCalendarSummary = "初期設定カレンダー"; 
                    console.log(`ℹ️ localStorageにアクティブカレンダーが見つかりませんでした。初期設定カレンダー (${INITIAL_PUBLIC_CALENDAR_ID}) を使用します。`);
                }
                updateDisplayedCalendarInfo();

                console.log(`--- initGapiClientForRead: イベントリスト表示を開始 (カレンダーID: ${currentCalendarId}) ---`);
                listEvents(); 
                startAutoRefresh(); 

                console.log('--- initGapiClientForRead: GISクライアント初期化を開始（書き込み操作用） ---');
                initGisClientForWrite();

            }).catch(err => {
                console.error('❌ gapiクライアントの初期化エラー（読み込み用）:', err);
                displayError('イベント表示の初期化に失敗しました。APIキーまたはネットワーク接続を確認してください。');
            });
        }

        function initGisClientForWrite() {
            console.log('--- initGisClientForWrite: GISクライアント初期化中 ---');
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: WRITE_SCOPES,
                callback: (tokenResponse) => {
                    console.log('--- tokenClient callback executed for write scope ---');
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        isAuthorizedForWrite = true;
                        document.getElementById('auth_status').textContent = '操作権限が認証されました。';
                        document.getElementById('auth_status').style.color = 'green';
                        document.getElementById('authorize_button').style.display = 'none'; 
                        document.getElementById('switch_account_button').style.display = 'block'; 
                        document.getElementById('calendar_selection_panel').style.display = 'block'; 
                        console.log('✅ 書き込み権限のためのアクセストークンを取得しました。');
                        listWritableCalendars(); 
                    } else {
                        isAuthorizedForWrite = false;
                        document.getElementById('auth_status').textContent = '操作権限の認証に失敗しました。';
                        document.getElementById('auth_status').style.color = 'red';
                        document.getElementById('authorize_button').style.display = 'block'; 
                        document.getElementById('switch_account_button').style.display = 'none'; 
                        document.getElementById('calendar_selection_panel').style.display = 'none'; 
                        console.error('❌ 書き込み権限のためのアクセストークン取得に失敗しました。', tokenResponse);
                    }
                },
                error_callback: (error) => {
                    isAuthorizedForWrite = false;
                    document.getElementById('auth_status').textContent = '認証エラーが発生しました。';
                    document.getElementById('auth_status').style.color = 'red';
                    document.getElementById('authorize_button').style.display = 'block'; 
                    document.getElementById('switch_account_button').style.display = 'none'; 
                    document.getElementById('calendar_selection_panel').style.display = 'none'; 
                    console.error('❌ GISトークンクライアントエラー（書き込み用）:', error);
                }
            });
        }

        function handleActionTrigger(event) {
            console.log('--- handleActionTrigger: 操作ボタンがクリックされました ---');
            document.getElementById('settings_panel').classList.add('open'); 

            if (!isAuthorizedForWrite) {
                document.getElementById('auth_status').textContent = '操作を行うにはGoogleアカウントで認証してください。';
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('🚨 操作トリガー: 書き込み権限がありません。認証を促します。');
                return; 
            }
        }

        async function listWritableCalendars() {
            const writableCalendarListUl = document.getElementById('writable_calendar_list');
            writableCalendarListUl.innerHTML = '<li>カレンダーを読み込み中...</li>';
            displayError('');
            console.log('--- listWritableCalendars: 書き込み可能カレンダーリスト取得中 ---');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;
                const writableCalendars = allCalendars.filter(calendar => 
                    calendar.accessRole === 'owner' || calendar.accessRole === 'writer'
                );

                if (writableCalendars && writableCalendars.length > 0) {
                    writableCalendarListUl.innerHTML = ''; 
                    writableCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        const isCurrent = (calendar.id === currentCalendarId) ? ' (現在選択中)' : '';
                        li.innerHTML = `
                            <span>${calendar.summary}${isCurrent}</span>
                            <button class="select-button" 
                                data-calendar-id="${calendar.id}" 
                                data-calendar-summary="${calendar.summary}">選択</button>
                        `;
                        writableCalendarListUl.appendChild(li);
                    });
                    console.log('✅ 書き込み可能なカレンダーリストを正常に表示しました:', writableCalendars);

                    document.querySelectorAll('#writable_calendar_list .select-button').forEach(button => {
                        button.onclick = (event) => {
                            console.log('--- カレンダー選択ボタンが押されました ---');
                            const newActiveId = event.target.dataset.calendarId;
                            const newActiveSummary = event.target.dataset.calendarSummary;
                            
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_ID_KEY, newActiveId);
                            localStorage.setItem(LOCAL_STORAGE_ACTIVE_CALENDAR_SUMMARY_KEY, newActiveSummary);

                            currentCalendarId = newActiveId;
                            currentCalendarSummary = newActiveSummary;
                            updateDisplayedCalendarInfo(); 
                            console.log(`✅ アクティブカレンダーが選択・保存されました: ${currentCalendarSummary} (${currentCalendarId})`);
                            listEvents(); 
                            
                            document.getElementById('settings_panel').classList.remove('open'); 
                        };
                    });
                } else {
                    writableCalendarListUl.innerHTML = '<li>書き込み可能なカレンダーが見つかりませんでした。</li>';
                    console.log(`ℹ️ 書き込み可能なカレンダーが見つかりませんでした。`);
                }
            } catch (err) {
                console.error('❌ 書き込み可能カレンダーリストの取得エラー:', err.result ? err.result.error : err);
                displayError(`カレンダーリストの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function updateDisplayedCalendarInfo() {
            // メイン画面のカレンダー情報表示を更新
            const mainSummaryElement = document.getElementById('display_calendar_summary');
            if (mainSummaryElement) {
                mainSummaryElement.textContent = currentCalendarSummary;
            }
            // ヘッダー直下のカレンダー情報表示を更新
            const topSummaryElement = document.getElementById('display_calendar_summary_top');
            if (topSummaryElement) {
                topSummaryElement.textContent = currentCalendarSummary;
            }

            console.log(`ℹ️ 表示カレンダー情報を更新しました: ${currentCalendarSummary}`);
        }

        function updateCurrentDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedDate = now.toLocaleDateString('ja-JP', dateOptions);
            const formattedTime = now.toLocaleTimeString('ja-JP', timeOptions);
            document.getElementById('current_datetime').textContent = `${formattedDate} ${formattedTime}`;
        }

        function startAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId); 
            }
            // appSettingsから更新間隔を取得 (秒をミリ秒に変換)
            refreshIntervalId = setInterval(listEvents, appSettings.refreshInterval * 1000);
            console.log(`--- 自動更新を開始しました: ${appSettings.refreshInterval}秒間隔 ---`);
        }

        async function listEvents() {
            const eventListUl = document.getElementById('event_list');
            displayError(''); 

            const now = new Date();
            const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString(); 
            const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString(); 

            console.log(`--- listEvents: イベント取得を試みます。カレンダーID: ${currentCalendarId}, 期間: ${timeMin} から ${timeMax} ---`);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': currentCalendarId,
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime', 
                    'maxResults': 20
                });

                let events = response.result.items;
                // --- 現在進行中または次に開始するイベントを先頭に移動するロジック ---
                if (events && events.length > 0) {
                    const currentTime = new Date(); 
                    events.sort((a, b) => {
                        const startA = new Date(a.start.dateTime || a.start.date);
                        const endA = new Date(a.end.dateTime || a.end.date);
                        const startB = new Date(b.start.dateTime || b.start.date);
                        const endB = new Date(b.end.dateTime || b.end.date);

                        const aIsCurrent = (currentTime >= startA && currentTime < endA);
                        const bIsCurrent = (currentTime >= startB && currentTime < endB);

                        const aStartsSoon = (startA > currentTime && (startA.getTime() - currentTime.getTime()) <= (appSettings.preAnnouncementMinutes * 60 * 1000));
                        const bStartsSoon = (startB > currentTime && (b.getTime() - currentTime.getTime()) <= (appSettings.preAnnouncementMinutes * 60 * 1000));

                        // 1. 現在進行中のイベントが最優先
                        if (aIsCurrent && !bIsCurrent) return -1; 
                        if (!aIsCurrent && bIsCurrent) return 1;  

                        // 2. 次に開始する（予約前案内期間内）イベントが次に優先
                        if (aStartsSoon && !bStartsSoon) return -1;
                        if (!aStartsSoon && bStartsSoon) return 1;

                        // 3. それ以外は開始時間でソート
                        return startA.getTime() - startB.getTime();
                    });
                }
                // --- 並び替えロジックここまで ---

                // 取得したイベントリストから比較に必要なプロパティのみを抽出し、JSON文字列化
                const eventsForComparison = events.map(event => ({
                    id: event.id,
                    summary: event.summary,
                    start: event.start,
                    end: event.end
                }));
                const newEventsString = JSON.stringify(eventsForComparison); 

                // 前回取得したデータと比較して、変化がなければDOM更新をスキップ
                if (newEventsString === lastFetchedEventsString && eventListUl.children.length > 0 && !eventListUl.innerHTML.includes("イベントを読み込み中")) {
                    console.log('ℹ️ イベントデータに変化がないため、DOM更新をスキップします。');
                    // ハイライトと案内文だけは時刻変化で更新するため別途処理
                    updateEventHighlightsAndAnnouncement(events); // 元のeventsオブジェクトを渡す
                    return; 
                }

                lastFetchedEventsString = newEventsString; // データを更新
                appSettings.lastEvents = events; // 案内文表示のためにイベントデータをappSettingsに保存
                saveSettings(); // appSettingsの変更を保存

                eventListUl.innerHTML = ''; // 既存の表示をクリア

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = new Date(event.start.dateTime || event.start.date);
                        const end = new Date(event.end.dateTime || event.end.date);

                        const startDate = start.toLocaleDateString('ja-JP');
                        const startTime = start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = end.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        let eventDetailsHtml;

                        if (event.start.date && !event.start.dateTime) { 
                             eventDetailsHtml = `
                                <div class="event-details">
                                    <span class="event-time">${startDate} (終日)</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        } else {
                            eventDetailsHtml = `
                                <div class="event-details">
                                    <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        }
                        
                        li.innerHTML = eventDetailsHtml + `<button class="event-delete-button" data-event-id="${event.id}">削除</button>`;
                        eventListUl.appendChild(li);
                    });
                    console.log(`✅ イベントを正常に表示しました (${currentCalendarSummary}):`, events);

                    document.querySelectorAll('.event-delete-button').forEach(button => {
                        button.onclick = (event) => {
                            const eventIdToDelete = event.target.dataset.eventId;
                            handleDeleteEvent(eventIdToDelete); 
                        };
                    });

                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = '指定された期間にイベントが見つかりませんでした。';
                    eventListUl.appendChild(li);
                    console.log(`ℹ️ イベントが見つかりませんでした (${currentCalendarSummary})。`);
                }

                updateEventHighlightsAndAnnouncement(events); // イベントリスト再生成後にハイライトと案内文を更新
                updateActionButtonStates(); // ボタンの有効/無効状態を更新

            } catch (err) {
                console.error(`❌ イベントの取得エラー (${currentCalendarSummary}):`, err.result ? err.result.error : err);
                displayError(`イベントの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                eventListUl.innerHTML = '<li class="error-message">イベントの読み込みに失敗しました。</li>';
                updateActionButtonStates(); // エラー時もボタンの有効/無効状態を更新
            }
        }
        
        // イベントのハイライトと案内文だけを更新する関数
        function updateEventHighlightsAndAnnouncement(events) {
            const now = new Date();
            let currentEventFound = false;
            let currentEventSummary = '';
            let preAnnouncementFound = false; 
            let preAnnouncementSummary = ''; 

            // 既存のハイライトをすべて削除
            document.querySelectorAll('.event-item').forEach(item => {
                item.classList.remove('current-event');
            });

            // 最も近い未来のイベントを見つけるための変数
            let closestUpcomingEvent = null;
            let minTimeUntilStart = Infinity;

            events.forEach((event, index) => {
                const start = new Date(event.start.dateTime || event.start.date);
                const end = new Date(event.end.dateTime || event.end.date);
                
                // 現在進行中のイベントを判定
                if (now >= start && now < end) {
                    const liElement = document.querySelector(`#event_list li:nth-child(${index + 1})`);
                    if (liElement) {
                        liElement.classList.add('current-event');
                    }
                    currentEventFound = true;
                    currentEventSummary = event.summary || '名称未設定の会議';
                }
                
                // 現在時刻より未来のイベントの中で最も近いものを探す
                if (now < start) {
                    const timeUntilStart = start.getTime() - now.getTime(); // ミリ秒単位
                    if (timeUntilStart > 0 && timeUntilStart <= (appSettings.preAnnouncementMinutes * 60 * 1000)) { 
                        minTimeUntilStart = timeUntilStart;
                        closestUpcomingEvent = event;
                    }
                }
            });

            // 予約前案内の表示更新
            const preAnnouncementTextElement = document.getElementById('pre_announcement_text');
            if (closestUpcomingEvent) {
                const timeUntilClosestStart = closestUpcomingEvent.start.dateTime ? new Date(closestUpcomingEvent.start.dateTime).getTime() - now.getTime() : Infinity;
                
                if (timeUntilClosestStart > 0 && timeUntilClosestStart <= (appSettings.preAnnouncementMinutes * 60 * 1000)) {
                    preAnnouncementFound = true;
                    preAnnouncementSummary = closestUpcomingEvent.summary || '名称未設定の会議';
                }
            }
            
            if (preAnnouncementFound) {
                preAnnouncementTextElement.textContent = `${appSettings.preAnnouncementPrefix}「${preAnnouncementSummary}」${appSettings.preAnnouncementSuffix}`;
                preAnnouncementTextElement.style.display = 'block';
            } else {
                // 予約前案内すべきイベントがない場合
                preAnnouncementTextElement.textContent = appSettings.preAnnouncementDefaultText; // デフォルト文言
                preAnnouncementTextElement.style.display = 'block'; // 常に表示
            }


            // 現在の案内文（使用中 or 空室）の表示更新
            const announcementTextElement = document.getElementById('announcement_text');
            if (currentEventFound) {
                announcementTextElement.textContent = `${appSettings.inProgressPrefix}「${currentEventSummary}」${appSettings.inProgressSuffix}`;
                announcementTextElement.classList.remove('available'); 
                announcementTextElement.style.display = 'block';
            } else { // 進行中のイベントがない場合
                announcementTextElement.textContent = appSettings.availableText;
                announcementTextElement.classList.add('available'); 
                announcementTextElement.style.display = 'block'; 
            }
        }

        // 予約・削除ボタンの有効/無効を切り替える関数
        function updateActionButtonStates() {
            const add30Button = document.getElementById('add_30min_event_button');
            const add60Button = document.getElementById('add_60min_event_button');
            const refreshButton = document.getElementById('refresh_button'); // 更新ボタンは常に有効
            const deleteButtons = document.querySelectorAll('.event-delete-button');

            // 認証状態に応じてボタンを有効/無効化
            add30Button.disabled = !isAuthorizedForWrite;
            add60Button.disabled = !isAuthorizedForWrite;
            // refreshButton.disabled = false; // 更新ボタンは常に有効

            deleteButtons.forEach(button => {
                button.disabled = !isAuthorizedForWrite;
            });

            console.log(`ℹ️ 操作ボタンの状態を更新しました。認証済み: ${isAuthorizedForWrite}`);
        }

        async function handleAddEvent(durationMinutes) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `イベントを追加するにはGoogleアカウントで認証してください。`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('🚨 イベント追加: 書き込み権限がありません。認証を促します。');
                return;
            }

            console.log(`✅ ${durationMinutes}分間のイベントを追加します。`);
            const now = new Date();
            const eventEndTime = new Date(now.getTime() + (durationMinutes * 60 * 1000)); 

            const event = {
                'summary': `${appSettings.eventSummary} (${durationMinutes}分)`, 
                'location': '会議室', 
                'description': '', // イベント説明は空に
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': eventEndTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': true
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': currentCalendarId, 
                    'resource': event
                });
                console.log('✅ イベントが追加されました:', response.result);
                listEvents(); 
            } catch (err) {
                console.error('❌ イベント追加エラー:', err.result ? err.result.error : err);
                displayError(`イベントの追加に失敗しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        async function handleDeleteEvent(eventIdToDelete) {
            if (!isAuthorizedForWrite) {
                document.getElementById('settings_panel').classList.add('open');
                document.getElementById('auth_status').textContent = `イベントを削除するにはGoogleアカウントで認証してください。`;
                document.getElementById('auth_status').style.color = 'blue';
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('switch_account_button').style.display = 'none'; 
                document.getElementById('calendar_selection_panel').style.display = 'none';
                console.log('🚨 イベント削除: 書き込み権限がありません。認証を促します。');
                return;
            }

            console.log(`✅ イベント (ID: ${eventIdToDelete}) を削除します。`);
            try {
                await gapi.client.calendar.events.delete({
                    'calendarId': currentCalendarId, 
                    'eventId': eventIdToDelete
                });
                console.log('✅ イベントが削除されました。');
                listEvents(); 
            } catch (err) {
                console.error('❌ イベント削除エラー:', err.result ? err.result.error : err);
                displayError(`イベントの削除に失敗しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `エラー: ${msg}` : '';
            if (msg) console.error("表示エラー:", msg);
        }
    </script>
</body>
</html>
