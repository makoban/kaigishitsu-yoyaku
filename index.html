<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の会議室スケジュール</title>
    <style>
        /* (CSSスタイルは前のバージョンと同じです。変更していません) */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* 画面いっぱいに表示 */
            /* フォントサイズはJSで設定される */
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        #schedule-container {
            flex-grow: 1; /* 残りのスペースを埋める */
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 800px;
            margin: 0 auto; /* 中央寄せ */
            box-sizing: border-box; /* パディングを含めてサイズ計算 */
        }
        .schedule-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 0;
            display: flex;
            align-items: center;
        }
        .schedule-item:last-child {
            border-bottom: none; /* 最後の項目は下線なし */
        }
        .time {
            font-size: 1.2em;
            font-weight: bold;
            color: #3498db;
            width: 120px; /* 時間表示の幅を固定 */
            flex-shrink: 0; /* 縮小しない */
        }
        .event-details {
            flex-grow: 1; /* 残りのスペースを埋める */
            margin-left: 20px;
            display: flex; /* タイトルとボタンを並べるため */
            justify-content: space-between; /* タイトルとボタンを左右に配置 */
            align-items: center; /* 垂直方向中央揃え */
        }
        .event-details h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.4em;
        }
        .event-details p {
            margin: 0;
            color: #666;
            font-size: 0.95em;
        }
        .no-events {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        #status-message {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.8em;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: none; /* 初期は非表示 */
            max-width: 800px;
            margin: 20px auto;
        }
        #status-message.status-default {
            background-color: #e3f2fd; /* 青系 */
            color: #1565c0; /* 濃い青 */
        }
        #status-message.status-occupied {
            background-color: #fff3e0; /* オレンジ系 */
            color: #e65100; /* 濃いオレンジ */
        }
        #status-message.status-pre-announce {
            background-color: #e8f5e9; /* 緑系 */
            color: #2e7d32; /* 濃い緑 */
        }

        #current-time {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1.1em;
        }
        #action-buttons {
            text-align: center;
            margin-top: 20px;
            max-width: 800px;
            margin: 20px auto;
        }
        #action-buttons button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        #action-buttons button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .delete-event-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        body.theme-meeting-room #status-message.status-default { background-color: #e3f2fd; color: #1565c0; }
        body.theme-meeting-room #status-message.status-occupied { background-color: #fff3e0; color: #e65100; }
        body.theme-meeting-room #status-message.status-pre-announce { background-color: #e8f5e9; color: #2e7d32; }
        body.theme-reception #status-message.status-default { background-color: #fce4ec; color: #ad1457; }
        body.theme-reception #status-message.status-occupied { background-color: #ffe0b2; color: #ef6c00; }
        body.theme-reception #status-message.status-pre-announce { background-color: #e0f2f7; color: #0277bd; }
        body.theme-reception h1 { color: #ad1457; }
        body.theme-reception .time { color: #ad1457; }
        body.theme-free-space #status-message.status-default { background-color: #e0f7fa; color: #00838f; }
        body.theme-free-space #status-message.status-occupied { background-color: #f1f8e9; color: #558b2f; }
        body.theme-free-space #status-message.status-pre-announce { background-color: #ede7f6; color: #5e35b1; }
        body.theme-free-space h1 { color: #00838f; }
        body.theme-free-space .time { color: #00838f; }

        #settings-button {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #607d8b;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <button id="settings-button">設定</button>

    <h1 id="main-title">今日の会議室スケジュール</h1>
    <div id="status-message"></div>
    <div id="action-buttons">
        <button id="book-now-30min">今から30分予約</button>
    </div>
    <div id="schedule-container">
        <p class="no-events">スケジュールを読み込み中...</p>
    </div>
    <div id="current-time"></div>

    <script>
        // ★★★ 設定をローカルストレージから読み込む ★★★
        const savedSettings = JSON.parse(localStorage.getItem('meetingRoomSettings')) || {};

        // 必須の基本設定
        const CLOUD_FUNCTION_BASE_URL = savedSettings.cloudFunctionUrl || 'YOUR_CLOUD_FUNCTION_URL'; // Cloud Functions URL
        const CLIENT_ID = savedSettings.clientId || ''; // CLIENT_ID
        const CALENDAR_ID = savedSettings.calendarId || 'your-calendar-id@group.calendar.google.com'; // GoogleカレンダーID

        // その他の設定はデフォルト値
        const CALENDAR_DISPLAY_NAME = '会議室';
        const REFRESH_INTERVAL_MS = 60 * 1000; // 60秒
        const DISPLAY_THEME = 'meeting-room';
        const PRE_ANNOUNCE_MINUTES = 15;
        const PRE_ANNOUNCE_PAIRS = [];
        const CURRENT_ANNOUNCE_PAIRS = [];
        const FONT_SIZE_PX = 16;

        const SCHEDULE_CACHE_KEY = 'cachedScheduleData';

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        const SCHEDULE_CONTAINER = document.getElementById('schedule-container');
        const STATUS_MESSAGE_ELEMENT = document.getElementById('status-message');
        const CURRENT_TIME_ELEMENT = document.getElementById('current-time');
        const BOOK_NOW_30MIN_BUTTON = document.getElementById('book-now-30min');
        const MAIN_TITLE_ELEMENT = document.getElementById('main-title');
        const SETTINGS_BUTTON = document.getElementById('settings-button');

        let gisInited = false;
        let gapiInited = false;
        let tokenClient;
        let previousEventsDataString = null;
        let previousStatusMessageData = { message: '', statusClass: '' };

        // Google APIクライアントライブラリの初期化
        function gapiLoaded() {
            // 必須設定が揃っているかチェック
            if (!CLIENT_ID || !CALENDAR_ID || CALENDAR_ID === 'your-calendar-id@group.calendar.google.com' || CLOUD_FUNCTION_BASE_URL === 'YOUR_CLOUD_FUNCTION_URL') {
                SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">設定が不足しています。<br>左上の「設定」ボタンから必須項目を入力してください。</p>';
                STATUS_MESSAGE_ELEMENT.style.display = 'none';
                BOOK_NOW_30MIN_BUTTON.disabled = true;
                return; // 以降の処理を中断
            }
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: 'dummy_api_key_for_gapi_init', // APIキーはCloud Functionsが代理するのでダミー値
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Google Identity Services (GIS) クライアントの初期化
        function gisLoaded() {
            if (!CLIENT_ID) {
                return; // gapiLoadedで既にメッセージが出ているので何もしない
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gisInited && gapiInited) {
                BOOK_NOW_30MIN_BUTTON.disabled = false;
            }
        }

        async function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error('Authentication Error:', resp.error);
                    alert('Googleアカウント認証に失敗しました。');
                    return;
                }
                await bookMeeting(30);
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                await bookMeeting(30);
            }
        }

        async function fetchCalendarEvents() {
            // 必須設定が揃っているかチェック
            if (!CLIENT_ID || !CALENDAR_ID || CALENDAR_ID === 'your-calendar-id@group.calendar.google.com' || CLOUD_FUNCTION_BASE_URL === 'YOUR_CLOUD_FUNCTION_URL') {
                SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">設定が不足しています。<br>左上の「設定」ボタンから必須項目を入力してください。</p>';
                STATUS_MESSAGE_ELEMENT.style.display = 'none';
                BOOK_NOW_30MIN_BUTTON.disabled = true;
                return;
            }

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

            const requestBody = {
                action: 'getEvents',
                calendarId: CALENDAR_ID,
                timeMin: startOfToday.toISOString(),
                timeMax: endOfToday.toISOString(),
            };

            try {
                const response = await fetch(CLOUD_FUNCTION_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                const currentEventsDataString = JSON.stringify(data.items);
                localStorage.setItem(SCHEDULE_CACHE_KEY, currentEventsDataString);
                console.log('最新のスケジュールデータをローカルストレージに保存しました。');

                if (currentEventsDataString !== previousEventsDataString) {
                    updateScheduleDisplay(data.items);
                    previousEventsDataString = currentEventsDataString;
                    console.log('スケジュール表示を更新しました。');
                } else {
                    console.log('スケジュールデータに変化なし。表示は更新しません。');
                }

                const newStatusMessageData = getStatusMessageData(data.items);
                if (JSON.stringify(newStatusMessageData) !== JSON.stringify(previousStatusMessageData)) {
                    updateStatusMessageDisplay(newStatusMessageData);
                    previousStatusMessageData = newStatusMessageData;
                    console.log('ステータスメッセージを更新しました。');
                } else {
                    console.log('ステータスメッセージに変化なし。表示は更新しません。');
                }

            } catch (error) {
                console.error('Error fetching calendar events:', error);
                const cachedDataString = localStorage.getItem(SCHEDULE_CACHE_KEY);
                if (cachedDataString) {
                    const cachedEvents = JSON.parse(cachedDataString);
                    updateScheduleDisplay(cachedEvents);
                    updateStatusMessageDisplay(getStatusMessageData(cachedEvents));
                    SCHEDULE_CONTAINER.innerHTML += '<p class="no-events" style="color: #e65100;">スケジュールの更新に失敗しました（オフライン表示）。</p>';
                    console.log('ネットワークエラー: キャッシュされたスケジュールを表示しています。');
                } else {
                    SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">スケジュールの読み込みに失敗しました。ネットワーク接続を確認してください。</p>';
                    STATUS_MESSAGE_ELEMENT.style.display = 'none';
                }
            }
        }

        function updateScheduleDisplay(events) {
            SCHEDULE_CONTAINER.innerHTML = '';

            if (events && events.length > 0) {
                events.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const end = event.end.dateTime || event.end.date;
                    const eventTitle = event.summary || 'タイトルなし';

                    const startDate = new Date(start);
                    const endDate = new Date(end);

                    let timeDisplay;
                    if (event.start.date && !event.start.dateTime) {
                        timeDisplay = '終日';
                    } else {
                        const startTime = startDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
                        const endTime = endDate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
                        timeDisplay = `${startTime} - ${endTime}`;
                    }

                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('schedule-item');
                    itemDiv.innerHTML = `
                        <div class="time">${timeDisplay}</div>
                        <div class="event-details">
                            <h3>${eventTitle}</h3>
                            <button class="delete-event-btn" data-event-id="${event.id}" style="background-color: #f44336; color: white; border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer; margin-left: 10px;">削除</button>
                        </div>
                    `;
                    SCHEDULE_CONTAINER.appendChild(itemDiv);
                });

                document.querySelectorAll('.delete-event-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const eventId = e.target.dataset.eventId;
                        if (confirm('この予約を削除してもよろしいですか？')) {
                            await deleteMeeting(eventId);
                        }
                    });
                });

            } else {
                SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">今日の予定はありません。</p>';
            }
        }

        function getStatusMessageData(events) {
            const now = new Date();
            let currentEvent = null;
            let nextEvent = null;

            if (events && events.length > 0) {
                for (let i = 0; i < events.length; i++) {
                    const event = events[i];
                    const start = new Date(event.start.dateTime || event.start.date);
                    const end = new Date(event.end.dateTime || event.end.date);
                    if (now >= start && now < end) {
                        currentEvent = event;
                    } else if (now < start) {
                        if (!nextEvent || start < new Date(nextEvent.start.dateTime || nextEvent.start.date)) {
                            nextEvent = event;
                        }
                    }
                }
            }

            let message = '';
            let statusClass = 'status-default';

            if (currentEvent) {
                let displaySummary = currentEvent.summary || '会議中';
                const matchedCurrentAnounce = CURRENT_ANNOUNCE_PAIRS.find(pair => currentEvent.summary && currentEvent.summary.includes(pair.key));
                
                if (matchedCurrentAnounce) {
                    const remainingPart = currentEvent.summary.replace(matchedCurrentAnounce.key, '').trim();
                    displaySummary = `${remainingPart}${matchedCurrentAnounce.value}`;
                }
                
                message = `<img src="https://img.icons8.com/ios-filled/50/2e7d32/meeting-room.png" alt="meeting icon" style="vertical-align: middle; margin-right: 10px;">${displaySummary}、ご利用中です`;
                statusClass = 'status-occupied';
            } else if (nextEvent) {
                const nextStartTime = new Date(nextEvent.start.dateTime || nextEvent.start.date);
                const diffMinutes = Math.floor((nextStartTime - now) / (1000 * 60));
                
                if (diffMinutes <= PRE_ANNOUNCE_MINUTES && diffMinutes >= 0) {
                    let displaySummary = nextEvent.summary || 'ご予約';
                    const matchedPreAnounce = PRE_ANNOUNCE_PAIRS.find(pair => nextEvent.summary && nextEvent.summary.includes(pair.key));

                    if (matchedPreAnounce) {
                        const remainingPart = nextEvent.summary.replace(matchedPreAnounce.key, '').trim();
                        displaySummary = `${remainingPart}${matchedPreAnounce.value}`;
                    }

                    message = `<img src="https://img.icons8.com/ios-filled/50/2e7d32/handshake.png" alt="welcome icon" style="vertical-align: middle; margin-right: 10px;">${displaySummary}！`;
                    statusClass = 'status-pre-announce';
                } else {
                    message = `<img src="https://img.icons8.com/ios-filled/50/7f8c8d/clock.png" alt="empty icon" style="vertical-align: middle; margin-right: 10px;">会議室は現在空室です`;
                    statusClass = 'status-default';
                }
            } else {
                message = `<img src="https://img.icons8.com/ios-filled/50/7f8c8d/clock.png" alt="empty icon" style="vertical-align: middle; margin-right: 10px;">会議室は現在空室です`;
                statusClass = 'status-default';
            }
            return { message: message, statusClass: statusClass };
        }

        function updateStatusMessageDisplay(statusData) {
            STATUS_MESSAGE_ELEMENT.innerHTML = statusData.message;
            STATUS_MESSAGE_ELEMENT.className = '';
            STATUS_MESSAGE_ELEMENT.classList.add(statusData.statusClass);
            STATUS_MESSAGE_ELEMENT.style.display = 'block';
        }

        function updateCurrentTime() {
            const now = new Date();
            CURRENT_TIME_ELEMENT.textContent = now.toLocaleString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        async function bookMeeting(durationMinutes) {
            const now = new Date();
            const endTime = new Date(now.getTime() + durationMinutes * 60 * 1000);

            const event = {
                'summary': '臨時会議（今すぐ予約）',
                'description': '会議室サイネージからの自動予約',
                'start': {
                    'dateTime': now.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                },
                'end': {
                    'dateTime': endTime.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                },
                'reminders': {
                    'useDefault': false,
                    'overrides': [
                        {'method': 'email', 'minutes': 30},
                        {'method': 'popup', 'minutes': 10},
                    ],
                },
            };

            const requestBody = {
                action: 'insertEvent',
                calendarId: CALENDAR_ID,
                event: event,
            };

            try {
                const response = await fetch(CLOUD_FUNCTION_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    },
                    body: JSON.stringify(requestBody),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Event created: ', data);
                alert(`${durationMinutes}分の会議を予約しました！`);
                fetchCalendarEvents();
            } catch (err) {
                console.error('Error creating event: ', err);
                alert('会議の予約に失敗しました。認証エラーか、カレンダーに書き込み権限がありません。');
            }
        }

        async function deleteMeeting(eventId) {
            const requestBody = {
                action: 'deleteEvent',
                calendarId: CALENDAR_ID,
                eventId: eventId,
            };

            try {
                const response = await fetch(CLOUD_FUNCTION_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    },
                    body: JSON.stringify(requestBody),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Event deleted: ', data);
                alert('会議予約を削除しました。');
                fetchCalendarEvents();
            } catch (err) {
                console.error('Error deleting event: ', err);
                alert('会議予約の削除に失敗しました。認証エラーか、カレンダーに書き込み権限がありません。');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.title = `${CALENDAR_DISPLAY_NAME} スケジュール`;
            MAIN_TITLE_ELEMENT.textContent = `${CALENDAR_DISPLAY_NAME} スケジュール`;
            document.body.style.fontSize = `${FONT_SIZE_PX}px`;
            document.body.classList.add(`theme-${DISPLAY_THEME}`);

            // 必須設定（CLIENT_ID, CALENDAR_ID, CLOUD_FUNCTION_BASE_URL）が不足している場合の警告表示
            if (!CLIENT_ID || !CALENDAR_ID || CALENDAR_ID === 'your-calendar-id@group.calendar.google.com' || CLOUD_FUNCTION_BASE_URL === 'YOUR_CLOUD_FUNCTION_URL') {
                SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">設定が不足しています。<br>左上の「設定」ボタンから必須項目を入力してください。</p>';
                STATUS_MESSAGE_ELEMENT.style.display = 'none';
                BOOK_NOW_30MIN_BUTTON.disabled = true;
                return;
            }

            const cachedDataString = localStorage.getItem(SCHEDULE_CACHE_KEY);
            if (cachedDataString) {
                const cachedEvents = JSON.parse(cachedDataString);
                updateScheduleDisplay(cachedEvents);
                updateStatusMessageDisplay(getStatusMessageData(cachedEvents));
                console.log('初期ロード: キャッシュされたスケジュールを表示しています。');
            } else {
                SCHEDULE_CONTAINER.innerHTML = '<p class="no-events">スケジュールを読み込み中...</p>';
            }
            
            fetchCalendarEvents();
            updateCurrentTime();
            BOOK_NOW_30MIN_BUTTON.addEventListener('click', handleAuthClick);
            BOOK_NOW_30MIN_BUTTON.disabled = true;

            SETTINGS_BUTTON.addEventListener('click', () => {
                window.location.href = 'settings.html';
            });
        });

        setInterval(() => {
            fetchCalendarEvents();
            updateCurrentTime();
        }, REFRESH_INTERVAL_MS);
    </script>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>
