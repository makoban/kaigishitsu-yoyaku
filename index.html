<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示アプリ</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; }
        #main-screen, #settings-screen {
            border: 1px solid #eee;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        #calendar-events { border: 1px solid #ccc; padding: 15px; margin-top: 20px; }
        .event-item { margin-bottom: 10px; padding: 8px; background-color: #f9f9f9; border-left: 5px solid #007bff; }
        .event-title { font-weight: bold; }
        .event-time { font-size: 0.9em; color: #555; }
        .event-location { font-size: 0.8em; color: #777; }
        .no-events { color: #888; }
        button { padding: 8px 15px; cursor: pointer; margin-right: 5px; }
        #calendarListSelect { width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .auth-status { margin-top: 10px; font-size: 0.9em; color: #555; }
        .auth-status.authenticated { color: green; }
        .auth-status.unauthenticated { color: red; }
    </style>
</head>
<body>
    <div id="main-screen" class="hidden">
        <h1>会議室の今日の予定</h1>
        <p>表示中のカレンダー: <span id="currentCalendarName">未設定</span></p>
        <div>
            <button id="loadEventsButton">予定を更新</button>
            <button id="book30MinButton">30分予約</button>
            <button id="goToSettingsButton">設定</button>
        </div>
        <div id="calendar-events">
            <p class="no-events">ここに今日の予定が表示されます。</p>
        </div>
    </div>

    <div id="settings-screen" class="hidden">
        <h1>設定</h1>
        <p>Googleアカウントを認証し、表示するカレンダーを選択してください。</p>
        <div class="auth-status" id="authStatus">未認証</div>
        <button id="authGoogleButton">Googleアカウントで認証</button>
        <button id="signOutButton" class="hidden">ログアウト</button>
        
        <div id="calendarSelectionArea" class="hidden">
            <h2>利用可能なカレンダー</h2>
            <select id="calendarListSelect" size="10">
                </select>
            <button id="saveSettingsButton">このカレンダーに設定</button>
        </div>
        <button id="backToMainButton" class="hidden">メイン画面に戻る</button>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // *** ここにAPIキーとクライアントIDを設定します ***
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8'; // あなたのAPIキーに置き換えてください
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; // あなたのOAuth 2.0 クライアントIDに置き換えてください
        
        // APIスコープ (カレンダーの読み取り、書き込み、カレンダーリストの取得)
        const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events'; 
        // calendar.eventsは古いスコープなのでcalendarだけで十分な場合が多いですが、念のため
        // https://www.googleapis.com/auth/calendar.readonly はカレンダーリスト取得にも使えますが、書き込みにはcalendarが必要です。

        const LOCAL_STORAGE_CALENDAR_KEY = 'selectedCalendar'; // localStorageのキー

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let pendingAction = null; // 認証後に実行するアクションを保持する変数

        // 各画面要素の参照
        const mainScreen = document.getElementById('main-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const currentCalendarNameSpan = document.getElementById('currentCalendarName');
        const loadEventsButton = document.getElementById('loadEventsButton');
        const book30MinButton = document.getElementById('book30MinButton');
        const goToSettingsButton = document.getElementById('goToSettingsButton');

        const authStatusDiv = document.getElementById('authStatus');
        const authGoogleButton = document.getElementById('authGoogleButton');
        const signOutButton = document.getElementById('signOutButton');
        const calendarSelectionArea = document.getElementById('calendarSelectionArea');
        const calendarListSelect = document.getElementById('calendarListSelect');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToMainButton = document.getElementById('backToMainButton');

        let selectedCalendarId = ''; // 現在選択されているカレンダーID
        let selectedCalendarName = ''; // 現在選択されているカレンダー名

        // --- 初期化処理 ---

        /**
         * Google APIクライアントライブラリがロードされたときに呼び出されます。
         */
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        /**
         * gapiクライアントを初期化します。
         */
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            });
            gapiInited = true;
            console.log("gapi client initialized.");
            checkAndNavigate(); // 初期化後に画面遷移をチェック
        }

        /**
         * Google Identity Servicesライブラリがロードされたときに呼び出されます。
         */
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthCallback,
            });
            gisInited = true;
            console.log("gis client initialized.");
            checkAndNavigate(); // 初期化後に画面遷移をチェック
        }

        /**
         * gapiとgisの両方が初期化されたら、保存された設定に基づいて画面を切り替えます。
         */
        function checkAndNavigate() {
            if (gapiInited && gisInited) {
                const storedCalendar = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_KEY));
                if (storedCalendar && storedCalendar.id && storedCalendar.name) {
                    selectedCalendarId = storedCalendar.id;
                    selectedCalendarName = storedCalendar.name;
                    showMainScreen();
                } else {
                    showSettingsScreen();
                }
                updateAuthStatus(); // 認証状態を更新
                updateButtonStates(); // ボタンの状態を更新
            }
        }

        // --- 画面表示制御 ---

        function showMainScreen() {
            mainScreen.classList.remove('hidden');
            settingsScreen.classList.add('hidden');
            currentCalendarNameSpan.textContent = selectedCalendarName;
            fetchAndDisplayEvents(); // メイン画面表示時にイベントを読み込む
        }

        function showSettingsScreen() {
            mainScreen.classList.add('hidden');
            settingsScreen.classList.remove('hidden');
            updateAuthStatus(); // 設定画面表示時に認証状態を更新
            updateCalendarListUI(); // カレンダーリストUIを更新
        }

        // --- 認証関連 ---

        /**
         * 認証コールバック処理。認証成功後に保留中のアクションを実行します。
         */
        async function handleAuthCallback(resp) {
            if (resp.error !== undefined) {
                console.error("認証エラー:", resp);
                alert(`認証に失敗しました: ${resp.error}`);
                pendingAction = null;
                updateAuthStatus();
                updateButtonStates();
                return;
            }
            console.log("認証成功:", resp);
            updateAuthStatus(); // 認証成功後に認証状態を更新
            updateButtonStates(); // ボタンの状態を更新

            // 保留中のアクションがあれば実行
            if (pendingAction) {
                const actionToPerform = pendingAction;
                pendingAction = null;
                await actionToPerform();
            } else {
                // 認証ボタンからの認証の場合、カレンダーリストを自動で取得
                await fetchCalendarList();
            }
        }

        /**
         * 認証フローを開始します。
         */
        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                // トークンがない場合、認証フローを開始
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // 既存のトークンがある場合、そのまま利用
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        /**
         * ログアウトします。
         */
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateAuthStatus();
                updateButtonStates();
                calendarSelectionArea.classList.add('hidden'); // カレンダー選択エリアを非表示に
                calendarListSelect.innerHTML = ''; // リストをクリア
                localStorage.removeItem(LOCAL_STORAGE_CALENDAR_KEY); // 保存されたカレンダー設定も削除
                selectedCalendarId = '';
                selectedCalendarName = '';
                alert("ログアウトしました。保存されたカレンダー設定も削除されました。");
            }
        }

        /**
         * 認証状態に基づいてUIを更新します。
         */
        function updateAuthStatus() {
            if (gapi.client.getToken() === null) {
                authStatusDiv.textContent = '未認証';
                authStatusDiv.className = 'auth-status unauthenticated';
                authGoogleButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');
            } else {
                authStatusDiv.textContent = '認証済み';
                authStatusDiv.className = 'auth-status authenticated';
                authGoogleButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');
            }
        }

        // --- カレンダーリストの取得と表示 ---

        /**
         * 認証済みアカウントに紐づくカレンダーのリストを取得し、ドロップダウンに表示します。
         */
        async function fetchCalendarList() {
            if (gapi.client.getToken() === null) {
                alert('カレンダーリストを取得するにはGoogleアカウントでの認証が必要です。');
                return;
            }

            calendarListSelect.innerHTML = '<option>カレンダーを読み込み中...</option>';
            calendarSelectionArea.classList.remove('hidden');

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items;

                calendarListSelect.innerHTML = ''; // 既存のオプションをクリア

                if (calendars.length > 0) {
                    calendars.forEach(calendar => {
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = calendar.summary;
                        // 現在設定されているカレンダーがあれば選択状態にする
                        if (calendar.id === selectedCalendarId) {
                            option.selected = true;
                        }
                        calendarListSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'カレンダーが見つかりませんでした。';
                    option.disabled = true;
                    calendarListSelect.appendChild(option);
                }
            } catch (err) {
                console.error('カレンダーリストの取得中にエラーが発生しました:', err);
                alert(`カレンダーリストの取得に失敗しました: ${err.message || JSON.stringify(err)}`);
                calendarListSelect.innerHTML = '<option>カレンダーの取得に失敗しました。</option>';
            }
        }

        /**
         * 設定画面のカレンダーリストUIの状態を更新します。
         */
        function updateCalendarListUI() {
            if (gapi.client.getToken() !== null) {
                calendarSelectionArea.classList.remove('hidden');
                fetchCalendarList(); // 認証済みならカレンダーリストを自動で読み込む
            } else {
                calendarSelectionArea.classList.add('hidden');
                calendarListSelect.innerHTML = '';
            }
        }

        // --- 設定の保存 ---

        /**
         * 選択されたカレンダーを設定として保存し、メイン画面に遷移します。
         */
        function saveSettings() {
            const selectedOption = calendarListSelect.options[calendarListSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedCalendarId = selectedOption.value;
                selectedCalendarName = selectedOption.textContent;
                localStorage.setItem(LOCAL_STORAGE_CALENDAR_KEY, JSON.stringify({
                    id: selectedCalendarId,
                    name: selectedCalendarName
                }));
                alert(`カレンダー「${selectedCalendarName}」が設定されました。`);
                showMainScreen();
            } else {
                alert('表示するカレンダーを選択してください。');
            }
        }

        // --- メイン画面の機能 (既存ロジックの修正) ---

        /**
         * ボタンの表示状態を更新します。（メイン画面用）
         */
        function updateButtonStates() {
            // 30分予約ボタンの表示を更新
            if (gapi.client.getToken() === null) {
                book30MinButton.textContent = '認証必要：30分予約';
                book30MinButton.style.backgroundColor = '#ffc107'; // 注意を促す色
            } else {
                book30MinButton.textContent = '30分予約';
                book30MinButton.style.backgroundColor = ''; // デフォルトの色に戻す
            }
        }

        /**
         * カレンダーイベントをフェッチして表示します。
         */
        async function fetchAndDisplayEvents() {
            const eventsDiv = document.getElementById('calendar-events');
            eventsDiv.innerHTML = '<p>読み込み中...</p>';

            if (!selectedCalendarId) {
                eventsDiv.innerHTML = '<p class="no-events">カレンダーが設定されていません。設定画面から選択してください。</p>';
                return;
            }

            if (!gapiInited) {
                eventsDiv.innerHTML = '<p style="color: red;">APIクライアントがまだ初期化されていません。しばらくお待ちください。</p>';
                console.error("gapi client not initialized.");
                return;
            }

            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                const response = await gapi.client.calendar.events.list({
                    'calendarId': selectedCalendarId, // 設定されたカレンダーIDを使用
                    'timeMin': today.toISOString(),
                    'timeMax': tomorrow.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                });

                const events = response.result.items;
                eventsDiv.innerHTML = '';

                if (events.length > 0) {
                    events.forEach(event => {
                        const start = event.start.dateTime || event.start.date;
                        const end = event.end.dateTime || event.end.date;

                        const eventItem = document.createElement('div');
                        eventItem.className = 'event-item';

                        const title = document.createElement('div');
                        title.className = 'event-title';
                        title.textContent = event.summary || 'タイトルなし';
                        eventItem.appendChild(title);

                        const time = document.createElement('div');
                        time.className = 'event-time';
                        if (event.start.dateTime) {
                            const startDate = new Date(start);
                            const endDate = new Date(end);
                            time.textContent = `${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()}`;
                        } else {
                            time.textContent = '終日';
                        }
                        eventItem.appendChild(time);

                        if (event.location) {
                            const location = document.createElement('div');
                            location.className = 'event-location';
                            location.textContent = `場所: ${event.location}`;
                            eventItem.appendChild(location);
                        }

                        eventsDiv.appendChild(eventItem);
                    });
                } else {
                    eventsDiv.innerHTML = '<p class="no-events">今日の予定はありません。</p>';
                }
            } catch (err) {
                console.error('カレンダーイベントの取得中にエラーが発生しました:', err);
                eventsDiv.innerHTML = `<p style="color: red;">エラーが発生しました: ${err.message || JSON.stringify(err)}</p>`;
            }
        }

        /**
         * 現在時刻から30分間の緊急会議イベントを作成します。
         */
        async function create30MinEvent() {
            if (!selectedCalendarId) {
                alert('カレンダーが設定されていません。設定画面から選択してください。');
                return;
            }

            // 認証済みであることを前提とする（この関数は認証後に呼び出されるため）
            if (gapi.client.getToken() === null) {
                console.error("認証されていない状態でcreate30MinEventが呼び出されました。");
                alert("認証が必要です。再度ボタンをクリックしてください。");
                return;
            }

            const now = new Date();
            const start = new Date(now);
            const end = new Date(now.getTime() + 30 * 60 * 1000);

            const event = {
                'summary': '緊急会議 (30分)',
                'start': {
                    'dateTime': start.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                },
                'end': {
                    'dateTime': end.toISOString(),
                    'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                },
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': selectedCalendarId, // 設定されたカレンダーIDを使用
                    'resource': event,
                });
                console.log('イベントが作成されました:', response.result);
                alert(`カレンダー「${selectedCalendarName}」に30分間の緊急会議が予約されました！`);
                fetchAndDisplayEvents(); // イベント作成後、カレンダーを再読み込みして表示を更新
            } catch (err) {
                console.error('イベントの作成中にエラーが発生しました:', err);
                alert(`イベントの作成に失敗しました: ${err.message || JSON.stringify(err)}`);
            }
        }

        // --- イベントリスナーの設定 ---

        // メイン画面のボタン
        loadEventsButton.addEventListener('click', fetchAndDisplayEvents);
        goToSettingsButton.addEventListener('click', showSettingsScreen);

        // 30分予約ボタンのクリックイベント (メイン画面)
        book30MinButton.addEventListener('click', async () => {
            if (gapi.client.getToken() === null) {
                // 未認証の場合、認証フローを開始し、認証後にcreate30MinEventを実行
                pendingAction = create30MinEvent; // 認証後に実行するアクションをセット
                tokenClient.requestAccessToken({prompt: 'consent'}); // 認証ダイアログを表示
            } else {
                // 認証済みの場合、直接create30MinEventを実行
                await create30MinEvent();
            }
        });

        // 設定画面のボタン
        authGoogleButton.addEventListener('click', handleAuthClick);
        signOutButton.addEventListener('click', handleSignoutClick);
        saveSettingsButton.addEventListener('click', saveSettings);
        backToMainButton.addEventListener('click', showMainScreen);

        // 初期ロード時の処理は checkAndNavigate() で行われる
    </script>
</body>
</html>
