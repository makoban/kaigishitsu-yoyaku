<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示（グーグルカレンダー連携）</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        #authorize_button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #4285f4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #authorize_button:hover {
            background-color: #357ae8;
        }
        #authorize_button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        .panel {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel ul {
            list-style-type: none; /* デフォルトのリストスタイルを削除 */
            padding: 0;
        }
        .panel li {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #555;
            display: flex;
            align-items: center; /* アイテムを縦方向中央揃え */
            justify-content: space-between; /* 要素を両端に配置 */
            padding: 8px 0;
            border-bottom: 1px dashed #eee; /* リストアイテム間の区切り線 */
        }
        .panel li:last-child {
            border-bottom: none; /* 最後のアイテムは区切り線なし */
        }
        .select-button {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .select-button:hover {
            background-color: #218838;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 15px;
        }
        .event-item {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .event-time {
            font-weight: bold;
            color: #0056b3;
            margin-right: 10px;
        }
        .event-summary {
            color: #333;
        }
        .no-events {
            font-style: italic;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>会議室予約表示</h1>

    <p>以下のボタンをクリックしてGoogleアカウントを選択し、利用可能なカレンダーを表示します。</p>
    <button id="authorize_button" disabled>Googleアカウントを選択</button>

    <div id="container">
        <div id="calendar_list_container" class="panel">
            <h2>自分で作成したカレンダー</h2>
            <ul id="calendar_list">
                <li>ボタンをクリックして認証を開始してください。</li>
            </ul>
        </div>

        <div id="event_list_container" class="panel">
            <h2>選択されたカレンダーのイベント</h2>
            <p id="selected_calendar_info">カレンダーが選択されていません。</p>
            <ul id="event_list">
                <li>ここにイベントが表示されます。</li>
            </ul>
        </div>
    </div>
    <p id="error_display" class="error-message"></p>

    <script>
        // ★★★ ここをあなたの情報に置き換えてください ★★★
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; // 例: 123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8';           // 例: AIzaSyB_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        // ★★★ ここまで ★★★

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly'; // カレンダーの読み取り専用スコープ

        const LOCAL_STORAGE_CALENDAR_ID_KEY = 'selectedCalendarId';
        const LOCAL_STORAGE_CALENDAR_SUMMARY_KEY = 'selectedCalendarSummary';

        let tokenClient; // Google Identity Services (GIS) のトークンクライアント
        let selectedCalendarId = null; // 選択されたカレンダーIDを保持する変数
        let selectedCalendarSummary = null; // 選択されたカレンダーのサマリーを保持する変数

        // HTMLコンテンツの読み込みが完了したら初期化処理を開始
        document.addEventListener('DOMContentLoaded', () => {
            const authorizeButton = document.getElementById('authorize_button');
            authorizeButton.onclick = handleAuthClick;

            gapi.load('client', initGapiClient);
        });

        function initGapiClient() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            }).then(() => {
                console.log('gapi client initialized.');

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            console.log('アクセストークンを取得しました:', tokenResponse);
                            
                            // 認証後、localStorageからカレンダーIDを読み込み、イベントを表示
                            const savedCalendarId = localStorage.getItem(LOCAL_STORAGE_CALENDAR_ID_KEY);
                            const savedCalendarSummary = localStorage.getItem(LOCAL_STORAGE_CALENDAR_SUMMARY_KEY);

                            if (savedCalendarId && savedCalendarSummary) {
                                selectedCalendarId = savedCalendarId;
                                selectedCalendarSummary = savedCalendarSummary;
                                document.getElementById('selected_calendar_info').textContent = `選択中のカレンダー: ${selectedCalendarSummary} (前回選択)`;
                                console.log('保存されたカレンダーを読み込みました:', selectedCalendarId);
                                listEvents(selectedCalendarId);
                            } else {
                                // 保存されたカレンダーがなければ、カレンダーリストを表示し、ユーザーに選択を促す
                                listCalendars(); 
                                document.getElementById('selected_calendar_info').textContent = 'カレンダーが選択されていません。リストから選択してください。';
                            }
                            
                        } else {
                            console.error('アクセストークンの取得に失敗しました。', tokenResponse);
                            displayError('Googleアカウントの認証に失敗しました。再度お試しください。');
                            // 失敗時は認証ボタンを再度有効にする
                            document.getElementById('authorize_button').disabled = false;
                        }
                    },
                    error_callback: (error) => {
                        console.error('GISトークンクライアントエラー:', error);
                        displayError('認証エラーが発生しました。コンソールを確認してください。');
                        // エラー時は認証ボタンを再度有効にする
                        document.getElementById('authorize_button').disabled = false;
                    }
                    // ux_mode: 'redirect', // クロスオリジンエラーが続く場合は有効化を検討
                    // redirect_uri: 'https://makoban.github.io' // OAuth設定の承認済みリダイレクトURIと一致させる
                });

                // ★ここに自動認証のロジックを追加★
                // ページロード時に、有効なセッションがあれば自動的にトークンをリクエスト
                // prompt: '' でサイレント認証を試みる。これにより、2回目以降のアクセスでアカウント選択をスキップ可能。
                tokenClient.requestAccessToken({ prompt: '' }); 

            }).catch(err => {
                console.error('gapiクライアントの初期化エラー:', err);
                displayError('APIクライアントの初期化に失敗しました。APIキーまたはネットワーク接続を確認してください。');
                document.getElementById('authorize_button').disabled = false;
            });
        }

        // handleAuthClick 関数は、手動で認証ボタンが押されたときのみ呼ばれる
        function handleAuthClick() {
            // 手動認証時はアカウント選択画面を出すことを強制する (prompt: 'select_account')
            // これにより、ユーザーが別のアカウントを選び直すことが可能。
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: 'select_account' }); 
            } else {
                console.error('トークンクライアントが初期化されていません。');
                displayError('認証クライアントが準備できていません。ページをリロードしてください。');
            }
        }
        
        async function listCalendars() {
            const calendarListUl = document.getElementById('calendar_list');
            calendarListUl.innerHTML = ''; // 既存のリストをクリア
            displayError(''); // エラーメッセージをクリア

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const allCalendars = response.result.items;

                // オーナー権限を持つカレンダーのみをフィルタリング
                const ownedCalendars = allCalendars.filter(calendar => calendar.accessRole === 'owner');

                if (ownedCalendars && ownedCalendars.length > 0) {
                    ownedCalendars.forEach(calendar => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${calendar.summary}</span>
                            <button class="select-button" data-calendar-id="${calendar.id}" data-calendar-summary="${calendar.summary}">選択</button>
                        `;
                        calendarListUl.appendChild(li);
                    });
                    console.log('オーナーカレンダーリストを正常に表示しました:', ownedCalendars);

                    // 各「選択」ボタンにイベントリスナーを追加
                    document.querySelectorAll('.select-button').forEach(button => {
                        button.onclick = (event) => {
                            const newSelectedId = event.target.dataset.calendarId;
                            const newSelectedSummary = event.target.dataset.calendarSummary;
                            
                            // localStorageに選択されたカレンダーを保存
                            localStorage.setItem(LOCAL_STORAGE_CALENDAR_ID_KEY, newSelectedId);
                            localStorage.setItem(LOCAL_STORAGE_CALENDAR_SUMMARY_KEY, newSelectedSummary);

                            selectedCalendarId = newSelectedId;
                            selectedCalendarSummary = newSelectedSummary;
                            document.getElementById('selected_calendar_info').textContent = `選択中のカレンダー: ${selectedCalendarSummary}`;
                            console.log('カレンダーが選択され、保存されました:', selectedCalendarId);
                            listEvents(selectedCalendarId); // イベントリストを取得して表示
                        };
                    });

                } else {
                    const li = document.createElement('li');
                    li.textContent = '自分で作成したカレンダーが見つかりませんでした。';
                    calendarListUl.appendChild(li);
                    console.log('オーナーカレンダーが見つかりませんでした。');
                }
            } catch (err) {
                console.error('カレンダーリストの取得エラー:', err.result ? err.result.error : err);
                displayError(`カレンダーリストの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
            }
        }

        async function listEvents(calendarId) {
            const eventListUl = document.getElementById('event_list');
            eventListUl.innerHTML = ''; // 既存のイベントリストをクリア
            displayError(''); // エラーメッセージをクリア

            // 現在時刻を基準に、前2時間と後12時間の期間を設定
            const now = new Date();
            const timeMin = new Date(now.getTime() - (2 * 60 * 60 * 1000)).toISOString(); // 2時間前
            const timeMax = new Date(now.getTime() + (12 * 60 * 60 * 1000)).toISOString(); // 12時間後

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': calendarId,
                    'timeMin': timeMin,
                    'timeMax': timeMax,
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                    'maxResults': 20
                });

                const events = response.result.items;

                if (events && events.length > 0) {
                    events.forEach(event => {
                        const start = event.start.dateTime || event.start.date;
                        const end = event.end.dateTime || event.end.date;

                        // 開始日時と終了日時をフォーマット
                        const startDate = new Date(start).toLocaleDateString('ja-JP');
                        const startTime = new Date(start).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const endTime = new Date(end).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const li = document.createElement('li');
                        li.className = 'event-item';
                        // 全日イベントの場合の表示調整
                        if (event.start.date && !event.start.dateTime) { // 全日イベントの場合
                             li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} (終日)</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        } else {
                            li.innerHTML = `
                                <div>
                                    <span class="event-time">${startDate} ${startTime} - ${endTime}</span>
                                    <span class="event-summary">${event.summary || 'タイトルなし'}</span>
                                </div>
                            `;
                        }
                        eventListUl.appendChild(li);
                    });
                    console.log(`イベントを正常に表示しました (${calendarId}):`, events);
                } else {
                    const li = document.createElement('li');
                    li.className = 'no-events';
                    li.textContent = '指定された期間にイベントが見つかりませんでした。';
                    eventListUl.appendChild(li);
                    console.log(`イベントが見つかりませんでした (${calendarId})。`);
                }
            } catch (err) {
                console.error(`イベントの取得エラー (${calendarId}):`, err.result ? err.result.error : err);
                displayError(`イベントの取得中にエラーが発生しました: ${err.result && err.result.error && err.result.error.message ? err.result.error.message : err.message}`);
                const li = document.createElement('li');
                li.className = 'error-message';
                li.textContent = 'イベントの読み込みに失敗しました。';
                eventListUl.appendChild(li);
            }
        }

        // エラーメッセージを表示するヘルパー関数
        function displayError(msg) {
            const errorDisplay = document.getElementById('error_display');
            errorDisplay.textContent = msg ? `エラー: ${msg}` : '';
            if (msg) console.error("表示エラー:", msg);
        }
    </script>
</body>
</html>
