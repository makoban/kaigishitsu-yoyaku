<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示アプリ - カレンダー設定</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; }
        #settings-screen {
            border: 1px solid #eee;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        button { padding: 8px 15px; cursor: pointer; margin-right: 5px; }
        #calendarListSelect { width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .account-info-display { margin-top: 10px; font-size: 0.9em; color: #555; } /* クラス名変更 */
        .account-info-display.set { color: green; }
        .account-info-display.unset { color: red; }
        #accountEmailDisplay { font-weight: bold; margin-left: 5px; } /* id名変更 */
        .settings-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="settings-screen">
        <h1>カレンダー設定</h1> <p>メイン画面でGoogleアカウントを選択した後、ここで表示するカレンダーを設定してください。</p> <div class="account-info-display" id="accountInfoDisplay">Googleアカウントが選択されていません</div> 
        <span id="accountEmailDisplay" class="hidden"></span> 
        
        <div class="settings-section" id="calendarSelectionArea"> <h2>利用可能なカレンダー</h2>
            <p>ここに表示されるカレンダーから、メイン画面で表示するカレンダーを選んでください。</p>
            <select id="calendarListSelect" size="10">
                <option>Googleアカウントを選択してください。</option> </select>
            <button id="saveSettingsButton">このカレンダーに設定</button>
        </div>
        <button id="backToMainButton">メイン画面に戻る</button>
    </div>

    <script>
        // --- 設定値（共通） ---
        // これらの定数はindex.htmlと一致させる
        const LOCAL_STORAGE_CALENDAR_KEY = 'selectedCalendar'; 
        const LOCAL_STORAGE_ACCOUNT_EMAIL_KEY = 'authenticatedAccountEmail'; 
        const LOCAL_STORAGE_CALENDAR_LIST_KEY = 'calendarList'; 
        const APP_VERSION = '1.0.4'; 

        // --- 画面要素の参照 ---
        const accountInfoDisplayDiv = document.getElementById('accountInfoDisplay'); // id変更
        const accountEmailDisplaySpan = document.getElementById('accountEmailDisplay'); // id変更
        const calendarSelectionArea = document.getElementById('calendarSelectionArea');
        const calendarListSelect = document.getElementById('calendarListSelect');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToMainButton = document.getElementById('backToMainButton');

        let selectedCalendarId = ''; 
        let selectedCalendarName = ''; 

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', initializeSettingsPage);

        function initializeSettingsPage() {
            // localStorageから現在の設定をロード
            const storedCalendar = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_KEY));
            if (storedCalendar && storedCalendar.id && storedCalendar.name) {
                selectedCalendarId = storedCalendar.id;
                selectedCalendarName = storedCalendar.name;
            }
            updateSettingsPageUI(); // 設定画面のUIを更新
        }

        /**
         * 設定画面のUIをlocalStorageの情報に基づいて更新します。
         */
        function updateSettingsPageUI() {
            const storedEmail = localStorage.getItem(LOCAL_STORAGE_ACCOUNT_EMAIL_KEY);
            const storedCalendarList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_LIST_KEY));

            if (storedEmail) {
                accountInfoDisplayDiv.textContent = 'Googleアカウント選択済み:'; // 文言変更
                accountInfoDisplayDiv.className = 'account-info-display set'; // class名変更
                accountEmailDisplaySpan.textContent = `(${storedEmail})`;
                accountEmailDisplaySpan.classList.remove('hidden');
                
                // 保存されているカレンダーリストを表示
                displayCalendarList(storedCalendarList);

            } else {
                accountInfoDisplayDiv.textContent = 'Googleアカウントが選択されていません'; // 文言変更
                accountInfoDisplayDiv.className = 'account-info-display unset'; // class名変更
                accountEmailDisplaySpan.classList.add('hidden');
                calendarListSelect.innerHTML = '<option>Googleアカウントをメイン画面で選択してください。</option>'; // デフォルト表示
            }
        }

        /**
         * localStorageから取得したカレンダーリストをドロップダウンに表示します。
         */
        function displayCalendarList(calendars) {
            calendarListSelect.innerHTML = ''; // 既存のオプションをクリア

            if (calendars && calendars.length > 0) {
                calendars.forEach(calendar => {
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.name; 
                    if (calendar.id === selectedCalendarId) {
                        option.selected = true;
                    }
                    calendarListSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = '利用可能なカレンダーが見つかりませんでした。';
                option.disabled = true;
                calendarListSelect.appendChild(option);
            }
        }

        // --- 設定の保存 ---

        function saveSettings() {
            const selectedOption = calendarListSelect.options[calendarListSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedCalendarId = selectedOption.value;
                selectedCalendarName = selectedOption.textContent;
                localStorage.setItem(LOCAL_STORAGE_CALENDAR_KEY, JSON.stringify({
                    id: selectedCalendarId,
                    name: selectedCalendarName
                }));
                alert(`カレンダー「${selectedCalendarName}」が設定されました。`);
                window.location.href = 'index.html'; 
            } else {
                alert('表示するカレンダーを選択してください。');
            }
        }

        // --- イベントリスナーの設定 ---
        
        // 設定の保存ボタン
        saveSettingsButton.addEventListener('click', saveSettings);
        
        // メイン画面へ戻るボタン
        backToMainButton.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // settings.html では認証ボタンは直接存在しないため、関連リスナーは不要
        // カレンダーリスト更新ボタンも、直接APIを叩けないため、動作を削除
        // ユーザーがカレンダーリストを更新したい場合は、メイン画面でアカウント選択を促す形にする
    </script>
</body>
</html>
