<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示アプリ - 設定</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; }
        #settings-screen {
            border: 1px solid #eee;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        button { padding: 8px 15px; cursor: pointer; margin-right: 5px; }
        #calendarListSelect { width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .account-status { margin-top: 10px; font-size: 0.9em; color: #555; }
        .account-status.selected { color: green; }
        .account-status.not-selected { color: red; }
        #authenticatedAccountEmail { font-weight: bold; margin-left: 5px; } /* メールアドレスの強調と間隔 */
        .settings-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="settings-screen">
        <h1>設定</h1>
        <p>Googleアカウントを選択し、表示するカレンダーを設定してください。</p>
        
        <div class="account-status" id="accountStatus">未選択</div> <span id="authenticatedAccountEmail" class="hidden"></span> 
        <button id="selectGoogleAccountButton">Googleアカウントを選択</button> <button id="signOutButton" class="hidden">アカウントを解除</button> <div class="settings-section" id="calendarSelectionArea" class="hidden"> <h2>利用可能なカレンダー</h2>
            <p>アカウント選択後、ここに表示されるカレンダーから、メイン画面で表示するカレンダーを選んでください。</p>
            <select id="calendarListSelect" size="10">
                </select>
            <button id="refreshCalendarListButton">カレンダーリストを更新</button> 
            <button id="saveSettingsButton">このカレンダーに設定</button>
        </div>
        <button id="backToMainButton">メイン画面に戻る</button>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- 設定値（共通） ---
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8'; 
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar'; 
        const LOCAL_STORAGE_CALENDAR_KEY = 'selectedCalendar'; 
        const APP_VERSION = '1.0.2'; // (index.htmlと一致させる)

        // --- 画面要素の参照 ---
        const accountStatusDiv = document.getElementById('accountStatus'); // id変更
        const authenticatedAccountEmailSpan = document.getElementById('authenticatedAccountEmail');
        const selectGoogleAccountButton = document.getElementById('selectGoogleAccountButton'); // id変更
        const signOutButton = document.getElementById('signOutButton');
        const calendarSelectionArea = document.getElementById('calendarSelectionArea');
        const calendarListSelect = document.getElementById('calendarListSelect');
        const refreshCalendarListButton = document.getElementById('refreshCalendarListButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToMainButton = document.getElementById('backToMainButton');

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let pendingAction = null; 

        let selectedCalendarId = ''; 
        let selectedCalendarName = ''; 

        // --- 初期化処理 ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            });
            gapiInited = true;
            console.log("gapi client initialized.");
            checkExistingAuthAndUI(); 
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthCallback,
            });
            gisInited = true;
            console.log("gis client initialized.");
            checkExistingAuthAndUI(); 
        }

        /**
         * 既存の認証状態を確認し、UIを初期化します。
         */
        function checkExistingAuthAndUI() {
            if (gapiInited && gisInited) {
                const storedCalendar = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_KEY));
                if (storedCalendar && storedCalendar.id && storedCalendar.name) {
                    selectedCalendarId = storedCalendar.id;
                    selectedCalendarName = storedCalendar.name;
                }
                updateAccountStatusUI(); // UIの認証状態を更新
            }
        }

        // --- アカウント選択・認証関連 ---

        async function handleAuthCallback(resp) {
            if (resp.error !== undefined) {
                console.error("アカウント選択エラー:", resp);
                alert(`アカウントの選択に失敗しました: ${resp.error}`);
                pendingAction = null;
                updateAccountStatusUI();
                return;
            }
            console.log("アカウント選択成功:", resp);
            
            // 認証成功時にユーザー情報を取得 (IDトークンからメールアドレス)
            const token = gapi.client.getToken();
            if (token && token.id_token) {
                try {
                    const base64Url = token.id_token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const idTokenData = JSON.parse(jsonPayload);
                    authenticatedAccountEmailSpan.textContent = `(${idTokenData.email})`; 
                    authenticatedAccountEmailSpan.classList.remove('hidden'); 
                } catch (e) {
                    console.error("IDトークン解析エラー:", e);
                    authenticatedAccountEmailSpan.textContent = `(メールアドレス取得失敗)`;
                    authenticatedAccountEmailSpan.classList.remove('hidden');
                }
            }

            updateAccountStatusUI(); 

            if (pendingAction) {
                const actionToPerform = pendingAction;
                pendingAction = null;
                await actionToPerform();
            } else {
                // アカウント選択ボタンからの遷移の場合、カレンダーリストを自動で取得
                await fetchCalendarList(); 
            }
        }

        // handleAuthClickからselectGoogleAccountClickに変更
        function selectGoogleAccountClick() {
            pendingAction = fetchCalendarList; // アカウント選択後にカレンダーリスト取得を保留アクションに設定
            tokenClient.requestAccessToken({prompt: ''}); 
        }

        // handleSignoutClickからsignOutClickに変更
        function signOutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateAccountStatusUI();
                calendarSelectionArea.classList.add('hidden'); 
                calendarListSelect.innerHTML = ''; 
                localStorage.removeItem(LOCAL_STORAGE_CALENDAR_KEY); 
                selectedCalendarId = '';
                selectedCalendarName = '';
                authenticatedAccountEmailSpan.textContent = ''; 
                authenticatedAccountEmailSpan.classList.add('hidden'); 
                alert("アカウントが解除されました。保存されたカレンダー設定も削除されました。");
            }
        }

        /**
         * アカウント選択状態に基づいてUIを更新します。（「認証」という言葉を避ける）
         */
        function updateAccountStatusUI() { // 関数名変更
            if (gapi.client.getToken() === null) {
                accountStatusDiv.textContent = 'アカウント未選択'; // 文言変更
                accountStatusDiv.className = 'account-status not-selected'; // class名変更
                selectGoogleAccountButton.classList.remove('hidden'); 
                signOutButton.classList.add('hidden');
                calendarSelectionArea.classList.add('hidden'); 
                calendarListSelect.innerHTML = ''; 
                authenticatedAccountEmailSpan.classList.add('hidden'); 
            } else {
                accountStatusDiv.textContent = 'アカウント選択済み'; // 文言変更
                accountStatusDiv.className = 'account-status selected'; // class名変更
                selectGoogleAccountButton.classList.add('hidden'); 
                signOutButton.classList.remove('hidden');
                calendarSelectionArea.classList.remove('hidden'); 
                
                const token = gapi.client.getToken();
                if (token && token.id_token) {
                    try {
                        const base64Url = token.id_token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        const idTokenData = JSON.parse(jsonPayload);
                        authenticatedAccountEmailSpan.textContent = `(${idTokenData.email})`;
                        authenticatedAccountEmailSpan.classList.remove('hidden');
                    } catch (e) {
                        console.error("IDトークン解析エラー:", e);
                    }
                }
            }
        }

        // --- カレンダーリストの取得と表示 ---

        async function fetchCalendarList() {
            if (gapi.client.getToken() === null) {
                alert('カレンダーリストを取得するにはGoogleアカウントを選択してください。'); // 文言修正
                return;
            }

            calendarListSelect.innerHTML = '<option>カレンダーを読み込み中...</option>';
            calendarSelectionArea.classList.remove('hidden'); 

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items;

                calendarListSelect.innerHTML = ''; 

                if (calendars.length > 0) {
                    calendars.forEach(calendar => {
                        if (
                            calendar.id === 'ja.japanese#holiday@group.v.calendar.google.com' || 
                            calendar.id === 'contacts@group.v.calendar.google.com' 
                        ) {
                            console.log("除外されたカレンダー:", calendar.summary, "(ID:", calendar.id, ")");
                            return; 
                        }
                        
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = calendar.summary; 
                        if (calendar.id === selectedCalendarId) {
                            option.selected = true;
                        }
                        calendarListSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'カレンダーが見つかりませんでした。';
                    option.disabled = true;
                    calendarListSelect.appendChild(option);
                }
            } catch (err) {
                console.error('カレンダーリストの取得中にエラーが発生しました:', err);
                alert(`カレンダーリストの取得に失敗しました: ${err.message || JSON.stringify(err)}`);
                calendarListSelect.innerHTML = '<option>カレンダーの取得に失敗しました。</option>';
            }
        }

        // --- 設定の保存 ---

        function saveSettings() {
            const selectedOption = calendarListSelect.options[calendarListSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedCalendarId = selectedOption.value;
                selectedCalendarName = selectedOption.textContent;
                localStorage.setItem(LOCAL_STORAGE_CALENDAR_KEY, JSON.stringify({
                    id: selectedCalendarId,
                    name: selectedCalendarName
                }));
                alert(`カレンダー「${selectedCalendarName}」が設定されました。`);
                window.location.href = 'index.html'; 
            } else {
                alert('表示するカレンダーを選択してください。');
            }
        }

        // --- イベントリスナーの設定 ---

        // 設定画面のボタン
        selectGoogleAccountButton.addEventListener('click', selectGoogleAccountClick); // 関数名変更
        signOutButton.addEventListener('click', signOutClick); // 関数名変更
        refreshCalendarListButton.addEventListener('click', async () => { 
            if (gapi.client.getToken() === null) {
                alert('カレンダーリストを更新するにはGoogleアカウントを選択してください。'); // 文言修正
            } else {
                await fetchCalendarList();
            }
        });
        saveSettingsButton.addEventListener('click', saveSettings);
        
        backToMainButton.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
