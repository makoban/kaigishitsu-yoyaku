<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示アプリ - 設定</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; }
        #settings-screen {
            border: 1px solid #eee;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        button { padding: 8px 15px; cursor: pointer; margin-right: 5px; }
        #calendarListSelect { width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .account-status-display { margin-top: 10px; font-size: 0.9em; color: #555; } /* クラス名変更 */
        .account-status-display.selected { color: green; }
        .account-status-display.not-selected { color: red; }
        #displayedAccountEmail { font-weight: bold; margin-left: 5px; } /* id名変更 */
        .settings-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="settings-screen">
        <h1>設定</h1>
        <p>表示するGoogleカレンダーを設定してください。</p> <div class="account-status-display" id="accountStatusDisplay">Googleアカウントが選択されていません</div> <span id="displayedAccountEmail" class="hidden"></span> 
        
        <button id="selectGoogleAccountButton">Googleアカウントを選択・変更</button> <button id="clearAccountSettingsButton" class="hidden">アカウント設定を解除</button> <div class="settings-section" id="calendarSelectionArea" class="hidden"> 
            <h2>利用可能なカレンダー</h2>
            <p>ここに表示されるカレンダーから、メイン画面で表示するカレンダーを選んでください。</p>
            <select id="calendarListSelect" size="10">
                </select>
            <button id="saveSettingsButton">このカレンダーに設定</button>
        </div>
        <button id="backToMainButton">メイン画面に戻る</button>
    </div>

    <script>
        // --- 設定値（共通） ---
        // これらの定数はindex.htmlと一致させる
        const LOCAL_STORAGE_CALENDAR_KEY = 'selectedCalendar'; 
        const LOCAL_STORAGE_ACCOUNT_EMAIL_KEY = 'authenticatedAccountEmail'; 
        const LOCAL_STORAGE_CALENDAR_LIST_KEY = 'calendarList'; 
        const APP_VERSION = '1.0.3'; 

        // --- 画面要素の参照 ---
        const accountStatusDisplayDiv = document.getElementById('accountStatusDisplay'); // id変更
        const displayedAccountEmailSpan = document.getElementById('displayedAccountEmail'); // id変更
        const selectGoogleAccountButton = document.getElementById('selectGoogleAccountButton'); 
        const clearAccountSettingsButton = document.getElementById('clearAccountSettingsButton'); // id変更
        const calendarSelectionArea = document.getElementById('calendarSelectionArea');
        const calendarListSelect = document.getElementById('calendarListSelect');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToMainButton = document.getElementById('backToMainButton');

        let selectedCalendarId = ''; 
        let selectedCalendarName = ''; 

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', initializeSettingsPage);

        function initializeSettingsPage() {
            // localStorageから現在の設定をロード
            const storedCalendar = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_KEY));
            if (storedCalendar && storedCalendar.id && storedCalendar.name) {
                selectedCalendarId = storedCalendar.id;
                selectedCalendarName = storedCalendar.name;
            }

            updateSettingsPageUI(); // 設定画面のUIを更新
        }

        /**
         * 設定画面のUIをlocalStorageの情報に基づいて更新します。
         */
        function updateSettingsPageUI() {
            const storedEmail = localStorage.getItem(LOCAL_STORAGE_ACCOUNT_EMAIL_KEY);
            const storedCalendarList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_LIST_KEY));

            if (storedEmail) {
                accountStatusDisplayDiv.textContent = 'アカウント選択済み';
                accountStatusDisplayDiv.className = 'account-status-display selected';
                displayedAccountEmailSpan.textContent = `(${storedEmail})`;
                displayedAccountEmailSpan.classList.remove('hidden');
                selectGoogleAccountButton.classList.add('hidden');
                clearAccountSettingsButton.classList.remove('hidden');
                calendarSelectionArea.classList.remove('hidden');

                // 保存されているカレンダーリストを表示
                displayCalendarList(storedCalendarList);

            } else {
                accountStatusDisplayDiv.textContent = 'Googleアカウントが選択されていません';
                accountStatusDisplayDiv.className = 'account-status-display not-selected';
                displayedAccountEmailSpan.classList.add('hidden');
                selectGoogleAccountButton.classList.remove('hidden');
                clearAccountSettingsButton.classList.add('hidden');
                calendarSelectionArea.classList.add('hidden');
                calendarListSelect.innerHTML = '<option>Googleアカウントを選択してください。</option>'; // デフォルト表示
            }
        }

        /**
         * localStorageから取得したカレンダーリストをドロップダウンに表示します。
         */
        function displayCalendarList(calendars) {
            calendarListSelect.innerHTML = ''; // 既存のオプションをクリア

            if (calendars && calendars.length > 0) {
                calendars.forEach(calendar => {
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.name; // nameプロパティを使用
                    // 現在設定されているカレンダーがあれば選択状態にする
                    if (calendar.id === selectedCalendarId) {
                        option.selected = true;
                    }
                    calendarListSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = '利用可能なカレンダーが見つかりませんでした。';
                option.disabled = true;
                calendarListSelect.appendChild(option);
            }
        }

        // --- イベントリスナーの設定 ---

        // Googleアカウントを選択・変更ボタン
        selectGoogleAccountButton.addEventListener('click', () => {
            // メイン画面にOAuth認証とカレンダーリスト取得を委譲
            // メイン画面で認証後、設定画面に戻るようにする
            // 認証後に設定画面へ戻ることを示すフラグをlocalStorageにセットするなど工夫が必要だが、
            // 今回はシンプルに、メイン画面の認証が完了すればsettings.htmlへリダイレクト
            alert('Googleアカウントを選択するためにメイン画面に移動します。「アカウント選択：30分予約」ボタンをクリックしてください。');
            window.location.href = 'index.html'; 
        });

        // アカウント設定を解除ボタン
        clearAccountSettingsButton.addEventListener('click', () => {
            localStorage.removeItem(LOCAL_STORAGE_ACCOUNT_EMAIL_KEY);
            localStorage.removeItem(LOCAL_STORAGE_CALENDAR_LIST_KEY);
            localStorage.removeItem(LOCAL_STORAGE_CALENDAR_KEY); // 設定済みカレンダーもクリア
            selectedCalendarId = '';
            selectedCalendarName = '';
            alert('アカウント設定とカレンダー設定が解除されました。');
            updateSettingsPageUI(); // UIを更新
        });

        // カレンダーリストを更新ボタン（この画面では不要になるが、残す場合は動作を考慮）
        // settings.htmlでは直接カレンダーリストを更新できないため、ボタンの動作を考える
        // 例えば、再度メイン画面にリダイレクトして認証を促すなど
        refreshCalendarListButton.addEventListener('click', () => {
            alert('カレンダーリストを更新するには、一度Googleアカウントを選択し直すか、メイン画面で予約操作を行って認証を更新してください。');
            // 必要であれば、window.location.href = 'index.html'; でメイン画面にリダイレクト
        });

        // 設定の保存
        function saveSettings() {
            const selectedOption = calendarListSelect.options[calendarListSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedCalendarId = selectedOption.value;
                selectedCalendarName = selectedOption.textContent;
                localStorage.setItem(LOCAL_STORAGE_CALENDAR_KEY, JSON.stringify({
                    id: selectedCalendarId,
                    name: selectedCalendarName
                }));
                alert(`カレンダー「${selectedCalendarName}」が設定されました。`);
                window.location.href = 'index.html'; 
            } else {
                alert('表示するカレンダーを選択してください。');
            }
        }
        saveSettingsButton.addEventListener('click', saveSettings);
        
        backToMainButton.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
