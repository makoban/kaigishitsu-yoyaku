<!DOCTYPE html>
<html>
<head>
    <title>会議室予約表示アプリ - 設定</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; }
        #settings-screen {
            border: 1px solid #eee;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        button { padding: 8px 15px; cursor: pointer; margin-right: 5px; }
        #calendarListSelect { width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 10px; }
        .hidden { display: none; }
        .auth-status { margin-top: 10px; font-size: 0.9em; color: #555; }
        .auth-status.authenticated { color: green; }
        .auth-status.unauthenticated { color: red; }
        #authenticatedAccountEmail { font-weight: bold; } /* メールアドレスの強調 */
    </style>
</head>
<body>
    <div id="settings-screen">
        <h1>設定</h1>
        <p>Googleアカウントを認証し、表示するカレンダーを選択してください。</p>
        
        <div class="auth-status" id="authStatus">未認証</div>
        <span id="authenticatedAccountEmail" class="hidden"></span> <button id="authGoogleButton">Googleアカウントで認証</button>
        <button id="signOutButton" class="hidden">ログアウト</button>
        
        <div id="calendarSelectionArea" class="hidden">
            <h2>利用可能なカレンダー</h2>
            <select id="calendarListSelect" size="10">
                </select>
            <button id="refreshCalendarListButton">カレンダーリストを更新</button> 
            <button id="saveSettingsButton">このカレンダーに設定</button>
        </div>
        <button id="backToMainButton">メイン画面に戻る</button>
    </div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- 設定値（共通） ---
        const API_KEY = 'AIzaSyDUFH1jbIa66NjzSM8I9Xpicwo6I6H2sB8'; // あなたのAPIキーに置き換えてください
        const CLIENT_ID = '155458326593-redrcpnqa2iqapvg8p1kb3cgegeenvse.apps.googleusercontent.com'; // あなたのOAuth 2.0 クライアントIDに置き換えてください
        const SCOPES = 'https://www.googleapis.com/auth/calendar'; // 書き込み操作とカレンダーリスト取得のため
        const LOCAL_STORAGE_CALENDAR_KEY = 'selectedCalendar'; // localStorageのキー
        const APP_VERSION = '1.0.0'; // アプリのバージョンをここで定義

        // --- 画面要素の参照 ---
        const authStatusDiv = document.getElementById('authStatus');
        const authenticatedAccountEmailSpan = document.getElementById('authenticatedAccountEmail');
        const authGoogleButton = document.getElementById('authGoogleButton');
        const signOutButton = document.getElementById('signOutButton');
        const calendarSelectionArea = document.getElementById('calendarSelectionArea');
        const calendarListSelect = document.getElementById('calendarListSelect');
        const refreshCalendarListButton = document.getElementById('refreshCalendarListButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const backToMainButton = document.getElementById('backToMainButton');

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let pendingAction = null; 

        let selectedCalendarId = ''; 
        let selectedCalendarName = ''; 

        // --- 初期化処理 ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            });
            gapiInited = true;
            console.log("gapi client initialized.");
            checkExistingAuthAndUI(); // 認証状態を確認し、UIを更新
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthCallback,
            });
            gisInited = true;
            console.log("gis client initialized.");
            checkExistingAuthAndUI(); // 認証状態を確認し、UIを更新
        }

        /**
         * 既存の認証状態を確認し、UIを初期化します。
         */
        function checkExistingAuthAndUI() {
            if (gapiInited && gisInited) {
                // localStorageから既存の設定をロード（メイン画面へのリダイレクト判定とは別）
                const storedCalendar = JSON.parse(localStorage.getItem(LOCAL_STORAGE_CALENDAR_KEY));
                if (storedCalendar && storedCalendar.id && storedCalendar.name) {
                    selectedCalendarId = storedCalendar.id;
                    selectedCalendarName = storedCalendar.name;
                }
                updateAuthStatus(); // UIの認証状態を更新
                // ページロード時にカレンダーリストは自動で取得しない（「Googleアカウントで認証」ボタンが押されたときのみ）
            }
        }

        // --- 認証関連 ---

        async function handleAuthCallback(resp) {
            if (resp.error !== undefined) {
                console.error("認証エラー:", resp);
                alert(`認証に失敗しました: ${resp.error}`);
                pendingAction = null;
                updateAuthStatus();
                return;
            }
            console.log("認証成功:", resp);
            
            // 認証成功時にユーザー情報を取得 (IDトークンからメールアドレス)
            const token = gapi.client.getToken();
            if (token && token.id_token) {
                const base64Url = token.id_token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const idTokenData = JSON.parse(jsonPayload);
                authenticatedAccountEmailSpan.textContent = `(${idTokenData.email})`; 
                authenticatedAccountEmailSpan.classList.remove('hidden'); 
            }

            updateAuthStatus(); 

            if (pendingAction) {
                const actionToPerform = pendingAction;
                pendingAction = null;
                await actionToPerform();
            } else {
                // 認証ボタンからの認証の場合、カレンダーリストを自動で取得
                await fetchCalendarList(); 
            }
        }

        function handleAuthClick() {
            pendingAction = fetchCalendarList; // 認証後にカレンダーリスト取得を保留アクションに設定
            tokenClient.requestAccessToken({prompt: ''}); 
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateAuthStatus();
                calendarSelectionArea.classList.add('hidden'); 
                calendarListSelect.innerHTML = ''; 
                localStorage.removeItem(LOCAL_STORAGE_CALENDAR_KEY); 
                selectedCalendarId = '';
                selectedCalendarName = '';
                authenticatedAccountEmailSpan.textContent = ''; 
                authenticatedAccountEmailSpan.classList.add('hidden'); 
                alert("ログアウトしました。保存されたカレンダー設定も削除されました。");
                // ログアウト後は設定画面に留まる
            }
        }

        /**
         * 認証状態に基づいてUIを更新します。
         */
        function updateAuthStatus() {
            if (gapi.client.getToken() === null) {
                authStatusDiv.textContent = '未認証';
                authStatusDiv.className = 'auth-status unauthenticated';
                authGoogleButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');
                calendarSelectionArea.classList.add('hidden'); 
                calendarListSelect.innerHTML = ''; 
                authenticatedAccountEmailSpan.classList.add('hidden'); 
            } else {
                authStatusDiv.textContent = '認証済み';
                authStatusDiv.className = 'auth-status authenticated';
                authGoogleButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');
                calendarSelectionArea.classList.remove('hidden'); 
                // 認証済みであれば、メールアドレスを再表示（既に認証されていれば）
                const token = gapi.client.getToken();
                if (token && token.id_token) {
                    try {
                        const base64Url = token.id_token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        const idTokenData = JSON.parse(jsonPayload);
                        authenticatedAccountEmailSpan.textContent = `(${idTokenData.email})`;
                        authenticatedAccountEmailSpan.classList.remove('hidden');
                    } catch (e) {
                        console.error("IDトークン解析エラー:", e);
                    }
                }
            }
        }

        // --- カレンダーリストの取得と表示 ---

        async function fetchCalendarList() {
            if (gapi.client.getToken() === null) {
                // このルートは通常、handleAuthClick経由で認証後に来るため、ここに到達するべきではない
                alert('カレンダーリストを取得するにはGoogleアカウントで認証してください。');
                return;
            }

            calendarListSelect.innerHTML = '<option>カレンダーを読み込み中...</option>';
            calendarSelectionArea.classList.remove('hidden'); 

            try {
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items;

                calendarListSelect.innerHTML = ''; 

                if (calendars.length > 0) {
                    calendars.forEach(calendar => {
                        if (
                            calendar.id === 'ja.japanese#holiday@group.v.calendar.google.com' || 
                            calendar.id === 'contacts@group.v.calendar.google.com' 
                        ) {
                            console.log("除外されたカレンダー:", calendar.summary, "(ID:", calendar.id, ")");
                            return; 
                        }
                        
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = calendar.summary; 
                        if (calendar.id === selectedCalendarId) {
                            option.selected = true;
                        }
                        calendarListSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'カレンダーが見つかりませんでした。';
                    option.disabled = true;
                    calendarListSelect.appendChild(option);
                }
            } catch (err) {
                console.error('カレンダーリストの取得中にエラーが発生しました:', err);
                alert(`カレンダーリストの取得に失敗しました: ${err.message || JSON.stringify(err)}`);
                calendarListSelect.innerHTML = '<option>カレンダーの取得に失敗しました。</option>';
            }
        }

        // --- 設定の保存 ---

        function saveSettings() {
            const selectedOption = calendarListSelect.options[calendarListSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectedCalendarId = selectedOption.value;
                selectedCalendarName = selectedOption.textContent;
                localStorage.setItem(LOCAL_STORAGE_CALENDAR_KEY, JSON.stringify({
                    id: selectedCalendarId,
                    name: selectedCalendarName
                }));
                alert(`カレンダー「${selectedCalendarName}」が設定されました。`);
                window.location.href = 'index.html'; // メイン画面へリダイレクト
            } else {
                alert('表示するカレンダーを選択してください。');
            }
        }

        // --- イベントリスナーの設定 ---

        // 設定画面のボタン
        authGoogleButton.addEventListener('click', handleAuthClick); 
        signOutButton.addEventListener('click', handleSignoutClick);
        refreshCalendarListButton.addEventListener('click', async () => { // カレンダーリスト更新ボタン
            if (gapi.client.getToken() === null) {
                alert('カレンダーリストを更新するにはGoogleアカウントで認証してください。');
            } else {
                await fetchCalendarList();
            }
        });
        saveSettingsButton.addEventListener('click', saveSettings);
        
        // メイン画面へ戻るボタン
        backToMainButton.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
